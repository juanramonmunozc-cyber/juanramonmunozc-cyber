<!DOCTYPE html>
<html lang="es">
<head> 
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Centro de Atenci√≥n CESPT - Quejas y Reportes</title>
  <link rel="icon" type="image/png" href="Fotos/agua.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


  <style>
    /* ===== ESTILOS GENERALES ===== */
    body {
      font-family: Arial, Helvetica, sans-serif; 
      margin:0; 
      padding:0;     
      background:#f2f2f2; 
    }
    
    /* Fix para evitar desbordamiento horizontal */
    html, body {
      width: 100% !important;
      overflow-x: hidden !important;
    }
    
    h1 { color:#7c002a; margin-top:18px; font-size:40px; text-align:center; font-weight:700; }
    h2 { color:#7c002a; margin-top:6px; font-size:20px; text-align:center; font-weight:500; }

    /* ===== MENU SUPERIOR ===== */
    .menu-superior {
      width: 100%;
      background:#6a0a24;
      padding: 12px 0;
      display: flex;
      justify-content: center;
      gap: 28px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .menu-superior a { 
      color:white; 
      font-size:18px; 
      font-weight:bold; 
      text-decoration:none; 
      cursor:pointer; 
      padding: 8px 16px;
      border-radius: 5px;
      transition: all 0.3s ease;
    }
    .menu-superior a:hover { 
      background: rgba(255,255,255,0.2);
    }
    .menu-superior a.activo {
      background: rgba(255,255,255,0.3);
      box-shadow: 0 0 10px rgba(255,255,255,0.2);
    }

    /* ===== SECCIONES GENERALES ===== */
    .seccion {
      max-width:900px;
      margin:18px auto;
      background:#fff;
      padding:20px;
      border-radius:10px;
      border:2px solid #7c002a;
      font-size:16px;
      position: relative;
    }
    .oculto { display:none; }

    /* ===== BOT√ìN DE ADMINISTRADORES ===== */
    #btnLogin {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: #6a0a24;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      z-index: 1005;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }
    #btnLogin:hover {
      background: #7c002a;
      transform: scale(1.1);
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }

    /* Indicador de sesi√≥n */
    #sesionInfo {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      z-index: 1005;
      font-size: 14px;
      display: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* ===== MAPA ===== */
    .map-box {
      width: 100%;
      padding: 30px 0;
      display:flex;
      justify-content:center;
      margin-top:20px;
      border-radius:8px;
      background: linear-gradient(90deg, #ffffff 40%, #7c002a 100%);
    }
    .map-box > #map {
      width: 90%;
      max-width: 980px;
      height: 550px;
      border-radius:12px;
      border:3px solid #7c002a;
      background: linear-gradient(180deg, #ffffff 0%, #fff 70%, rgba(124,0,42,0.06) 100%);
      box-shadow:0 6px 18px rgba(0,0,0,0.12);
    }

    /* ===== BOT√ìN AGREGAR QUEJA ===== */
    #btnAgregarQueja {
      position:fixed;
      bottom:20px;
      right:20px;
      padding:15px 20px;
      background:#007bff;
      color:#fff;
      border:none;
      border-radius:50px;
      cursor:pointer;
      box-shadow:0 4px 6px rgba(0,0,0,.25);
      font-size:16px;
      z-index:1003
    }
    #btnAgregarQueja:hover { background:#0056b3 }

    /* ===== MODALES ===== */
    #overlay {
      display:none;
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,.6);
      z-index:1002
    }

    #formContainer {
      display:none;
      position:fixed;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      background:#fff;
      padding:20px;
      border-radius:10px;
      width:400px;
      box-shadow:0 6px 18px rgba(0,0,0,.3);
      z-index:1003
    }
    #formContainer h3 { margin-top:0 }
    #formContainer label { font-weight:700; display:block; margin-top:10px }
    #formContainer select, #formContainer textarea, #formContainer input {
      width:100%; padding:8px; margin-top:6px;
      border:1px solid #ccc; border-radius:6px;
      font-size:14px;
    }

    #otroProblemaContainer {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 6px;
      border-left: 4px solid #7c002a;
    }

    #closeForm {
      position:absolute; top:8px; right:12px; cursor:pointer;
      font-weight:700; font-size:20px; color:#333;
    }
    #mapMessage {
      display:none;
      position:fixed;
      top:12px; left:50%;
      transform:translateX(-50%);
      background:#ffc107;
      color:#333;
      padding:10px 18px;
      border-radius:6px;
      z-index:1004;
      font-weight:700;
    }

    /* ===== DETALLE REPORTE ===== */
    #detail {
      display:none;
      max-width:900px;
      margin:20px auto;
      background:#fff;
      padding:24px;
      border-radius:10px;
      border:2px solid #7c002a;
    }

    /* ===== SISTEMA DE BADGES DE PRIORIDAD ===== */
    .badge-prioridad-alta { 
        background: #dc3545; 
        color: white; 
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    .badge-prioridad-media { 
        background: #ffc107; 
        color: black; 
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    .badge-prioridad-baja { 
        background: #28a745; 
        color: white; 
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    /* Badge de urgencia */
    .badge-urgencia { 
        animation: pulse 2s infinite; 
        background: #ff4136; 
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    /* Estilos adicionales para la vista de detalle */
    .estado-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      text-transform: capitalize;
    }
    .estado-pendiente {
      background: #fff3cd;
      color: #856404;
    }
    .estado-aprobado {
      background: #d1ecf1;
      color: #0c5460;
    }
    .estado-resuelto {
      background: #d4edda;
      color: #155724;
    }
    .detail-field {
      margin-bottom: 10px;
    }
    .thumb:hover {
      border-color: #7c002a;
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Estilos para las miniaturas de fotos */
    .thumb {
      width: 120px;
      height: 120px;
      object-fit: cover;
      margin: 8px;
      cursor: pointer;
      border: 2px solid #ddd;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    /* Modal para ver foto en grande */
    #modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    #modalImg {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    #closeModal {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 40px;
      cursor: pointer;
      background: none;
      border: none;
      z-index: 10001;
    }
    #closeModal:hover {
      color: #ff6b6b;
    }

    /* Estilos para tarjetas de reportes */
    .reporte-card {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      background: #fafafa;
      transition: all 0.3s ease;
    }
    .reporte-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    .reporte-card h3 {
      margin: 0 0 5px 0;
      color: #7c002a;
    }
    .reporte-card .fecha {
      color: #666;
      font-size: 14px;
    }
    .reporte-card .descripcion {
      margin-top: 10px;
      color: #333;
    }
    .reporte-card .estado {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-top: 8px;
    }
    
    .estado-pendiente { background: #fff3cd; color: #856404; }
    .estado-aprobado { background: #d1ecf1; color: #0c5460; }
    .estado-resuelto { background: #d4edda; color: #155724; }

    /* ===== ESTILOS PARA BUSCADORES ===== */
    #buscadorActualizaciones, #buscadorReportes, #filtroEstado {
      transition: all 0.3s ease;
      border: 2px solid #7c002a;
    }
    #buscadorActualizaciones:focus, #buscadorReportes:focus, #filtroEstado:focus {
      outline: none;
      border-color: #ff6b9d;
      box-shadow: 0 0 0 3px rgba(124, 0, 42, 0.1);
    }

    /* CONTADOR DE RESULTADOS */
    .contador-resultados {
      margin-bottom: 15px;
      color: #666;
      font-style: italic;
      text-align: right;
      font-size: 14px;
    }

    /* MENSAJE SIN RESULTADOS */
    .sin-resultados {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
      background: #f9f9f9;
      border-radius: 8px;
      border: 2px dashed #ddd;
    }

    /* ===== ESTILOS PARA ACTUALIZACIONES DE REPORTES ===== */
    .actualizacion-item {
      border: 1px solid #e0e0e0;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      background: #fafafa;
      transition: all 0.3s ease;
    }
    .actualizacion-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .actualizacion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .actualizacion-titulo {
      font-weight: bold;
      color: #7c002a;
      font-size: 16px;
      margin: 0;
    }
    .actualizacion-fecha {
      color: #666;
      font-size: 12px;
    }
    .actualizacion-descripcion {
      color: #333;
      margin-bottom: 8px;
    }
    .actualizacion-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #666;
    }
    .badge-estado {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    .ultima-actualizacion {
      border-left: 4px solid #28a745;
      background: #f8fff8 !important;
    }

    /* Bot√≥n para agregar actualizaci√≥n */
    .btn-agregar-actualizacion {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
    }
    .btn-agregar-actualizacion:hover {
      background: #218838;
    }

    /* ===== SECCI√ìN MISI√ìN Y VISI√ìN ===== */
    .mision-vision {
      margin-top:25px;
      display:flex;
      align-items:flex-start;
      gap:30px;
    }
    .logo {
      text-align:center;
      width:200px;
    }
    .logo img {
      width:130px;
    }
    .tabs-container {
      flex:1;
    }
    .tabs {
      display:flex;
      margin-bottom:15px;
      border-bottom:2px solid #ddd;
    }
    .tab {
      flex:1;
      text-align:center;
      padding:10px;
      cursor:pointer;
      font-weight:bold;
      border-radius:8px 8px 0 0;
    }
    .tab.active {
      background:#6a0a24;
      color:white;
    }
    .tab-content {
      display:none;
      line-height:1.6;
      color:#333;
    }
    .tab-content.active {
      display:block;
    }

    /* Bot√≥n cerrar secciones */
    .cerrar-seccion {
      position:absolute;
      top:10px;
      right:15px;
      cursor:pointer;
      font-size:22px;
      font-weight:bold;
      color:#7c002a;
    }

    /* ===== MODAL DE CONFIRMACI√ìN PARA ELIMINAR ACTUALIZACIONES ===== */
.modal-confirmacion {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10010;
}

.modal-confirmacion-contenido {
    background: white;
    padding: 0;
    border-radius: 12px;
    max-width: 450px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: modalEntrada 0.3s ease;
}

@keyframes modalEntrada {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.modal-confirmacion-header {
    background: #dc3545;
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
    text-align: center;
}

.modal-confirmacion-icono {
    font-size: 48px;
    margin-bottom: 10px;
}

.modal-confirmacion-body {
    padding: 25px;
}

.modal-confirmacion-descripcion {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border-left: 4px solid #dc3545;
}

.modal-confirmacion-advertencia {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 12px 15px;
    margin: 20px 0;
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

.modal-confirmacion-footer {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}

.btn-modal-cancelar {
    padding: 10px 20px;
    border: 1px solid #6c757d;
    background: white;
    color: #6c757d;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-modal-eliminar {
    padding: 10px 20px;
    border: none;
    background: #dc3545;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-modal-cancelar:hover {
    background: #f8f9fa;
    border-color: #495057;
}

.btn-modal-eliminar:hover {
    background: #c82333;
    transform: translateY(-1px);
}

/* Botones de eliminar en las actualizaciones */
.btn-eliminar-actualizacion {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: all 0.3s ease;
    position: absolute;
    top: 8px;
    right: 8px;
}

.btn-eliminar-actualizacion:hover {
    background: #c82333;
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
}

.actualizacion-contenedor {
    position: relative;
    padding-right: 80px;
}

/* Animaciones para mensajes */
@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

    /* ===== MEDIA QUERIES (RESPONSIVE) ===== */
    @media (max-width:700px){
      h1 { font-size:30px; }
      h2 { font-size:16px; }
      .map-box > #map { width:94%; height:500px; }
      .menu-superior { gap:14px; padding:10px 0; }
      .menu-superior a { font-size:15px; padding: 6px 12px; }
      .thumb {
        width: 100px;
        height: 100px;
        margin: 5px;
      }
      /* BUSCADORES RESPONSIVE */
      #buscadorActualizaciones, #buscadorReportes, #filtroEstado {
        font-size: 14px;
        padding: 10px;
      }
      .actualizacion-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .actualizacion-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }
      #btnLogin, #sesionInfo {
        top: 10px;
        right: 10px;
        font-size: 12px;
      }
      #btnLogin {
        width: 50px;
        height: 50px;
        font-size: 20px;
      }
      #formContainer {
        width: 90%;
        max-width: 350px;
      }
      .mision-vision {
        flex-direction: column;
        gap: 15px;
      }
      .logo {
        width: 100%;
      }
      #detailContent {
        padding: 15px;
      }
    }

    /* ===== FOOTER ===== */
    .footer-gob {
      background: #3d3c3c;
      color: white;
      padding: 40px 20px 0;
      font-family: 'Arial', sans-serif;
      width: 100%;
    }
    .footer-container {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 40px;
      max-width: 1400px;
      margin: auto;
      padding-bottom: 30px;
      width: 100%;
    }
    .footer-col {
      min-width: 180px;
      flex: 1;
    }
    .footer-col h3 {
      color: #d6c28a;
      margin-bottom: 10px;
      font-size: 17px;
    }
    .footer-col ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .footer-col li {
      margin-bottom: 8px;
      font-size: 14px;
    }

    /* Logo */
    .logo-col {
      text-align: center;
      flex: 1.2;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .logo-col h2 {
      margin: 10px 0 0;
      font-size: 26px;
      line-height: 22px;
    }
    .logo-col .escudo {
      width: 170px;
      height: 170px;
      background-image: url("https://i.postimg.cc/0NMGTZk5/yaestodajejej.png"); 
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      margin-bottom: 10px;
    }

    /* Clima */
    .clima-col .clima-box {
      border: 1px solid #ffffff30;
      padding: 12px;
      border-radius: 8px;
      background: #ffffff10;
      width: 220px;
    }
    .clima-top {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .clima-icon-img {
      width: 56px;
      height: 56px;
      display: block;
    }
    .clima-details {
      display: block;
      margin-top: 8px;
      font-size: 13px;
      color: #fff;
      opacity: 0.95;
    }
    .clima-details span {
      display: block;
      margin: 4px 0;
    }
    .prevision {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      overflow-x: auto;
    }
    .prevision .dia {
      min-width: 46px;
      text-align: center;
      font-size: 12px;
      color: #fff;
      background: #ffffff15;
      padding: 6px;
      border-radius: 6px;
    }
    .prevision .dia .dtemp {
      font-weight: 700;
      display: block;
      margin-top: 6px;
    }

    /* Copy */
    .footer-copy {
      width: 100vw !important;
      margin: 0 !important;
      padding: 12px;
      background: #7c002a;
      text-align: center;
      color: white;
      font-size: 14px;
      position: relative;
      left: 50%;
      right: 50%;
      transform: translateX(-50%);
    }
    /* Estilos para el sistema de actualizaciones minimizadas */
.actualizaciones-anteriores {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 15px;
  margin-top: 10px;
}

.btn-ver-mas-actualizaciones {
  transition: all 0.3s ease;
}

.btn-ver-mas-actualizaciones:hover {
  background: #5a001f !important;
  transform: translateY(-1px);
}

.actualizacion-contenedor {
  position: relative;
  padding-right: 80px;
  transition: all 0.3s ease;
}

.btn-eliminar-actualizacion {
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 6px 10px;
  cursor: pointer;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
  transition: all 0.3s ease;
  position: absolute;
  top: 8px;
  right: 8px;
}

.btn-eliminar-actualizacion:hover {
  background: #c82333;
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
}

/* Efectos de animaci√≥n */
.actualizaciones-anteriores {
  transition: all 0.3s ease;
}

/* Estilo para las actualizaciones anteriores */
.actualizaciones-anteriores .actualizacion-contenedor {
  background: white;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 8px;
  border-left: 3px solid #6c757d;
}
/* ==== BOT√ìN PRINCIPAL "AGREGAR QUEJA" ‚Äî DISE√ëO PROFESIONAL ==== */
#btnAgregarQueja {
  position: fixed;
  bottom: 25px;
  right: 25px;
  padding: 16px 26px;
  background: #6a0a24;
  color: white;
  font-weight: bold;
  border: none;
  border-radius: 50px;
  cursor: pointer;
  font-size: 17px;
  letter-spacing: 0.5px;
  box-shadow: 0 6px 14px rgba(0,0,0,0.25);
  transition: all 0.25s ease;
  z-index: 1003;
}

#btnAgregarQueja:hover {
  background: #7c002a;
  transform: scale(1.07);
  box-shadow: 0 8px 18px rgba(0,0,0,0.35);
}

/* ==== FONDO OSCURO DEL MODAL ==== */
#overlay {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(2px);
  z-index: 1002;
}

/* ==== FORMULARIO EMERGENTE PARA NUEVA QUEJA ==== */
#formContainer {
  display: none;
  position: fixed;
  top: 50%; 
  left: 50%;
  transform: translate(-50%, -50%);
  width: 420px;
  background: #ffffff;
  padding: 28px;
  border-radius: 14px;
  box-shadow: 0px 12px 28px rgba(0,0,0,0.25);
  border-top: 6px solid #7c002a;
  z-index: 1004;
  animation: modalFade 0.25s ease;
}

@keyframes modalFade {
  from { opacity: 0; transform: translate(-50%, -60%); }
  to   { opacity: 1; transform: translate(-50%, -50%); }
}

#formContainer h3 {
  margin-top: 0;
  color: #6a0a24;
  text-align: center;
  font-size: 22px;
  font-weight: bold;
}

/* ==== CAMPOS DEL FORM ==== */
#formContainer label {
  display: block;
  margin-top: 14px;
  font-weight: bold;
  color: #333;
}

#formContainer select,
#formContainer textarea,
#formContainer input {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 8px;
  border: 2px solid #ccc;
  background: #fafafa;
  transition: all 0.2s ease;
  font-size: 15px;
}

#formContainer select:focus,
#formContainer textarea:focus,
#formContainer input:focus {
  border-color: #7c002a;
  box-shadow: 0 0 6px rgba(124,0,42,0.25);
  outline: none;
}

/* ==== SECCI√ìN PARA "OTRO PROBLEMA" ==== */
#otroProblemaContainer {
  margin-top: 12px;
  padding: 12px;
  background: #f7f2f4;
  border-left: 4px solid #7c002a;
  border-radius: 8px;
  display: none;
}

/* ==== BOT√ìN ENVIAR ==== */
#formContainer button[type="submit"] {
  margin-top: 18px;
  width: 100%;
  padding: 12px;
  background: #6a0a24;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.25s ease;
}

#formContainer button[type="submit"]:hover {
  background: #7c002a;
  transform: scale(1.03);
}

/* ==== BOT√ìN CERRAR (X) ==== */
#closeForm {
  position: absolute;
  top: 10px;
  right: 14px;
  font-size: 24px;
  cursor: pointer;
  color: #7c002a;
  transition: all 0.2s ease;
}

#closeForm:hover {
  color: #460018;
  transform: scale(1.15);
}

/* ==== MENSAJE "CLICK EN EL MAPA" ==== */
#mapMessage {
  display: none;
  position: fixed;
  top: 14px;
  left: 50%;
  transform: translateX(-50%);
  background: #6a0a24;
  color: white;
  padding: 12px 22px;
  font-size: 15px;
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  z-index: 1004;
  animation: mapMsg 0.3s ease;
}

@keyframes mapMsg {
  from { opacity: 0; transform: translate(-50%, -20px); }
  to { opacity: 1; transform: translate(-50%, 0); }
}

  </style>
</head>

<body>
  <!-- ===== ENCABEZADO ===== -->
  <h1>Centro de atenci√≥n CESPT</h1>
  <h2>Atenci√≥n ciudadana: Quejas, ayudas y reportes</h2>

  <!-- ===== BOTONES DE CONTROL ===== -->
  <button id="btnLogin" title="Acceso Administradores">
    <i class="fas fa-user"></i>
  </button>
  <div id="sesionInfo"></div>

  <!-- ===== MEN√ö DE NAVEGACI√ìN ===== -->
  <nav class="menu-superior">
    <a href="#actualizaciones" id="btnActualizaciones">Actualizaciones</a>
    <a href="#reportes" id="btnReportes">Reportes</a>
    <a href="#ayuda" id="btnAyuda">Ayuda</a>
  </nav>

  <div class="welcome-section">
    <h2 id="welcomeMessage">Bienvenido</h2>
</div>

  <!-- ===== SECCI√ìN ACTUALIZACIONES ===== -->
  <section id="actualizaciones" class="seccion oculto">
    <span class="cerrar-seccion" id="cerrarActualizaciones">&times;</span>
    <h2 style="margin-top:0">Actualizaciones de Reportes</h2>

    <!-- BUSCADOR ACTUALIZACIONES -->
    <div style="margin-bottom: 20px;">
      <input type="text" id="buscadorActualizaciones" placeholder="üîç Buscar en actualizaciones..." 
             style="width: calc(100% - 10px); padding: 12px; border: 2px solid #7c002a; border-radius: 8px; font-size: 16px;">
    </div>

    <div id="contenidoActualizaciones">
      <!-- Las actualizaciones se cargar√°n din√°micamente aqu√≠ -->
    </div>
  </section>

  <!-- ===== SECCI√ìN REPORTES (LISTA) ===== -->
  <section id="reportes" class="seccion oculto">
    <span class="cerrar-seccion" id="cerrarReportes">&times;</span>
    <h2>Reportes atendidos</h2>

    <!-- BUSCADOR REPORTES -->
    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
      <input type="text" id="buscadorReportes" placeholder="üîç Buscar por calle, descripci√≥n o estado..." 
             style="flex: 1; min-width: 250px; padding: 12px; border: 2px solid #7c002a; border-radius: 8px; font-size: 16px;">
      
      <select id="filtroEstado" style="padding: 12px; border: 2px solid #7c002a; border-radius: 8px; font-size: 16px; min-width: 180px;">
        <option value="todos">Todos los estados</option>
        <option value="pendiente">Pendiente</option>
        <option value="aprobado">Aprobado</option>
        <option value="resuelto">Resuelto</option>
      </select>
    </div>

    <div id="listaReportes"></div>
  </section>

  <!-- ===== SECCI√ìN AYUDA ===== -->
  <section id="ayuda" class="seccion oculto">
    <span class="cerrar-seccion" id="cerrarAyuda">&times;</span>
    <h2>Ayuda y contacto</h2>

    <p>Si necesitas asistencia inmediata, puedes comunicarte a:</p>
    <ul>
      <li>Atenci√≥n CESPT: <strong>664-928-4421</strong></li>
      <li>Reportes de agua: <strong>664-701-1129</strong></li>
      <li>Emergencias hidr√°ulicas: <strong>664-884-9033</strong></li>
    </ul>

    <p>Correos electr√≥nicos de contacto:</p>
    <ul>
      <li>soporte@cespt-ayuda.com</li>
      <li>reportes@tij-cespt.org</li>
      <li>asistencia.usuarios@aguatj.net</li>
    </ul>
  </section>

  <!-- ===== MAPA + UI ===== -->
  <div class="map-box">
    <div id="map"></div>
  </div>

  <!-- ===== BOT√ìN AGREGAR QUEJA ===== -->
  <button id="btnAgregarQueja">Agregar Queja</button>
  <div id="overlay"></div>
  <div id="mapMessage">Haz clic en el mapa para colocar tu queja</div>

  <!-- ===== FORMULARIO PARA AGREGAR QUEJA ===== -->
  <div id="formContainer">
    <span id="closeForm">&times;</span>
    <h3>Nuevo Reporte</h3>
    <form id="formQueja">
      <label>Tipo de problema:</label>
      <select id="tipoProblema" required>
        <option value="">-- Selecciona un problema --</option>
        <option value="Fuga de agua">üíß Fuga de agua en tuber√≠a</option>
        <option value="Falta de agua">üö∞ Falta de suministro de agua</option>
        <option value="Agua turbia">üåä Agua turbia </option>
        <option value="Baja presi√≥n">üìâ Baja presi√≥n</option>
        <option value="Drenaje tapado">üöΩ Drenaje tapado </option>
        <option value="Fuga en alcantarilla">üï≥Ô∏è Fuga en alcantarilla</option>
        <option value="Contaminaci√≥n">‚ö†Ô∏è Contaminaci√≥n </option>
        <option value="Medidor da√±ado">üîß Medidor de agua da√±ado</option>
        <option value="Fuga en toma domiciliaria">üè† Fuga en toma domiciliaria</option>
        <option value="Inundaci√≥n">üåßÔ∏è Inundaci√≥n por drenaje</option>
        <option value="otro">‚ùì Otro tipo de problema</option>
      </select>
      
      <!-- Campo para "Otro problema" -->
      <div id="otroProblemaContainer">
        <label>Especifica el problema:</label>
        <input type="text" id="otroProblema" placeholder="Describe el problema espec√≠fico">
      </div>
      
      <label>Descripci√≥n adicional:</label>
      <textarea id="descripcion" rows="3" placeholder="Describe con m√°s detalle el problema (opcional)"></textarea>
      
      <button type="submit">Enviar Reporte</button>
    </form>
  </div>

  <!-- ===== FORMULARIO PARA AGREGAR ACTUALIZACI√ìN ===== -->
  <div id="formActualizacionContainer" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; border-radius:10px; width:360px; box-shadow:0 6px 18px rgba(0,0,0,.3); z-index:1003">
    <span id="closeFormActualizacion" style="position:absolute; top:8px; right:12px; cursor:pointer; font-weight:700; font-size:20px; color:#333;">&times;</span>
    <h3>Agregar Actualizaci√≥n</h3>
    <form id="formActualizacion">
      <input type="hidden" id="reporteIdActualizacion">
      <label>Descripci√≥n del avance:</label>
      <p><textarea id="descripcionActualizacion" rows="4" placeholder="Describe el avance del reporte..." required></textarea></p>
      <label>Estado:</label>
      <select id="estadoActualizacion" required>
        <option value="aprobado">aprobado</option>
        <option value="resuelto">resuelto</option>
      </select>
      <p><label>T√©cnico asignado:</label></p>
      <p><input type="text" id="tecnicoActualizacion" placeholder="Nombre del t√©cnico"><p></p>
      <button type="submit" style="margin-top:15px;">Guardar Actualizaci√≥n</button>
    </form>
  </div>

  <!-- ===== FORMULARIO DE LOGIN ===== -->
  <div id="formLoginContainer" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; border-radius:10px; width:300px; box-shadow:0 6px 18px rgba(0,0,0,.3); z-index:1003">
    <span id="closeFormLogin" style="position:absolute; top:8px; right:12px; cursor:pointer; font-weight:700; font-size:20px; color:#333;">&times;</span>
    <h3>Acceso Administradores</h3>
    <form id="formLogin">
      <label>Usuario:</label>
      <input type="text" id="usuarioLogin" placeholder="Usuario" required>
      <label>Contrase√±a:</label>
      <input type="password" id="passwordLogin" placeholder="Contrase√±a" required>
      <button type="submit" style="margin-top:15px;">Iniciar Sesi√≥n</button>
    </form>
  </div>

  <!-- ===== VISTA DETALLE MEJORADA ===== -->
  <div id="detail">
    <div style="display: flex; align-items: center; margin-bottom: 20px;">
      <a class="back" id="backToMap" href="#" style="display: inline-flex; align-items: center; text-decoration: none; color: #7c002a; font-weight: bold; margin-right: 20px;">
        <i class="fas fa-arrow-left" style="margin-right: 8px;"></i> Volver al mapa
      </a>
      <h1 style="margin: 0; color: #7c002a; text-align: center; flex: 1; padding: 0 20px;">
        Detalle del Reporte
      </h1>
    </div>

    <div id="detailContent" style="background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #ddd;">
      <!-- Informaci√≥n b√°sica del reporte -->
      <div style="margin-bottom: 25px;">
        <h2 id="detailStreet" style="margin-top: 0; color: #333; border-bottom: 2px solid #7c002a; padding-bottom: 10px;">
          Calle ...
          <div id="detailBadges" style="margin-top: 10px;"></div>
        </h2>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
          <div class="detail-field">
            <strong>Estado:</strong> 
            <span id="detailEstado" class="estado-badge estado-pendiente">Cargando...</span>
          </div>
          <div class="detail-field">
            <strong>D√≠as transcurridos:</strong> 
            <span id="detailDias">0 d√≠as</span>
          </div>
          <div class="detail-field">
            <strong>Fecha de reporte:</strong> 
            <span id="detailFecha">--</span>
          </div>
        </div>
        
        <div class="detail-field" style="margin-bottom: 15px;">
          <strong>Descripci√≥n:</strong> 
          <div id="detailDescription" style="background: white; padding: 12px; border-radius: 6px; margin-top: 5px; border-left: 4px solid #7c002a;">
            Cargando descripci√≥n...
          </div>
        </div>
      </div>

      <!-- Galer√≠a de fotos -->
      <div style="margin-bottom: 25px;">
        <h3 style="color: #7c002a; margin-bottom: 15px;">
          <i class="fas fa-camera" style="margin-right: 8px;"></i>Fotos del Reporte
        </h3>
        <div id="detailPhotos" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start;">
          <div style="color:#666; padding: 20px; text-align: center; width: 100%;">
            Cargando fotos...
          </div>
        </div>
      </div>

      <!-- Historial de actualizaciones -->
      <div style="margin-bottom: 25px;">
        <h3 style="color: #7c002a; margin-bottom: 15px;">
          <i class="fas fa-history" style="margin-right: 8px;"></i>Historial de Actualizaciones
        </h3>
        <div id="detailActualizaciones" style="max-height: 300px; overflow-y: auto; padding-right: 10px;">
          <div style="color:#666; padding: 20px; text-align: center;">
            Cargando actualizaciones...
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== MODAL PARA VER FOTOS EN GRANDE ===== -->
  <div id="modal">
    <button id="closeModal">&times;</button>
    <img id="modalImg" src="" alt="Foto del reporte">
  </div>

  <!-- ===== SECCI√ìN MISI√ìN Y VISI√ìN ===== -->
  <div class="seccion mision-vision">
    <!-- Columna izquierda (Logo + T√≠tulo) -->
    <div class="logo">
      <img src="https://i.postimg.cc/MZNxy32H/AGUAA.png" alt="Logo CESPT">
      <h2 style="color:#7c002a; margin-top:10px;">Centro de atenci√≥n</h2>
    </div>

    <!-- Columna derecha (Tabs y contenido) -->
    <div class="tabs-container">
      <!-- Tabs -->
      <div class="tabs">
        <div id="tabMision" class="tab active">Misi√≥n</div>
        <div id="tabVision" class="tab">Visi√≥n</div>
      </div>

      <!-- Contenidos -->
      <div id="mision" class="tab-content active">
        Nuestra misi√≥n es facilitar a los habitantes de Tijuana un sistema √°gil,
        transparente y f√°cil de usar para reportar fugas de agua,
        postes ca√≠dos, fallas en el alumbrado y otras incidencias urbanas.
        Trabajamos para canalizar cada reporte a las dependencias correspondientes,
        monitorear su atenci√≥n y brindar informaci√≥n clara al ciudadano,
        contribuyendo as√≠ a una ciudad m√°s ordenada, funcional y segura.
      </div>

      <div id="vision" class="tab-content">
        Ser la plataforma l√≠der en Tijuana para el reporte y atenci√≥n de incidencias urbanas,
        promoviendo una ciudad m√°s segura,
        eficiente y sustentable mediante tecnolog√≠a accesible y una participaci√≥n ciudadana activa.
        Aspiramos a convertirnos en el puente confiable entre la comunidad y las autoridades,
        impulsando soluciones r√°pidas que mejoren la calidad de vida de todos los tijuanenses.
      </div>
    </div>
  </div>

  <!-- ===== SECCI√ìN RECOMENDACIONES ===== -->
  <section id="recomendaciones" class="seccion"
  style="position:relative; max-width:1000px; margin:40px auto; background:#fff;
  padding:30px; border-radius:10px; border:2px solid #ddd;">

    <!-- T√çTULO  -->
    <div style="display:flex; align-items:center; margin-bottom:25px;">
      <!-- Barra lateral gobiernojejej -->
      <div style="width:12px; height:45px; background:#7c002a; border-radius:3px; margin-right:15px;"></div>

      <h2 style="margin:0; font-size:32px; font-weight:700; color:#333;">
        Recomendaciones en caso de:
      </h2>
    </div>

    <!-- GRID DE TARJETAS -->
    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr)); gap:20px;">

      <!-- 1 -->
      <div style="border:1px solid #ddd; padding:20px; border-radius:10px; background:#fafafa;">
        <h3 style="margin-top:0; color:#7c002a;">Fuga de Agua</h3>
        <p style="margin:0;">
          ‚Ä¢ Cierra la llave de paso principal.<br>
          ‚Ä¢ Evita usar dispositivos el√©ctricos cerca.<br>
          ‚Ä¢ Reporta inmediatamente al √°rea correspondiente.<br>
          ‚Ä¢ Si el agua es turbia o huele mal, no la utilises.
        </p>
      </div>

      <!--  2 -->
      <div style="border:1px solid #ddd; padding:20px; border-radius:10px; background:#fafafa;">
        <h3 style="margin-top:0; color:#7c002a;">Poste Ca√≠do</h3>
        <p style="margin:0;">
          ‚Ä¢ No te acerques ni toques cables sueltos.<br>
          ‚Ä¢ Mant√©n alejadas a otras personas.<br>
          ‚Ä¢ Reporta de inmediato a emergencias o a la compa√±√≠a de energ√≠a.<br>
          ‚Ä¢ No intentes mover el poste.
        </p>
      </div>

      <!-- 3 -->
      <div style="border:1px solid #ddd; padding:20px; border-radius:10px; background:#fafafa;">
        <h3 style="margin-top:0; color:#7c002a;">Fallas de Luz</h3>
        <p style="margin:0;">
          ‚Ä¢ Verifica si solo tu casa est√° afectada.<br>
          ‚Ä¢ No manipules el medidor.<br>
          ‚Ä¢ Desconecta aparatos sensibles.<br>
          ‚Ä¢ Reporta el fallo si persiste.
        </p>
      </div>

      <!-- 4 -->
      <div style="border:1px solid #ddd; padding:20px; border-radius:10px; background:#fafafa;">
        <h3 style="margin-top:0; color:#7c002a;">Olor a Gas</h3>
        <p style="margin:0;">
          ‚Ä¢ No prendas luces ni aparatos el√©ctricos.<br>
          ‚Ä¢ Ventila abriendo puertas y ventanas.<br>
          ‚Ä¢ Cierra la llave del tanque si es seguro hacerlo.<br>
          ‚Ä¢ Desaloja si el olor es fuerte y reporta.
        </p>
      </div>

      <!--  5  -->
      <div style="border:1px solid #ddd; padding:20px; border-radius:10px; background:#fafafa;">
        <h3 style="margin-top:0; color:#7c002a;">Alcantarilla Tapada</h3>
        <p style="margin:0;">
          ‚Ä¢ Evita destapar por tu cuenta.<br>
          ‚Ä¢ No arrojes objetos o basura.<br>
          ‚Ä¢ Reporta de inmediato para evitar inundaciones.<br>
          ‚Ä¢ Mant√©n a ni√±os alejados del √°rea.
        </p>
      </div>

      <!--  6  -->
      <div style="border:1px solid #ddd; padding:20px; border-radius:10px; background:#fafafa;">
        <h3 style="margin-top:0; color:#7c002a;">Incendio Cercano</h3>
        <p style="margin:0;">
          ‚Ä¢ Mant√©n la calma y evacua la zona.<br>
          ‚Ä¢ No intentes apagarlo si es grande.<br>
          ‚Ä¢ Llama inmediatamente al 911.<br>
          ‚Ä¢ Evita inhalar humo o acercarte.
        </p>
      </div>
    </div>
  </section>

  <!-- ===== FOOTER ===== -->
  <footer class="footer-gob">
    <div class="footer-container">

      <!-- Columna 1: Logo + gobierno -->
      <div class="footer-col logo-col">
        <div class="escudo"></div>
        <h2>BAJA<br>CALIFORNIA</h2>
        <p>Atenci√≥n ciudadana</p>
      </div>

      <!-- Columna 2: Servicios -->
      <div class="footer-col">
        <h3>CONTACTO</h3>
        <ul>
          <li>Mu√±oz Chavez Juan Ram√≥n</li>
          <li>Departamento de sistemas computacionales.</li>
        </ul>
      </div>

      <!-- Columna 3: Ligas -->
      <div class="footer-col">
        <h3>CONTACTO</h3>
        <ul>
          <li>Cazares Manzo Nicole Alexandra.</li>
          <li>Departamento de sistemas computacionales.</li>
        </ul>
      </div>

      <!-- Columna 4: Contacto -->
      <div class="footer-col">
        <h3>CONTACTO</h3>
        <ul>
          <li>25213438</li>
          <li>25213719</li>
        </ul>
      </div>

     <div class="clima-col">
      <h3>CLIMA EN TIJUANA</h3>

      <div class="clima-box">
        <div class="clima-top">
          <div class="clima-icon"><img class="clima-icon-img" alt="icono clima" /></div>
          <div>
            <p class="temp">--¬∞C</p>
            <p class="estado">Cargando...</p>
            <p class="hora">Actualizando...</p>
          </div>
        </div>

        <div class="clima-details">
          <span class="feels">Sensaci√≥n: --¬∞C</span>
          <span class="hum">Humedad: --%</span>
          <span class="wind">Viento: -- m/s</span>
          <span class="minmax">Min: --¬∞C ‚Ä¢ Max: --¬∞C</span>
        </div>

        <div class="prevision">
          <!-- Aqu√≠ ir√° el pron√≥stico de 5 d√≠as -->
        </div>
      </div>
    </div>
    </div>

    <div class="footer-copy">
      ¬© 2025 - Proyecto InnovaTec | Aviso de Privacidad
    </div>
  </footer>

  <!-- ===== SCRIPTS ===== -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-database-compat.js"></script>

  <script>
    /* ===== CONFIGURACI√ìN FIREBASE ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyBKBEacMSzpEjh2Pd2zX-ij6EsDMxcb84M",
      authDomain: "mapa-de-quejas-e5354.firebaseapp.com",
      databaseURL: "https://mapa-de-quejas-e5354-default-rtdb.firebaseio.com",
      projectId: "mapa-de-quejas-e5354",
      storageBucket: "mapa-de-quejas-e5354.appspot.com",
      messagingSenderId: "1098104212670",
      appId: "1:1098104212670:web:fa91e20fb729dcd8be22ef",
      measurementId: "G-XJ015E8YWX"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ===== SISTEMA DE AUTENTICACI√ìN ===== */
    let usuarioAutenticado = false;
let mapa = null;
let marcadores = {};

const usuariosAutorizados = {
  "Ramon": "trebol",
  "Nicole": "jeje", 
  "tecnico2": "tecnico456"
};

/* ===== VARIABLES GLOBALES ===== */
let seccionActual = null;

    /* ===== FUNCIONES HELPER (REUTILIZABLES) ===== */

    /**
     * FUNCI√ìN: escapeHtml
     * PROP√ìSITO: Prevenir ataques XSS escapando caracteres HTML
     * ENTRADA: String con posible HTML
     * SALIDA: String seguro para mostrar en HTML
     */
    function escapeHtml(str){
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }

    /**
     * FUNCI√ìN: roundCoord
     * PROP√ìSITO: Redondear coordenadas para agrupar marcadores cercanos
     * ENTRADA: N√∫mero de coordenada
     * SALIDA: Coordenada redondeada a 3 decimales
     */
    function roundCoord(num){ return Math.round(Number(num) * 1000) / 1000; }

    /**
     * FUNCI√ìN: createIcon
     * PROP√ìSITO: Crear iconos de marcador con diferentes colores
     * ENTRADA: Color del marcador
     * SALIDA: Objeto icono de Leaflet
     */
   function createIcon(color, prioridad = 1) {
  // Asegurarnos de que prioridad sea un n√∫mero
  const prioNum = parseInt(prioridad);
  
  const textoPrioridad = {
    1: 'BAJA',
    2: 'MEDIA',
    3: 'ALTA'
  };
  
  const colorMap = {
    'blue': '#007bff',
    'orange': '#ff9800', 
    'red': '#dc3545',
    'green': '#28a745',
    'grey': '#6c757d'
  };
  
  const iconColor = colorMap[color] || '#007bff';
  const texto = textoPrioridad[prioNum] || 'BAJA';
  
  // Debug: mostrar en consola qu√© prioridad se est√° recibiendo
  console.log(`Creando icono - Color: ${color}, Prioridad: ${prioNum}, Texto: ${texto}`);
  
  // Colores para el bander√≠n de prioridad
  const colorBanderin = prioNum === 3 ? '#dc3545' : 
                       prioNum === 2 ? '#ffc107' : '#28a745';
  
  const iconHtml = `
    <div style="
      position: relative;
      background-color: ${iconColor};
      width: 30px;
      height: 30px;
      border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
      border: 2px solid white;
    ">
      <i class="fas fa-tint" style="
        color: white;
        font-size: 14px;
        transform: rotate(45deg);
      "></i>
      
      <!-- Bander√≠n de prioridad -->
      <div style="
        position: absolute;
        top: -12px;
        right: -15px;
        background: ${colorBanderin};
        color: white;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 8px;
        font-weight: bold;
        white-space: nowrap;
        box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        border: 1px solid white;
        transform: rotate(45deg);
      ">
        ${texto}
      </div>
    </div>
  `;
  
  return L.divIcon({
    html: iconHtml,
    iconSize: [45, 45],
    iconAnchor: [15, 40],
    popupAnchor: [0, -40],
    className: 'priority-flag-marker'
  });
}
    /**
     * FUNCI√ìN: getMarkerColor
     * PROP√ìSITO: Determinar color seg√∫n cantidad de reportes en ubicaci√≥n
     * ENTRADA: Cantidad de reportes
     * SALIDA: Color del marcador
     */
    function getMarkerColor(count) {
      if (count >= 5) return 'red';
      if (count >= 3) return 'orange';
      return 'blue';
    }

    /**
     * FUNCI√ìN: calcularDiasUTC
     * PROP√ìSITO: Calcular d√≠as transcurridos desde creaci√≥n del reporte
     * ENTRADA: Timestamp de creaci√≥n
     * SALIDA: N√∫mero de d√≠as transcurridos
     */
    function calcularDiasUTC(fechaCreacionMs) {
      const fechaCreacion = new Date(fechaCreacionMs);
      const hoy = new Date();

      const fechaCreacionUTC = Date.UTC(fechaCreacion.getUTCFullYear(), fechaCreacion.getUTCMonth(), fechaCreacion.getUTCDate());
      const hoyUTC = Date.UTC(hoy.getUTCFullYear(), hoy.getUTCMonth(), hoy.getUTCDate());

      const diffMs = hoyUTC - fechaCreacionUTC;
      const dias = Math.round(diffMs / (1000 * 60 * 60 * 24));
      return dias;
    }

  /**
 * FUNCI√ìN: determinarColorYParpadeo
 * PROP√ìSITO: Determinar apariencia del marcador basado en urgencia
 * ENTRADA: D√≠as transcurridos, cantidad de reportes y prioridad
 * SALIDA: Objeto con color, si debe parpadear y prioridad
 */
function determinarColorYParpadeo(dias, count, prioridad) {
  let color = 'blue';
  let parpadeo = false;
  let esUrgente = false;
  
  // Sistema de d√≠as SOLO afecta el color y parpadeo, NO la prioridad
  if (dias >= 14) {
    color = 'red';
    parpadeo = true;
    esUrgente = true;
  } else if (dias >= 7) {
    color = 'orange';
  } else {
    // Si no cumple d√≠as, usar sistema de agrupamiento
    color = getMarkerColor(count);
  }
  
  console.log(`Visual: dias=${dias}, color=${color}, parpadeo=${parpadeo}, prioridad=${prioridad}`); // Para debug
  return { color, parpadeo, prioridad, esUrgente };
}
    /* ===== SISTEMA DE PRIORIDADES ===== */
/**
 * FUNCI√ìN: calcularPrioridad - CORREGIDA DEFINITIVAMENTE
 * PROP√ìSITO: Calcular nivel de prioridad del reporte (1-3) basado EXCLUSIVAMENTE en el tipo de problema
 * ENTRADA: Datos del reporte
 * SALIDA: N√∫mero de prioridad (1=baja, 2=media, 3=alta)
 */
function calcularPrioridad(reporte) {
  const tipo = reporte.description || '';
  
  // Prioridad por tipo de problema - EXCLUSIVAMENTE
  const prioridadesPorTipo = {
    'Fuga de agua': 3,
    'Inundaci√≥n': 3,
    'Contaminaci√≥n': 3,
    'Falta de agua': 2,
    'Agua turbia': 2,
    'Baja presi√≥n': 2,
    'Drenaje tapado': 2,
    'Fuga en alcantarilla': 3,
    'Medidor da√±ado': 1,
    'Fuga en toma domiciliaria': 2,
    'otro': 1
  };
  
  let prioridad = 1; // Por defecto baja
  
  // Buscar coincidencia EXACTA en el tipo de problema
  let tipoEncontrado = false;
  for (const [key, value] of Object.entries(prioridadesPorTipo)) {
    if (tipo.toLowerCase().includes(key.toLowerCase())) {
      prioridad = value;
      tipoEncontrado = true;
      break;
    }
  }
  
  // Si no se encontr√≥ tipo espec√≠fico, usar l√≥gica por defecto
  if (!tipoEncontrado) {
    if (tipo.toLowerCase().includes('fuga') || tipo.toLowerCase().includes('inundaci√≥n') || tipo.toLowerCase().includes('contaminaci√≥n')) {
      prioridad = 3;
    } else if (tipo.toLowerCase().includes('falta') || tipo.toLowerCase().includes('turbia') || tipo.toLowerCase().includes('drenaje') || tipo.toLowerCase().includes('presi√≥n')) {
      prioridad = 2;
    } else {
      prioridad = 1;
    }
  }
  
  // ¬°ELIMINADO COMPLETAMENTE EL AUMENTO POR D√çAS!
  // La prioridad ahora es FIJA basada solo en el tipo de problema
  
  console.log(`Prioridad calculada para "${tipo}": ${prioridad}`); // Para debug
  return prioridad;
}

    /**
 * FUNCI√ìN: obtenerBadgePrioridad
 * PROP√ìSITO: Generar HTML del badge de prioridad
 * ENTRADA: Nivel de prioridad
 * SALIDA: HTML del badge
 */
function obtenerBadgePrioridad(prioridad) {
  // Asegurarnos de que la prioridad sea un n√∫mero
  const prioNum = parseInt(prioridad);
  
  switch(prioNum) {
    case 3:
      return '<span class="badge-prioridad-alta"><i class="fas fa-exclamation-triangle"></i> ALTA</span>';
    case 2:
      return '<span class="badge-prioridad-media"><i class="fas fa-exclamation-circle"></i> MEDIA</span>';
    case 1:
    default:
      return '<span class="badge-prioridad-baja"><i class="fas fa-info-circle"></i> BAJA</span>';
  }
}

    /**
     * FUNCI√ìN: obtenerBadgeUrgencia
     * PROP√ìSITO: Generar badge de urgencia para reportes muy antiguos
     * ENTRADA: D√≠as transcurridos
     * SALIDA: HTML del badge de urgencia o string vac√≠o
     */
    function obtenerBadgeUrgencia(dias) {
      if (dias >= 14) {
        return '<span class="badge-urgencia"><i class="fas fa-bell"></i> URGENTE</span>';
      }
      return '';
    }

    /**
     * FUNCI√ìN: mostrarImagen
     * PROP√ìSITO: Mostrar foto en modal a pantalla completa
     * ENTRADA: URL de la imagen
     * SALIDA: Ninguna (efecto visual)
     */
    function mostrarImagen(src) {
      document.getElementById("modalImg").src = src;
      document.getElementById("modal").style.display = "flex";
    }

    /* ===== FUNCIONALIDAD PARA "OTRO PROBLEMA" ===== */

    /**
     * FUNCI√ìN: inicializarCampoOtroProblema
     * PROP√ìSITO: Mostrar/ocultar campo para problemas personalizados
     * ENTRADA: Ninguna
     * SALIDA: Ninguna (configura event listeners)
     */
    function inicializarCampoOtroProblema() {
      const tipoProblemaSelect = document.getElementById('tipoProblema');
      const otroProblemaContainer = document.getElementById('otroProblemaContainer');
      const otroProblemaInput = document.getElementById('otroProblema');
      
      tipoProblemaSelect.addEventListener('change', function() {
        if (this.value === 'otro') {
          otroProblemaContainer.style.display = 'block';
          otroProblemaInput.required = true;
        } else {
          otroProblemaContainer.style.display = 'none';
          otroProblemaInput.required = false;
          otroProblemaInput.value = '';
        }
      });
    }

    /* ===== SISTEMA DE AUTENTICACI√ìN ===== */

    /**
     * FUNCI√ìN: iniciarSesion
     * PROP√ìSITO: Validar credenciales de usuario
     * ENTRADA: Usuario y contrase√±a
     * SALIDA: Booleano indicando si login fue exitoso
     */

    function iniciarSesion(usuario, password) {
  if (usuariosAutorizados[usuario] && usuariosAutorizados[usuario] === password) {
    usuarioAutenticado = true;
    localStorage.setItem('cespt_usuario', usuario);
    actualizarInterfazAutenticacion();
    cerrarFormularioLogin();
    return true;
  }
  return false;
}

/**
 * FUNCI√ìN: cerrarSesion
 * PROP√ìSITO: Cerrar sesi√≥n del usuario actual
 * ENTRADA: Ninguna
 * SALIDA: Ninguna
 */
function cerrarSesion() {
  usuarioAutenticado = false;
  localStorage.removeItem('cespt_usuario');
  actualizarInterfazAutenticacion();
}

/**
 * FUNCI√ìN: verificarSesionGuardada
 * PROP√ìSITO: Verificar si hay sesi√≥n guardada en localStorage
 * ENTRADA: Ninguna
 * SALIDA: Ninguna
 */
function verificarSesionGuardada() {
  const usuarioGuardado = localStorage.getItem('cespt_usuario');
  if (usuariosAutorizados[usuarioGuardado]) {
    usuarioAutenticado = true;
    actualizarInterfazAutenticacion();
  }
}

/**
 * FUNCI√ìN: actualizarInterfazAutenticacion
 * PROP√ìSITO: Actualizar UI seg√∫n estado de autenticaci√≥n
 * ENTRADA: Ninguna
 * SALIDA: Ninguna
 */
function actualizarInterfazAutenticacion() {
  const btnLogin = document.getElementById('btnLogin');
  const sesionInfo = document.getElementById('sesionInfo');
  
  if (usuarioAutenticado) {
    const usuario = localStorage.getItem('cespt_usuario');
    btnLogin.style.display = 'none';
    sesionInfo.style.display = 'block';
    sesionInfo.innerHTML = `Conectado como: ${usuario} <button onclick="cerrarSesion()" style="margin-left:10px; background:#dc3545; color:white; border:none; border-radius:3px; padding:2px 6px; cursor:pointer;">Cerrar</button>`;
    
    // Mostrar botones de actualizaci√≥n
    document.querySelectorAll('.btn-agregar-actualizacion').forEach(btn => {
      btn.style.display = 'inline-block';
    });
    
    // Actualizar popups del mapa
    actualizarPopupsMapa();
  } else {
    btnLogin.style.display = 'block';
    sesionInfo.style.display = 'none';
    
    // Ocultar botones de actualizaci√≥n
    document.querySelectorAll('.btn-agregar-actualizacion').forEach(btn => {
      btn.style.display = 'none';
    });
    
    // Actualizar popups del mapa
    actualizarPopupsMapa();
  }
}

/**
 * FUNCI√ìN: actualizarPopupsMapa
 * PROP√ìSITO: Actualizar contenido de popups seg√∫n autenticaci√≥n
 * ENTRADA: Ninguna
 * SALIDA: Ninguna
 */
function actualizarPopupsMapa() {
  if (!mapa) return;
  
  Object.keys(marcadores).forEach(key => {
    const marker = marcadores[key];
    const popup = marker.getPopup();
    if (popup) {
      let content = popup.getContent();
      
      // Buscar y reemplazar el bot√≥n de actualizaci√≥n
      const botonActualizacionRegex = /<button class="btn-agregar-actualizacion"[^>]*>.*?<\/button>/gi;
      
      if (usuarioAutenticado) {
        // Si el usuario est√° autenticado, agregar/actualizar el bot√≥n
        if (content.includes('btn-agregar-actualizacion')) {
          // Reemplazar el bot√≥n existente
          content = content.replace(botonActualizacionRegex, 
            `<button class="btn-agregar-actualizacion" onclick="abrirFormularioActualizacion('${key}')">Agregar Actualizaci√≥n</button>`);
        } else {
          // Agregar el bot√≥n si no existe
          const verMasIndex = content.indexOf('</a></div>');
          if (verMasIndex !== -1) {
            const before = content.substring(0, verMasIndex + 10);
            const after = content.substring(verMasIndex + 10);
            content = before + 
              `<div style="margin-top:8px">
                <button class="btn-agregar-actualizacion" onclick="abrirFormularioActualizacion('${key}')">Agregar Actualizaci√≥n</button>
              </div>` + 
              after;
          }
        }
      } else {
        // Si el usuario NO est√° autenticado, eliminar el bot√≥n
        content = content.replace(botonActualizacionRegex, '');
      }
      
      marker.setPopupContent(content);
    }
  });
}

/**
 * FUNCI√ìN: abrirFormularioLogin
 * PROP√ìSITO: Mostrar formulario de login
 * ENTRADA: Ninguna
 * SALIDA: Ninguna
 */
function abrirFormularioLogin() {
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('formLoginContainer').style.display = 'block';
}

/**
 * FUNCI√ìN: cerrarFormularioLogin
 * PROP√ìSITO: Ocultar formulario de login
 * ENTRADA: Ninguna
 * SALIDA: Ninguna
 */
function cerrarFormularioLogin() {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('formLoginContainer').style.display = 'none';
  document.getElementById('formLogin').reset();
}

    /* ===== SISTEMA DE ACTUALIZACIONES MEJORADO ===== */

    /**
     * FUNCI√ìN: cargarActualizacionesReportes
     * PROP√ìSITO: Cargar y mostrar reportes con actualizaciones
     * ENTRADA: Ninguna
     * SALIDA: Ninguna (actualiza DOM)
     */
    function cargarActualizacionesReportes() {
      const contenedor = document.getElementById('contenidoActualizaciones');
      contenedor.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Cargando actualizaciones...</div>';

      db.ref('reportes').once('value').then(snapshot => {
        const reportesConActualizaciones = [];
        
        snapshot.forEach(child => {
          const data = child.val();
          if (!data) return;
          
          // Solo mostrar reportes que tienen actualizaciones
          if (data.actualizaciones && Object.keys(data.actualizaciones).length > 0) {
            reportesConActualizaciones.push({
              id: child.key,
              data: data
            });
          }
        });

        if (reportesConActualizaciones.length === 0) {
          contenedor.innerHTML = `
            <div class="sin-resultados">
              <div style="font-size: 48px; margin-bottom: 10px;">üìã</div>
              <h3 style="color: #666; margin-bottom: 10px;">No hay actualizaciones disponibles</h3>
              <p>Los reportes aparecer√°n aqu√≠ cuando tengan actualizaciones del equipo t√©cnico</p>
            </div>
          `;
          return;
        }

        // Ordenar reportes por fecha de √∫ltima actualizaci√≥n (m√°s reciente primero)
        reportesConActualizaciones.sort((a, b) => {
          const ultimaActualizacionA = obtenerUltimaActualizacion(a.data.actualizaciones);
          const ultimaActualizacionB = obtenerUltimaActualizacion(b.data.actualizaciones);
          return (ultimaActualizacionB?.fecha || 0) - (ultimaActualizacionA?.fecha || 0);
        });

        mostrarActualizacionesEnLista(reportesConActualizaciones, contenedor);
        
      }).catch(err => {
        console.error('Error cargando actualizaciones:', err);
        contenedor.innerHTML = '<div class="sin-resultados"><p style="color:#666;">Error cargando actualizaciones.</p></div>';
      });
    }

    /**
     * FUNCI√ìN: obtenerUltimaActualizacion
     * PROP√ìSITO: Obtener la actualizaci√≥n m√°s reciente de un reporte
     * ENTRADA: Objeto de actualizaciones
     * SALIDA: Actualizaci√≥n m√°s reciente o null
     */
    function obtenerUltimaActualizacion(actualizaciones) {
      if (!actualizaciones) return null;
      
      const actualizacionesArray = Object.values(actualizaciones);
      if (actualizacionesArray.length === 0) return null;
      
      // Ordenar por fecha (m√°s reciente primero)
      actualizacionesArray.sort((a, b) => b.fecha - a.fecha);
      
      return actualizacionesArray[0];
    }

    /**
 * FUNCI√ìN: mostrarActualizacionesEnLista
 * PROP√ìSITO: Mostrar actualizaciones en formato de lista
 * ENTRADA: Array de reportes con actualizaciones, contenedor DOM
 * SALIDA: Ninguna (actualiza DOM)
 */
/**
 * FUNCI√ìN: mostrarActualizacionesEnLista
 * PROP√ìSITO: Mostrar actualizaciones en formato minimizado/expandible
 * ENTRADA: Array de reportes con actualizaciones, contenedor DOM
 * SALIDA: Ninguna (actualiza DOM)
 */
function mostrarActualizacionesEnLista(reportes, contenedor) {
  let html = '';
  
  reportes.forEach(reporte => {
    const data = reporte.data;
    const actualizacionesArray = Object.entries(data.actualizaciones || {});
    
    // Ordenar actualizaciones por fecha (m√°s reciente primero)
    actualizacionesArray.sort((a, b) => b[1].fecha - a[1].fecha);
    
    const ultimaActualizacion = actualizacionesArray[0]?.[1];
    const totalActualizaciones = actualizacionesArray.length;
    const diasPasados = calcularDiasUTC(data.fechaCreacion);
    const prioridad = calcularPrioridad(data);
    
    // Solo mostrar la √∫ltima actualizaci√≥n inicialmente
    const mostrarTodas = false;
    
    html += `
      <div class="actualizacion-item ${ultimaActualizacion ? 'ultima-actualizacion' : ''}" 
           id="reporte-${reporte.id}">
        <div class="actualizacion-header">
          <div style="display: flex; align-items: center; gap: 10px;">
            <div class="actualizacion-titulo">
              üìç ${escapeHtml(data.street || 'Ubicaci√≥n desconocida')}
            </div>
            ${obtenerBadgePrioridad(prioridad)}
            ${obtenerBadgeUrgencia(diasPasados)}
          </div>
          <div class="actualizacion-fecha">
            ${new Date(ultimaActualizacion.fecha).toLocaleDateString('es-MX')}
          </div>
        </div>
        
        <div class="actualizacion-descripcion">
          <strong>Reporte original:</strong> ${escapeHtml(data.description || 'Sin descripci√≥n')}
        </div>
        
        <!-- √öltima actualizaci√≥n (siempre visible) -->
        ${actualizacionesArray.length > 0 ? `
          <div class="actualizacion-contenedor">
            ${usuarioAutenticado ? `
              <button 
                onclick="mostrarModalEliminacion('${reporte.id}', '${actualizacionesArray[0][0]}', '${escapeHtml(actualizacionesArray[0][1].descripcion || 'Sin descripci√≥n')}')" 
                class="btn-eliminar-actualizacion"
                title="Eliminar esta actualizaci√≥n"
              >
                <i class="fas fa-trash"></i> Eliminar
              </button>
            ` : ''}
            
            <div style="font-weight: bold; color: #7c002a; margin-bottom: 5px;">
              √öltima actualizaci√≥n
            </div>
            <div style="color: #333; margin-bottom: 5px;">
              ${actualizacionesArray[0][1].descripcion || 'Sin descripci√≥n adicional'}
            </div>
            <div class="actualizacion-meta">
              <span>${new Date(actualizacionesArray[0][1].fecha).toLocaleString('es-MX')}</span>
              ${actualizacionesArray[0][1].estado ? `
                <span class="badge-estado estado-${actualizacionesArray[0][1].estado}">
                  ${actualizacionesArray[0][1].estado}
                </span>
              ` : ''}
              ${actualizacionesArray[0][1].tecnico ? `<span>T√©cnico: ${actualizacionesArray[0][1].tecnico}</span>` : ''}
              ${actualizacionesArray[0][1].usuario ? `<span>Por: ${actualizacionesArray[0][1].usuario}</span>` : ''}
            </div>
          </div>
        ` : ''}
        
        <!-- Bot√≥n para mostrar/ocultar todas las actualizaciones -->
${actualizacionesArray.length > 1 ? `
  <div style="margin-top: 10px; text-align: left;">
    <button class="btn-ver-mas-actualizaciones" 
            onclick="toggleTodasActualizaciones('${reporte.id}')"
            data-expandido="false"
            style="
              background: #7c002a;
              color: white;
              border: none;
              padding: 8px 16px;
              border-radius: 5px;
              cursor: pointer;
              font-size: 12px;
              display: inline-flex;
              align-items: center;
              gap: 5px;
            ">
      <i class="fas fa-chevron-down"></i>
      Ver ${actualizacionesArray.length - 1} actualizaci√≥n${actualizacionesArray.length - 1 !== 1 ? 'es' : ''} anteriores
    </button>
  </div>
          
          <!-- Contenedor para las actualizaciones anteriores (oculto inicialmente) -->
          <div id="actualizaciones-anteriores-${reporte.id}" 
               class="actualizaciones-anteriores" 
               style="display: none; margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 15px;">
            ${actualizacionesArray.slice(1).map(([actualizacionId, actualizacion], index) => `
              <div class="actualizacion-contenedor" style="
                margin-bottom: ${index < actualizacionesArray.length - 2 ? '10px' : '0'}; 
                padding: 10px 0;
                ${index > 0 ? 'border-top: 1px dashed #ddd;' : ''}
              ">
                ${usuarioAutenticado ? `
                  <button 
                    onclick="mostrarModalEliminacion('${reporte.id}', '${actualizacionId}', '${escapeHtml(actualizacion.descripcion || 'Sin descripci√≥n')}')" 
                    class="btn-eliminar-actualizacion"
                    title="Eliminar esta actualizaci√≥n"
                  >
                    <i class="fas fa-trash"></i> Eliminar
                  </button>
                ` : ''}
                
                <div style="font-weight: bold; color: #666; margin-bottom: 5px;">
                  Actualizaci√≥n anterior
                </div>
                <div style="color: #333; margin-bottom: 5px;">
                  ${actualizacion.descripcion || 'Sin descripci√≥n adicional'}
                </div>
                <div class="actualizacion-meta">
                  <span>${new Date(actualizacion.fecha).toLocaleString('es-MX')}</span>
                  ${actualizacion.estado ? `
                    <span class="badge-estado estado-${actualizacion.estado}">
                      ${actualizacion.estado}
                    </span>
                  ` : ''}
                  ${actualizacion.tecnico ? `<span>T√©cnico: ${actualizacion.tecnico}</span>` : ''}
                  ${actualizacion.usuario ? `<span>Por: ${actualizacion.usuario}</span>` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        ` : ''}
        
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
          <div class="actualizacion-meta">
            <span>üìä ${totalActualizaciones} actualizacion${totalActualizaciones !== 1 ? 'es' : ''}</span>
            <a href="?id=${reporte.id}" style="color: #0056b3; text-decoration: underline;">
              Ver reporte completo
            </a>
          </div>
        </div>
      </div>
    `;
  });
  
  // Agregar contador
  const contador = document.createElement('div');
  contador.className = 'contador-resultados';
  contador.textContent = `${reportes.length} reportes con actualizaciones`;
  
  contenedor.innerHTML = '';
  contenedor.appendChild(contador);
  contenedor.insertAdjacentHTML('beforeend', html);
}
/**
 * FUNCI√ìN: toggleTodasActualizaciones
 * PROP√ìSITO: Mostrar/ocultar todas las actualizaciones de un reporte
 * ENTRADA: ID del reporte
 * SALIDA: Ninguna
 */
function toggleTodasActualizaciones(reporteId) {
  const contenedor = document.getElementById(`actualizaciones-anteriores-${reporteId}`);
  const boton = document.querySelector(`#reporte-${reporteId} .btn-ver-mas-actualizaciones`);
  const icono = boton.querySelector('i');
  
  if (contenedor.style.display === 'none') {
    // Mostrar todas las actualizaciones
    contenedor.style.display = 'block';
    boton.innerHTML = `<i class="fas fa-chevron-up"></i> Ocultar actualizaciones anteriores`;
    boton.setAttribute('data-expandido', 'true');
    
    // Efecto de animaci√≥n suave
    contenedor.style.opacity = '0';
    contenedor.style.transform = 'translateY(-10px)';
    
    setTimeout(() => {
      contenedor.style.transition = 'all 0.3s ease';
      contenedor.style.opacity = '1';
      contenedor.style.transform = 'translateY(0)';
    }, 10);
  } else {
    // Ocultar actualizaciones
    contenedor.style.transition = 'all 0.3s ease';
    contenedor.style.opacity = '0';
    contenedor.style.transform = 'translateY(-10px)';
    
    setTimeout(() => {
      contenedor.style.display = 'none';
      boton.innerHTML = `<i class="fas fa-chevron-down"></i> Ver ${contenedor.children.length} actualizaci√≥n${contenedor.children.length !== 1 ? 'es' : ''} anteriores`;
      boton.setAttribute('data-expandido', 'false');
    }, 300);
  }
}

    /* ===== SISTEMA PARA AGREGAR ACTUALIZACIONES ===== */

    /**
     * FUNCI√ìN: abrirFormularioActualizacion
     * PROP√ìSITO: Mostrar formulario para agregar actualizaci√≥n
     * ENTRADA: ID del reporte
     * SALIDA: Ninguna
     */
    /* ===== SISTEMA PARA ELIMINAR ACTUALIZACIONES ===== */

// Variables globales para almacenar los IDs temporalmente
let reporteIdActual = '';
let actualizacionIdActual = '';

/**
 * FUNCI√ìN: mostrarModalEliminacion
 * PROP√ìSITO: Mostrar el modal de confirmaci√≥n para eliminar actualizaci√≥n
 */
function mostrarModalEliminacion(reporteId, actualizacionId, descripcion) {
    if (!usuarioAutenticado) {
        alert('Solo el personal autorizado puede eliminar actualizaciones.');
        return;
    }
    
    // Guardar IDs para usar en la confirmaci√≥n
    reporteIdActual = reporteId;
    actualizacionIdActual = actualizacionId;
    
    // Actualizar la descripci√≥n en el modal
    const descripcionElement = document.getElementById('modalDescripcionActualizacion');
    if (descripcionElement) {
        const textoCorto = descripcion.length > 150 ? descripcion.substring(0, 150) + '...' : descripcion;
        descripcionElement.textContent = textoCorto || 'Sin descripci√≥n disponible';
    }
    
    // Mostrar el modal
    const modal = document.getElementById('modalConfirmacionEliminar');
    if (modal) {
        modal.style.display = 'flex';
    }
}

/**
 * FUNCI√ìN: cerrarModalEliminacion
 * PROP√ìSITO: Cerrar el modal de confirmaci√≥n
 */
function cerrarModalEliminacion() {
    const modal = document.getElementById('modalConfirmacionEliminar');
    if (modal) {
        modal.style.display = 'none';
    }
    
    // Limpiar los IDs
    reporteIdActual = '';
    actualizacionIdActual = '';
}

/**
 * FUNCI√ìN: confirmarEliminacionActualizacion
 * PROP√ìSITO: Ejecutar la eliminaci√≥n despu√©s de la confirmaci√≥n
 */
function confirmarEliminacionActualizacion() {
    if (!reporteIdActual || !actualizacionIdActual) {
        console.error('IDs no disponibles para eliminar');
        return;
    }
    
    // Mostrar indicador de carga en el bot√≥n
    const btnEliminar = document.getElementById('btnConfirmarEliminar');
    const textoOriginal = btnEliminar.innerHTML;
    btnEliminar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';
    btnEliminar.disabled = true;
    
    // Referencia a la actualizaci√≥n en Firebase
    const actualizacionRef = db.ref(`reportes/${reporteIdActual}/actualizaciones/${actualizacionIdActual}`);
    
    actualizacionRef.remove()
        .then(() => {
            // √âxito - Mostrar mensaje
            mostrarMensajeExito('Actualizaci√≥n eliminada correctamente');
            
            // Cerrar modal
            cerrarModalEliminacion();
            
            // Recargar la vista actual
            recargarVistaActual();
            
            // Restaurar bot√≥n
            btnEliminar.innerHTML = textoOriginal;
            btnEliminar.disabled = false;
        })
        .catch((error) => {
            // Error - Mostrar mensaje
            console.error('Error al eliminar actualizaci√≥n:', error);
            mostrarMensajeError('Error al eliminar la actualizaci√≥n: ' + error.message);
            
            // Restaurar bot√≥n
            btnEliminar.innerHTML = textoOriginal;
            btnEliminar.disabled = false;
        });
}

/**
 * FUNCI√ìN: mostrarMensajeExito
 * PROP√ìSITO: Mostrar mensaje de √©xito temporal
 */
function mostrarMensajeExito(mensaje) {
    const mensajeElement = document.createElement('div');
    mensajeElement.innerHTML = `
        <div style="
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 10012;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s ease;
        ">
            <i class="fas fa-check-circle" style="font-size: 18px;"></i>
            <span>${mensaje}</span>
        </div>
    `;
    
    document.body.appendChild(mensajeElement);
    
    setTimeout(() => {
        mensajeElement.remove();
    }, 3000);
}

/**
 * FUNCI√ìN: mostrarMensajeError
 * PROP√ìSITO: Mostrar mensaje de error temporal
 */
function mostrarMensajeError(mensaje) {
    const mensajeElement = document.createElement('div');
    mensajeElement.innerHTML = `
        <div style="
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 10012;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s ease;
        ">
            <i class="fas fa-exclamation-triangle" style="font-size: 18px;"></i>
            <span>${mensaje}</span>
        </div>
    `;
    
    document.body.appendChild(mensajeElement);
    
    setTimeout(() => {
        mensajeElement.remove();
    }, 4000);
}

/**
 * FUNCI√ìN: recargarVistaActual
 * PROP√ìSITO: Recargar la vista actual despu√©s de eliminar
 */
function recargarVistaActual() {
    // Si estamos en la secci√≥n de actualizaciones
    if (seccionActual === 'actualizaciones') {
        cargarActualizacionesReportes();
    }
    
    // Si estamos en la vista de detalle de un reporte
    const urlParams = new URLSearchParams(window.location.search);
    const detailId = urlParams.get('id');
    if (detailId && detailId === reporteIdActual) {
        mostrarDetalle(detailId);
    }
    
    // Si estamos en la lista de reportes
    if (document.getElementById('listaReportes') && document.getElementById('listaReportes').children.length > 0) {
        cargarListaReportes();
    }
}
    function abrirFormularioActualizacion(reporteId) {
      if (!usuarioAutenticado) {
        alert('Solo el personal autorizado puede agregar actualizaciones. Por favor, inicie sesi√≥n.');
        abrirFormularioLogin();
        return;
      }
      
      document.getElementById('reporteIdActualizacion').value = reporteId;
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('formActualizacionContainer').style.display = 'block';
    }

    /**
     * FUNCI√ìN: cerrarFormularioActualizacion
     * PROP√ìSITO: Ocultar formulario de actualizaci√≥n
     * ENTRADA: Ninguna
     * SALIDA: Ninguna
     */
    function cerrarFormularioActualizacion() {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('formActualizacionContainer').style.display = 'none';
      document.getElementById('formActualizacion').reset();
    }

    /**
     * FUNCI√ìN: guardarActualizacion
     * PROP√ìSITO: Guardar nueva actualizaci√≥n en Firebase
     * ENTRADA: ID reporte, descripci√≥n, estado, t√©cnico
     * SALIDA: Ninguna
     */
    function guardarActualizacion(reporteId, descripcion, estado, tecnico) {
      if (!usuarioAutenticado) {
        alert('Error de autenticaci√≥n. Por favor, inicie sesi√≥n nuevamente.');
        return;
      }
      
      const nuevaActualizacion = {
        titulo: "Actualizaci√≥n",
        descripcion: descripcion,
        estado: estado,
        tecnico: tecnico || '',
        fecha: Date.now(),
        usuario: localStorage.getItem('cespt_usuario')
      };
      
      // Obtener referencia al reporte
      const reporteRef = db.ref('reportes/' + reporteId);
      
      // Obtener el reporte actual para actualizar el estado
      reporteRef.once('value').then(snapshot => {
        const reporte = snapshot.val();
        const actualizaciones = reporte.actualizaciones || {};
        
        // Agregar la nueva actualizaci√≥n
        const nuevaKey = db.ref().child('actualizaciones').push().key;
        actualizaciones[nuevaKey] = nuevaActualizacion;
        
        // Actualizar el reporte con la nueva actualizaci√≥n y el nuevo estado
        reporteRef.update({
          actualizaciones: actualizaciones,
          status: estado  // Actualizar el estado principal del reporte
        }).then(() => {
          alert('Actualizaci√≥n guardada correctamente');
          cerrarFormularioActualizacion();
          
          // Recargar las actualizaciones si estamos en esa secci√≥n
          if (seccionActual === 'actualizaciones') {
            cargarActualizacionesReportes();
          }
          
          // Actualizar el marcador en el mapa si existe
          if (marcadores[reporteId]) {
            actualizarMarcadorEnMapa(reporteId, estado);
          }
        }).catch(error => {
          console.error('Error al guardar la actualizaci√≥n:', error);
          alert('Error al guardar la actualizaci√≥n');
        });
      });
    }

    /**
     * FUNCI√ìN: actualizarMarcadorEnMapa
     * PROP√ìSITO: Cambiar apariencia del marcador seg√∫n estado
     * ENTRADA: ID reporte, nuevo estado
     * SALIDA: Ninguna
     */
    function actualizarMarcadorEnMapa(reporteId, nuevoEstado) {
      if (marcadores[reporteId] && mapa) {
        // Cambiar el icono del marcador seg√∫n el estado
        let color = 'blue';
        if (nuevoEstado === 'pendiente') color = 'blue';
        if (nuevoEstado === 'aprobado') color = 'orange';
        if (nuevoEstado === 'resuelto') color = 'green';
        
        const nuevoIcono = createIcon(color);
        marcadores[reporteId].setIcon(nuevoIcono);
      }
    }

    /* ===== FUNCIONALIDAD DE BUSCADORES ===== */

    /**
     * FUNCI√ìN: inicializarBuscadorActualizaciones
     * PROP√ìSITO: Configurar b√∫squeda en tiempo real para actualizaciones
     * ENTRADA: Ninguna
     * SALIDA: Ninguna (configura event listeners)
     */
    function inicializarBuscadorActualizaciones() {
      const buscador = document.getElementById('buscadorActualizaciones');
      
      buscador.addEventListener('input', function() {
        const textoBusqueda = this.value.toLowerCase().trim();
        const items = document.querySelectorAll('.actualizacion-item');
        let itemsVisibles = 0;
        
        items.forEach(item => {
          const textoCompleto = item.textContent.toLowerCase();
          const coincide = textoBusqueda === '' || textoCompleto.includes(textoBusqueda);
          
          if (coincide) {
            item.style.display = 'block';
            itemsVisibles++;
            
            // Resaltar texto coincidente
            resaltarTexto(item, textoBusqueda);
          } else {
            item.style.display = 'none';
          }
        });
        
        // Actualizar contador
        const contador = document.querySelector('#contenidoActualizaciones .contador-resultados');
        if (contador) {
          contador.textContent = `${itemsVisibles} reportes con actualizaciones encontrados`;
        }
        
        // Mostrar mensaje si no hay resultados
        if (itemsVisibles === 0 && textoBusqueda !== '') {
          const contenedor = document.getElementById('contenidoActualizaciones');
          const mensajeExistente = contenedor.querySelector('.sin-resultados');
          if (!mensajeExistente) {
            const mensaje = document.createElement('div');
            mensaje.className = 'sin-resultados';
            mensaje.innerHTML = `
              <div style="font-size: 48px; margin-bottom: 10px;">üîç</div>
              <h3 style="color: #666; margin-bottom: 10px;">No se encontraron actualizaciones</h3>
              <p>Intenta con otros t√©rminos de b√∫squeda</p>
            `;
            contenedor.appendChild(mensaje);
          }
        } else {
          const mensajeExistente = document.querySelector('#contenidoActualizaciones .sin-resultados');
          if (mensajeExistente) {
            mensajeExistente.remove();
          }
        }
      });
    }

    /**
     * FUNCI√ìN: inicializarBuscadorReportes
     * PROP√ìSITO: Configurar b√∫squeda y filtros para reportes
     * ENTRADA: Ninguna
     * SALIDA: Ninguna (configura event listeners)
     */
    function inicializarBuscadorReportes() {
      const buscador = document.getElementById('buscadorReportes');
      const filtroEstado = document.getElementById('filtroEstado');
      
      function filtrarReportes() {
        const textoBusqueda = buscador.value.toLowerCase().trim();
        const estadoSeleccionado = filtroEstado.value;
        const tarjetas = document.querySelectorAll('.reporte-card');
        let tarjetasVisibles = 0;
        
        tarjetas.forEach(tarjeta => {
          const textoCompleto = tarjeta.textContent.toLowerCase();
          const estadoTarjeta = tarjeta.querySelector('.estado-badge').textContent.toLowerCase();
          
          const coincideTexto = textoBusqueda === '' || textoCompleto.includes(textoBusqueda);
          const coincideEstado = estadoSeleccionado === 'todos' || estadoTarjeta === estadoSeleccionado;
          
          if (coincideTexto && coincideEstado) {
            tarjeta.style.display = 'block';
            tarjetasVisibles++;
            
            // Resaltar texto coincidente
            resaltarTexto(tarjeta, textoBusqueda);
          } else {
            tarjeta.style.display = 'none';
          }
        });
        
        // Mostrar mensaje si no hay resultados
        mostrarMensajeSinResultados('reportes', tarjetasVisibles);
      }
      
      buscador.addEventListener('input', filtrarReportes);
      filtroEstado.addEventListener('change', filtrarReportes);
      
    }

    /**
     * FUNCI√ìN: resaltarTexto
     * PROP√ìSITO: Resaltar t√©rminos de b√∫squeda en el contenido
     * ENTRADA: Elemento DOM, texto a resaltar
     * SALIDA: Ninguna (modifica DOM)
     */
    function resaltarTexto(elemento, textoBusqueda) {
      if (!textoBusqueda) return;
      
      const elementosTexto = elemento.querySelectorAll('h3, .descripcion, .fecha, p, .actualizacion-titulo, .actualizacion-descripcion');
      elementosTexto.forEach(el => {
        const textoOriginal = el.textContent;
        const regex = new RegExp(`(${textoBusqueda})`, 'gi');
        const textoResaltado = textoOriginal.replace(regex, '<mark style="background: #ffeb3b; padding: 2px 4px; border-radius: 3px;">$1</mark>');
        el.innerHTML = textoResaltado;
      });
    }

    /**
     * FUNCI√ìN: mostrarMensajeSinResultados
     * PROP√ìSITO: Mostrar mensaje cuando no hay resultados de b√∫squeda
     * ENTRADA: Tipo de secci√≥n, cantidad de elementos visibles
     * SALIDA: Ninguna (modifica DOM)
     */
    function mostrarMensajeSinResultados(seccion, cantidadVisibles) {
      let contenedor, tipo;
      
      if (seccion === 'actualizaciones') {
        contenedor = document.getElementById('contenidoActualizaciones');
        tipo = 'actualizaciones';
      } else {
        contenedor = document.getElementById('listaReportes');
        tipo = 'reportes';
      }
      
      // Remover mensaje anterior si existe
      const mensajeAnterior = contenedor.querySelector('.sin-resultados');
      if (mensajeAnterior) {
        mensajeAnterior.remove();
      }
      
      // Remover contador anterior si existe
      const contadorAnterior = contenedor.querySelector('.contador-resultados');
      if (contadorAnterior) {
        contadorAnterior.remove();
      }
      
      // Agregar contador de resultados
      const contador = document.createElement('div');
      contador.className = 'contador-resultados';
      contador.textContent = `${cantidadVisibles} ${tipo} encontrados`;
      if (contenedor.firstChild) {
        contenedor.insertBefore(contador, contenedor.firstChild);
      } else {
        contenedor.appendChild(contador);
      }
      
      // Mostrar mensaje si no hay resultados
      if (cantidadVisibles === 0) {
        const mensaje = document.createElement('div');
        mensaje.className = 'sin-resultados';
        mensaje.innerHTML = `
          <div style="font-size: 48px; margin-bottom: 10px;">üîç</div>
          <h3 style="color: #666; margin-bottom: 10px;">No se encontraron ${tipo}</h3>
          <p>Intenta con otros t√©rminos de b√∫squeda</p>
        `;
        contenedor.appendChild(mensaje);
      }
    }

    /* ===== FUNCI√ìN PARA MANEJAR EL MEN√ö ===== */

    /**
     * FUNCI√ìN: toggleSeccion
     * PROP√ìSITO: Mostrar/ocultar secciones del sistema
     * ENTRADA: ID de la secci√≥n
     * SALIDA: Ninguna
     */
    function toggleSeccion(seccionId) {
      const seccion = document.getElementById(seccionId);
      const boton = document.getElementById(`btn${seccionId.charAt(0).toUpperCase() + seccionId.slice(1)}`);
      
      // Si ya est√° activa, la cerramos
      if (seccionActual === seccionId) {
        seccion.style.display = 'none';
        boton.classList.remove('activo');
        seccionActual = null;
        return;
      }
      
      // Cerramos la secci√≥n actual si existe
      if (seccionActual) {
        document.getElementById(seccionActual).style.display = 'none';
        document.getElementById(`btn${seccionActual.charAt(0).toUpperCase() + seccionActual.slice(1)}`).classList.remove('activo');
      }
      
      // Abrimos la nueva secci√≥n
      seccion.style.display = 'block';
      boton.classList.add('activo');
      seccionActual = seccionId;
      
      // Scroll suave hacia la secci√≥n
      window.scrollTo({top: seccion.offsetTop - 20, behavior: 'smooth'});
      
      // INICIALIZAR BUSCADORES AL ABRIR SECCI√ìN
      if (seccionId === 'reportes') {
        cargarListaReportes();
        // Peque√±o delay para asegurar que las tarjetas se cargaron
        setTimeout(() => {
          inicializarBuscadorReportes();
        }, 100);
      } else if (seccionId === 'actualizaciones') {
        cargarActualizacionesReportes();
        // Peque√±o delay para asegurar que las actualizaciones se cargaron
        setTimeout(() => {
          inicializarBuscadorActualizaciones();
        }, 100);
      }
    }

    /* ===== RUTEO: DETALLE DE REPORTE ===== */
    const urlParams = new URLSearchParams(window.location.search);
    const detailId = urlParams.get('id');
    const detailEl = document.getElementById('detail');

    if (detailId) {
      // Mostrar detalle (oculta mapa y UI)
      document.querySelector('.map-box').style.display = 'none';
      document.getElementById('btnAgregarQueja').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('formContainer').style.display = 'none';
      document.getElementById('mapMessage').style.display = 'none';
      detailEl.style.display = 'block';
      mostrarDetalle(detailId);
    } else {
      detailEl.style.display = 'none';
      initMap();
    }

    /* ===== FUNCI√ìN mostrarDetalle(id) MEJORADA ===== */

    /**
     * FUNCI√ìN: mostrarDetalle
     * PROP√ìSITO: Mostrar vista detallada de un reporte espec√≠fico
     * ENTRADA: ID del reporte
     * SALIDA: Ninguna (actualiza DOM)
     */
    function mostrarDetalle(id) {
      const ref = db.ref('reportes/' + id);
      ref.once('value').then(snap => {
        const data = snap.val();
        if (!data) {
          document.getElementById('detailContent').innerHTML = 
            '<div style="text-align: center; padding: 40px; color: #666;">' +
            '<i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>' +
            '<h3>Reporte no encontrado</h3>' +
            '<p>El reporte solicitado no existe o ha sido eliminado.</p>' +
            '</div>';
          return;
        }
        
        const street = data.street || 'Calle desconocida, Tijuana';
        const description = data.description || 'No hay descripci√≥n disponible.';
        const estado = data.status || 'pendiente';
        
        // C√ÅLCULO DE D√çAS MEJORADO
        const fechaCreacionMs = data.fechaCreacion ? 
          (data.fechaCreacion.toMillis ? data.fechaCreacion.toMillis() : data.fechaCreacion) : 
          Date.now();
        const diasPasados = calcularDiasUTC(fechaCreacionMs);
        
        // Formatear fecha de creaci√≥n
        const fechaCreacion = new Date(fechaCreacionMs);
        const fechaFormateada = fechaCreacion.toLocaleDateString('es-MX', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        // Calcular prioridad y badges
        const prioridad = calcularPrioridad(data);
        const badgePrioridad = obtenerBadgePrioridad(prioridad);
        const badgeUrgencia = obtenerBadgeUrgencia(diasPasados);

        // Actualizar la informaci√≥n b√°sica
        document.getElementById('detailStreet').innerHTML = `
          ${street}
          <div id="detailBadges" style="margin-top: 10px;">
            ${badgePrioridad}
            ${badgeUrgencia}
          </div>
        `;
        document.getElementById('detailDescription').textContent = description;
        document.getElementById('detailDias').textContent = `${diasPasados} d√≠as`;
        document.getElementById('detailFecha').textContent = fechaFormateada;
        
        // Actualizar estado con el badge correspondiente
        const estadoElement = document.getElementById('detailEstado');
        estadoElement.textContent = estado;
        estadoElement.className = 'estado-badge estado-' + estado;
        
        // Cargar fotos
        const photosContainer = document.getElementById('detailPhotos');
        photosContainer.innerHTML = '';
        
        if (data.foto) {
          if (Array.isArray(data.foto)) {
            // M√∫ltiples fotos
            data.foto.forEach(f => {
              const imgContainer = document.createElement('div');
              imgContainer.style.position = 'relative';
              imgContainer.style.cursor = 'pointer';
              
              const img = document.createElement('img');
              img.src = `Fotos/${f}`;
              img.className = 'thumb';
              img.onclick = () => mostrarImagen(`Fotos/${f}`);
              img.style.width = '120px';
              img.style.height = '120px';
              img.style.objectFit = 'cover';
              img.style.borderRadius = '8px';
              img.style.border = '2px solid #ddd';
              img.style.transition = 'all 0.3s ease';
              
              imgContainer.appendChild(img);
              photosContainer.appendChild(imgContainer);
            });
          } else {
            // Una sola foto
            const imgContainer = document.createElement('div');
            imgContainer.style.position = 'relative';
            imgContainer.style.cursor = 'pointer';
            
            const img = document.createElement('img');
            img.src = `Fotos/${data.foto}`;
            img.className = 'thumb';
            img.onclick = () => mostrarImagen(`Fotos/${data.foto}`);
            img.style.width = '120px';
            img.style.height = '120px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '8px';
            img.style.border = '2px solid #ddd';
            img.style.transition = 'all 0.3s ease';
            
            imgContainer.appendChild(img);
            photosContainer.appendChild(imgContainer);
          }
        } else if (data.photo) {
          // Compatibilidad con campo "photo"
          const imgContainer = document.createElement('div');
          imgContainer.style.position = 'relative';
          imgContainer.style.cursor = 'pointer';
          
          const img = document.createElement('img');
          img.src = data.photo;
          img.className = 'thumb';
          img.onclick = () => mostrarImagen(data.photo);
          img.style.width = '120px';
          img.style.height = '120px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '8px';
          img.style.border = '2px solid #ddd';
          img.style.transition = 'all 0.3s ease';
          
          imgContainer.appendChild(img);
          photosContainer.appendChild(imgContainer);
        } else {
          photosContainer.innerHTML = 
            '<div style="color:#666; padding: 20px; text-align: center; width: 100%;">' +
            '<i class="fas fa-image" style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;"></i>' +
            '<p>No hay fotos disponibles para este reporte</p>' +
            '</div>';
        }
        
        // Cargar historial de actualizaciones
        cargarHistorialActualizaciones(id);
        
      }).catch(err => {
        document.getElementById('detailContent').innerHTML = 
          '<div style="text-align: center; padding: 40px; color: #666;">' +
          '<i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>' +
          '<h3>Error al cargar el reporte</h3>' +
          '<p>Ocurri√≥ un problema al cargar la informaci√≥n del reporte.</p>' +
          '</div>';
        console.error(err);
      });

      document.getElementById('backToMap').addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = window.location.pathname;
      });
      
      // Mostrar/ocultar bot√≥n de actualizaci√≥n seg√∫n autenticaci√≥n
      const btnActualizacion = document.getElementById('btnAgregarActualizacionDetalle');
      if (usuarioAutenticado) {
        btnActualizacion.style.display = 'inline-block';
        btnActualizacion.onclick = () => abrirFormularioActualizacion(detailId);
      } else {
        btnActualizacion.style.display = 'none';
      }
    }

    /* ===== FUNCI√ìN PARA CARGAR HISTORIAL DE ACTUALIZACIONES ===== */

   /**
 * FUNCI√ìN: cargarHistorialActualizaciones
 * PROP√ìSITO: Cargar y mostrar el historial completo de actualizaciones
 * ENTRADA: ID del reporte
 * SALIDA: Ninguna (actualiza DOM)
 */
function cargarHistorialActualizaciones(reporteId) {
  const contenedor = document.getElementById('detailActualizaciones');
  
  db.ref('reportes/' + reporteId).once('value').then(snapshot => {
    const data = snapshot.val();
    if (!data || !data.actualizaciones) {
      contenedor.innerHTML = 
        '<div style="color:#666; padding: 20px; text-align: center;">' +
        '<i class="fas fa-info-circle" style="margin-right: 8px;"></i>' +
        'No hay actualizaciones disponibles para este reporte.' +
        '</div>';
      return;
    }
    
    const actualizaciones = Object.entries(data.actualizaciones);
    
    // Ordenar por fecha (m√°s reciente primero)
    actualizaciones.sort((a, b) => b[1].fecha - a[1].fecha);
    
    if (actualizaciones.length === 0) {
      contenedor.innerHTML = 
        '<div style="color:#666; padding: 20px; text-align: center;">' +
        '<i class="fas fa-info-circle" style="margin-right: 8px;"></i>' +
        'No hay actualizaciones disponibles para este reporte.' +
        '</div>';
      return;
    }
    
    let html = '';
    actualizaciones.forEach(([actualizacionId, act], index) => {
      const fecha = new Date(act.fecha);
      const fechaFormateada = fecha.toLocaleDateString('es-MX', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      html += `
        <div class="actualizacion-item ${index === 0 ? 'ultima-actualizacion' : ''}" 
             style="border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #fafafa;">
          <div class="actualizacion-contenedor">
            ${usuarioAutenticado ? `
              <button 
                onclick="mostrarModalEliminacion('${reporteId}', '${actualizacionId}', '${escapeHtml(act.descripcion || 'Sin descripci√≥n')}')" 
                class="btn-eliminar-actualizacion"
                title="Eliminar esta actualizaci√≥n"
              >
                <i class="fas fa-trash"></i> Eliminar
              </button>
            ` : ''}
            
            <div class="actualizacion-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <div class="actualizacion-titulo" style="font-weight: bold; color: #7c002a; font-size: 16px; margin: 0;">
                Actualizaci√≥n
              </div>
              <div class="actualizacion-fecha" style="color: #666; font-size: 12px;">
                ${fechaFormateada}
              </div>
            </div>
            
            <div class="actualizacion-descripcion" style="color: #333; margin-bottom: 8px;">
              ${act.descripcion || 'Sin descripci√≥n adicional'}
            </div>
            
            <div class="actualizacion-meta" style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #666;">
              <div>
                ${act.estado ? `
                  <span class="badge-estado estado-${act.estado}" style="padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                    ${act.estado}
                  </span>
                ` : ''}
                ${act.tecnico ? `<span style="margin-left: 10px;">T√©cnico: ${act.tecnico}</span>` : ''}
              </div>
              ${act.usuario ? `<span>Por: ${act.usuario}</span>` : ''}
            </div>
          </div>
        </div>
      `;
    });
    
    contenedor.innerHTML = html;
    
  }).catch(err => {
    console.error('Error cargando actualizaciones:', err);
    contenedor.innerHTML = 
      '<div style="color:#666; padding: 20px; text-align: center;">' +
      '<i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>' +
      'Error al cargar las actualizaciones.' +
      '</div>';
  });
}

    /* ===== FUNCIONES MAPA (cuando no hay ?id) ===== */

    /**
     * FUNCI√ìN: initMap
     * PROP√ìSITO: Inicializar el mapa interactivo y toda su funcionalidad
     * ENTRADA: Ninguna
     * SALIDA: Ninguna
     */
    function initMap(){
      mapa = L.map('map');
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(mapa);

      fetch("https://nominatim.openstreetmap.org/search?city=Tijuana&format=json")
        .then(r => r.json())
        .then(data => {
          if (data.length > 0) mapa.setView([parseFloat(data[0].lat), parseFloat(data[0].lon)], 12);
          else mapa.setView([32.533, -117.033], 12);
        })
        .catch(()=> mapa.setView([32.533, -117.033], 12));

      /**
       * FUNCI√ìN: addMarker
       * PROP√ìSITO: Agregar marcador al mapa con toda la informaci√≥n
       * ENTRADA: Coordenadas, datos del reporte
       * SALIDA: Marcador de Leaflet
       */
      
    function addMarker(lat, lng, key, street, descripcion = '', rawData = {}, count = 1){
  // C√ÅLCULO DE D√çAS MEJORADO
  const fechaCreacionMs = rawData.fechaCreacion ? (rawData.fechaCreacion.toMillis ? rawData.fechaCreacion.toMillis() : rawData.fechaCreacion) : Date.now();
  const diasPasados = calcularDiasUTC(fechaCreacionMs);
  
  // CALCULAR PRIORIDAD (esta se mantiene fija)
  const prioridad = calcularPrioridad(rawData);
  
  // Obtener informaci√≥n visual (color, parpadeo, y si es urgente)
  const { color, parpadeo, esUrgente } = determinarColorYParpadeo(diasPasados, count, prioridad);
  
  // Pasar la prioridad a createIcon (NO el color para el bander√≠n)
  const icon = createIcon(color, prioridad);
  
  const marker = L.marker([lat, lng], { icon }).addTo(mapa);
  
  // Guardar referencia al marcador
  marcadores[key] = marker;

  const streetEsc = escapeHtml(street || 'Calle desconocida, Tijuana');
  const descEsc = escapeHtml(descripcion || '');

  // Calcular prioridad para el popup (SIEMPRE usar la prioridad calculada)
  const badgePrioridad = obtenerBadgePrioridad(prioridad);
  
  // MOSTRAR BADGE DE URGENCIA SOLO SI ES URGENTE
  const badgeUrgencia = esUrgente ? '<span class="badge-urgencia"><i class="fas fa-bell"></i> URGENTE</span>' : '';

  const popupHtml = `
    <div style="min-width: 280px;">
      <div style="border-bottom: 2px solid #7c002a; padding-bottom: 8px; margin-bottom: 10px;">
        <div style="font-weight:700; color: #7c002a;">üìç ${streetEsc}</div>
      </div>
      
      <div style="margin-bottom: 8px;">
        <strong>Tipo:</strong> ${descEsc.split(':')[0] || descEsc}
      </div>
      
      <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
        ${badgePrioridad}
        ${badgeUrgencia} <!-- ‚Üê Esto solo se muestra si esUrgente es true -->
        <span class="estado-badge estado-${rawData.status || 'pendiente'}">${rawData.status || 'pendiente'}</span>
      </div>
      
      <div style="margin-bottom: 8px;">
        <strong><i class="far fa-clock"></i> D√≠as:</strong> ${diasPasados} d√≠as
      </div>
      
      <div style="border-top: 1px solid #eee; padding-top: 10px; display: flex; justify-content: space-between;">
        <a href="?id=${key}" style="color: #7c002a; font-weight: bold; text-decoration: none;">
          <i class="fas fa-external-link-alt"></i> Ver detalles
        </a>
        ${usuarioAutenticado ? `
          <button class="btn-agregar-actualizacion" onclick="abrirFormularioActualizacion('${key}')" style="padding: 4px 8px; font-size: 12px;">
            <i class="fas fa-edit"></i> Actualizar
          </button>
        ` : ''}
      </div>
    </div>
  `;

  marker.bindPopup(popupHtml);

  // EFECTO DE PARPADEO (manteniendo la prioridad en el bander√≠n)
  if (parpadeo) {
    let visible = true;
    const intervalo = setInterval(() => {
      if (mapa.hasLayer(marker)) {
        // Crear nuevos iconos con la misma prioridad
        const nuevoIcono = createIcon(visible ? 'red' : 'grey', prioridad);
        marker.setIcon(nuevoIcono);
        visible = !visible;
      } else {
        clearInterval(intervalo);
      }
    }, 500);
  }

  

  // doble click para eliminar (solo para pruebas)
  // DOBLE CLICK PARA ELIMINAR - SOLO PARA ADMINISTRADORES
marker.on('dblclick', () => {
  if (!usuarioAutenticado) {
    alert('Solo el personal autorizado puede eliminar reportes. Por favor, inicie sesi√≥n.');
    abrirFormularioLogin();
    return;
  }
  
  if (confirm('¬øEst√° seguro de que desea eliminar este reporte?\n\nEsta acci√≥n no se puede deshacer.')) {
    // Mostrar confirmaci√≥n adicional para mayor seguridad
    if (confirm('‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n eliminar√° permanentemente el reporte.\n¬øContinuar con la eliminaci√≥n?')) {
      // Eliminar marcador del mapa
      mapa.removeLayer(marker);
      
      // Eliminar reporte de Firebase
      db.ref('reportes/' + key).remove()
        .then(() => {
          console.log(`‚úÖ Reporte ${key} eliminado correctamente`);
          delete marcadores[key];
          
          // Mostrar mensaje de √©xito
          mostrarMensajeExito('Reporte eliminado correctamente');
        })
        .catch((error) => {
          console.error('Error al eliminar reporte:', error);
          mostrarMensajeError('Error al eliminar el reporte: ' + error.message);
          
          // Reagregar el marcador si hubo error
          marker.addTo(mapa);
        });
    }
  }
});
}

      // CARGAR TODOS los reportes para mostrarlos en el mapa (aprobados + pendientes)
      db.ref('reportes').once('value').then(snapshot => {
        const reportCount = {}; // para agrupar por coordenadas
        snapshot.forEach(child => {
          const data = child.val();
          if (!data) return;
          // agrupar por coord redondeada (incluso si faltan lat/lng salta)
          if (data.lat == null || data.lng == null) return;
          const keyCoords = `${roundCoord(data.lat)},${roundCoord(data.lng)}`;
          if (!reportCount[keyCoords]) reportCount[keyCoords] = 0;
          reportCount[keyCoords]++;
        });

        snapshot.forEach(child => {
          const data = child.val();
          if (!data) return;
          if (data.lat == null || data.lng == null) return;
          const key = child.key;
          const keyCoords = `${roundCoord(data.lat)},${roundCoord(data.lng)}`;
          const count = reportCount[keyCoords] || 0;
          
          // Usar la funci√≥n addMarker que aplica colores y parpadeo correctamente
          addMarker(data.lat, data.lng, key, data.street || 'Calle desconocida, Tijuana', 
                    data.description || '', data, count);
        });
      }).catch(err => console.error(err));

      /* ===== CARGAR LISTA DE REPORTES ===== */
      window.cargarListaReportes = function() {
        const listaContainer = document.getElementById('listaReportes');
        db.ref('reportes').once('value').then(snapshot => {
          listaContainer.innerHTML = '';
          const items = [];
          snapshot.forEach(child => {
            const data = child.val();
            if (!data) return;
            items.push({ id: child.key, val: data });
          });

          if (items.length === 0) {
            listaContainer.innerHTML = '<div class="sin-resultados"><p style="color:#666;">No hay reportes actualmente.</p></div>';
            return;
          }

          // Ordenar por fecha m√°s reciente primero
          items.sort((a, b) => {
            const fechaA = a.val.fechaCreacion || a.val.timestamp || 0;
            const fechaB = b.val.fechaCreacion || b.val.timestamp || 0;
            return fechaB - fechaA;
          });

          // mostrar cada uno
          items.forEach(item => {
            const data = item.val;
            
            // C√°lculo de d√≠as mejorado
            const fechaCreacionMs = data.fechaCreacion ? (data.fechaCreacion.toMillis ? data.fechaCreacion.toMillis() : data.fechaCreacion) : Date.now();
            const diasPasados = calcularDiasUTC(fechaCreacionMs);
            
            // Calcular prioridad
            const prioridad = calcularPrioridad(data);
            const badgePrioridad = obtenerBadgePrioridad(prioridad);
            const badgeUrgencia = obtenerBadgeUrgencia(diasPasados);
            
            const card = document.createElement('div');
            card.className = 'reporte-card';
            
            // Determinar clase de estado CORREGIDO
            let estadoClass = 'estado-pendiente';
            if (data.status === 'aprobado') {
              estadoClass = 'estado-aprobado';
            } else if (data.status === 'resuelto') {
              estadoClass = 'estado-resuelto';
            }
            
            card.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <h3 style="margin: 0; color: #7c002a; flex: 1;">${escapeHtml(data.street || 'Ubicaci√≥n desconocida')}</h3>
                <div style="text-align: right;">
                  ${badgePrioridad}
                  ${badgeUrgencia}
                </div>
              </div>
              <div class="fecha" style="color: #666; font-size: 14px; margin-bottom: 8px;">
                <i class="far fa-clock"></i> Reportado hace ${diasPasados} d√≠as
              </div>
              <div class="descripcion" style="margin-bottom: 10px;">${escapeHtml(data.description || 'Sin descripci√≥n')}</div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span class="estado-badge estado-${data.status || 'pendiente'}">${data.status || 'pendiente'}</span>
                <div>
                  <a href="?id=${item.id}" style="color:#0056b3; text-decoration:underline; margin-right: 10px;">Ver detalles</a>
                  ${usuarioAutenticado ? `
                    <button class="btn-agregar-actualizacion" onclick="abrirFormularioActualizacion('${item.id}')">Actualizar</button>
                  ` : ''}
                </div>
              </div>
            `;
            listaContainer.appendChild(card);
          });

          // INICIALIZAR BUSCADOR DESPU√âS DE CARGAR
          inicializarBuscadorReportes();
          
        }).catch(err => {
          listaContainer.innerHTML = '<div class="sin-resultados"><p style="color:#666;">Error cargando reportes.</p></div>';
          console.error('Error cargando reportes:', err);
        });
      };

      // Cargar lista inicial de reportes
      cargarListaReportes();

      /* ===== UI form y creaci√≥n de reportes ===== */
      const overlay = document.getElementById('overlay');
      const formContainer = document.getElementById('formContainer');
      const closeForm = document.getElementById('closeForm');
      const formQueja = document.getElementById('formQueja');
      const btnAgregar = document.getElementById('btnAgregarQueja');
      const mapMessage = document.getElementById('mapMessage');

      // INICIALIZAR CAMPO "OTRO PROBLEMA"
      inicializarCampoOtroProblema();

      btnAgregar.addEventListener('click', () => { 
        overlay.style.display='block'; 
        formContainer.style.display='block'; 
      });
      
      closeForm.addEventListener('click', () => { 
        overlay.style.display='none'; 
        formContainer.style.display='none'; 
      });

      let colocarMarcadorActivo = false;
      formQueja.addEventListener('submit', (e) => {
        e.preventDefault();
        
        // Validar que si se seleccion√≥ "otro", se haya especificado el problema
        const tipoProblema = document.getElementById('tipoProblema').value;
        const otroProblema = document.getElementById('otroProblema').value;
        
        if (tipoProblema === 'otro' && (!otroProblema || otroProblema.trim() === '')) {
          alert('Por favor, especifica el problema cuando seleccionas "Otro tipo de problema"');
          return;
        }
        
        overlay.style.display='none';
        formContainer.style.display='none';
        mapMessage.style.display='block';
        colocarMarcadorActivo = true;
      });

      mapa.on('click', function(ev){
        if (!colocarMarcadorActivo) return;
        colocarMarcadorActivo = false;
        mapMessage.style.display='none';

        const { lat, lng } = ev.latlng;
        const tipoProblema = document.getElementById('tipoProblema').value;
        const otroProblema = document.getElementById('otroProblema').value;
        const descripcionAdicional = document.getElementById('descripcion').value;

        // Combinar el tipo de problema con la descripci√≥n adicional
        let descripcionCompleta = '';
        
        if (tipoProblema === 'otro') {
          // Usar el texto del campo "otro problema"
          descripcionCompleta = `Otro problema: ${otroProblema}`;
        } else {
          // Usar el texto del select
          descripcionCompleta = tipoProblema;
        }
        
        // Agregar descripci√≥n adicional si existe
        if (descripcionAdicional) {
          descripcionCompleta += `: ${descripcionAdicional}`;
        }

        // abrir nueva pesta√±a primero para evitar bloqueos m√≥viles
        const nuevaPesta√±a = window.open('', '_blank');

        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`)
          .then(res => res.json())
          .then(data => {
            const street = data.address?.road || 'Calle desconocida';
            const city = data.address?.city || data.address?.town || data.address?.village || 'Tijuana';
            const fullStreet = `${street}, ${city}`;

            // Guardar en Firebase con timestamp
            const newRef = db.ref('reportes').push();
            newRef.set({
              lat, lng,
              street: fullStreet,
              description: descripcionCompleta,
              foto:"Suba su foto",
              status: 'pendiente',
              timestamp: firebase.database.ServerValue.TIMESTAMP,
              fechaCreacion: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
              console.log('Reporte guardado correctamente:', descripcionCompleta);
              
              // CERRAR el formulario y resetearlo
              document.getElementById('overlay').style.display = 'none';
              document.getElementById('formContainer').style.display = 'none';
              document.getElementById('formQueja').reset();
              document.getElementById('otroProblemaContainer').style.display = 'none';
              
              // Recargar lista de reportes
              cargarListaReportes();
              
              // Agregar marcador al mapa inmediatamente
              addMarker(lat, lng, newRef.key, fullStreet, descripcionCompleta, {
                status: 'pendiente',
                fechaCreacion: Date.now()
              }, 1);
              
              // Redirigir a Google Forms
              nuevaPesta√±a.location.href = "https://docs.google.com/forms/d/e/1FAIpQLScrEq6KDExGBKtzYpbWZeuWsUzy2gKC61hTQ3p8L_8DLPChVw/viewform";
              
            }).catch(err => {
              console.error('Error al guardar:', err);
              alert('Error al guardar el reporte');
              nuevaPesta√±a.location.href = "https://docs.google.com/forms/d/e/1FAIpQLScrEq6KDExGBKtzYpbWZeuWsUzy2gKC61hTQ3p8L_8DLPChVw/viewform";
            });
          })
          .catch(() => {
            const newRef = db.ref('reportes').push();
            newRef.set({
              lat, lng,
              street: "Calle desconocida, Tijuana",
              description: descripcionCompleta,
              foto:"Suba su foto",
              status: 'pendiente',
              timestamp: firebase.database.ServerValue.TIMESTAMP,
              fechaCreacion: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
              console.log('Reporte guardado (fallback):', descripcionCompleta);
              
              // CERRAR el formulario y resetearlo
              document.getElementById('overlay').style.display = 'none';
              document.getElementById('formContainer').style.display = 'none';
              document.getElementById('formQueja').reset();
              document.getElementById('otroProblemaContainer').style.display = 'none';
              
              // Recargar lista de reportes
              cargarListaReportes();
              
              // Agregar marcador al mapa inmediatamente
              addMarker(lat, lng, newRef.key, "Calle desconocida, Tijuana", descripcionCompleta, {
                status: 'pendiente',
                fechaCreacion: Date.now()
              }, 1);
              
              nuevaPesta√±a.location.href = "https://docs.google.com/forms/d/e/1FAIpQLScrEq6KDExGBKtzYpbWZeuWsUzy2gKC61hTQ3p8L_8DLPChVw/viewform";
            });
          });
      });

      // soporte t√°ctil
      mapa.on('touchend', function(ev){
        if(!colocarMarcadorActivo) return;
        const touch = ev.originalEvent.changedTouches ? ev.originalEvent.changedTouches[0] : null;
        if(!touch) return;
        const point = mapa.mouseEventToLatLng(touch);
        mapa.fire('click', { latlng: point });
      });

    } // fin initMap

    /* ===== FUNCIONALIDAD MISI√ìN Y VISI√ìN ===== */

    /**
     * FUNCI√ìN: mostrarMV
     * PROP√ìSITO: Cambiar entre pesta√±as de Misi√≥n y Visi√≥n
     * ENTRADA: Tipo de contenido a mostrar
     * SALIDA: Ninguna
     */
    function mostrarMV(tipo){
      document.getElementById("mision").classList.toggle("active", tipo === "mision");
      document.getElementById("vision").classList.toggle("active", tipo === "vision");

      // Color de pesta√±as
      document.getElementById("tabMision").classList.toggle("active", tipo === "mision");
      document.getElementById("tabVision").classList.toggle("active", tipo === "vision");
    }

    /* ===== EVENT LISTENERS PARA EL MEN√ö ===== */
    document.getElementById("btnActualizaciones").addEventListener("click", (e) => {
      e.preventDefault();
      toggleSeccion('actualizaciones');
    });

    document.getElementById("btnReportes").addEventListener("click", (e) => {
      e.preventDefault();
      toggleSeccion('reportes');
    });

    document.getElementById("btnAyuda").addEventListener("click", (e) => {
      e.preventDefault();
      toggleSeccion('ayuda');
    });

    // Event listeners para cerrar secciones
    document.getElementById("cerrarActualizaciones").addEventListener("click", () => {
      document.getElementById("actualizaciones").style.display = "none";
      document.getElementById("btnActualizaciones").classList.remove("activo");
      seccionActual = null;
    });

    document.getElementById("cerrarReportes").addEventListener("click", () => {
      document.getElementById("reportes").style.display = "none";
      document.getElementById("btnReportes").classList.remove("activo");
      seccionActual = null;
    });

    document.getElementById("cerrarAyuda").addEventListener("click", () => {
      document.getElementById("ayuda").style.display = "none";
      document.getElementById("btnAyuda").classList.remove("activo");
      seccionActual = null;
    });

    // Event listeners para Misi√≥n y Visi√≥n
    document.getElementById("tabMision").addEventListener("click", () => mostrarMV("mision"));
    document.getElementById("tabVision").addEventListener("click", () => mostrarMV("vision"));

    // Event listener para el formulario de actualizaci√≥n
    document.getElementById('formActualizacion').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const reporteId = document.getElementById('reporteIdActualizacion').value;
      const descripcion = document.getElementById('descripcionActualizacion').value;
      const estado = document.getElementById('estadoActualizacion').value;
      const tecnico = document.getElementById('tecnicoActualizacion').value;
      
      guardarActualizacion(reporteId, descripcion, estado, tecnico);
    });

    
    

    /* ===== INICIALIZACI√ìN AL CARGAR ===== */
/* ===== INICIALIZACI√ìN AL CARGAR ===== */
document.addEventListener('DOMContentLoaded', function() {
  // Configurar event listeners para el login
  document.getElementById('btnLogin').addEventListener('click', abrirFormularioLogin);
  document.getElementById('closeFormLogin').addEventListener('click', cerrarFormularioLogin);
  
  document.getElementById('formLogin').addEventListener('submit', function(e) {
    e.preventDefault();
    const usuario = document.getElementById('usuarioLogin').value;
    const password = document.getElementById('passwordLogin').value;
    
    if (iniciarSesion(usuario, password)) {
      alert('Inicio de sesi√≥n exitoso');
    } else {
      alert('Usuario o contrase√±a incorrectos');
    }
  });
  
  verificarSesionGuardada();
  actualizarInterfazAutenticacion();
  
  // Inicializar campo "otro problema"
  inicializarCampoOtroProblema();
  
  // Inicializar buscadores est√°ticos si existen
  if (document.getElementById('buscadorActualizaciones')) {
    inicializarBuscadorActualizaciones();
  }
  
  // Configurar event listeners del modal de eliminaci√≥n
  const modal = document.getElementById('modalConfirmacionEliminar');
  const btnCancelar = document.getElementById('btnCancelarEliminar');
  const btnConfirmar = document.getElementById('btnConfirmarEliminar');
  
  if (btnCancelar) {
    btnCancelar.addEventListener('click', cerrarModalEliminacion);
  }
  
  if (btnConfirmar) {
    btnConfirmar.addEventListener('click', confirmarEliminacionActualizacion);
  }
  
  // Cerrar modal al hacer clic fuera del contenido
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        cerrarModalEliminacion();
      }
    });
  }
  
  // Cerrar modal con tecla ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      cerrarModalEliminacion();
    }
  });
});
    document.addEventListener('DOMContentLoaded', function() {
      verificarSesionGuardada();
      actualizarInterfazAutenticacion();

      
      // Inicializar campo "otro problema"
      inicializarCampoOtroProblema();
      
      // Inicializar buscadores est√°ticos si existen
      if (document.getElementById('buscadorActualizaciones')) {
        inicializarBuscadorActualizaciones();
      }
    });
  </script>

  <script>
    // ===== EVENT LISTENERS CORREGIDOS =====

// Configurar modal de fotos cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
  // Event listener para cerrar el formulario de actualizaci√≥n
  const closeFormActualizacion = document.getElementById('closeFormActualizacion');
  if (closeFormActualizacion) {
    closeFormActualizacion.addEventListener('click', cerrarFormularioActualizacion);
  }
  
  // Event listener para cerrar modal de fotos
  const closeModal = document.getElementById('closeModal');
  const modal = document.getElementById('modal');
  
  if (closeModal && modal) {
    closeModal.addEventListener('click', function() {
      modal.style.display = 'none';
    });
    
    // Cerrar modal al hacer clic fuera de la imagen
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
    
    // Prevenir cierre al hacer clic en la imagen
    const modalImg = document.getElementById('modalImg');
    if (modalImg) {
      modalImg.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    }
  }
});

   // <!-- ===== SCRIPT DEL CLIMA ===== -->
    document.addEventListener("DOMContentLoaded", () => {

      const apiKey = "b9a5af336592edd3ee2224e8ef0147c3";
      const ciudad = "Tijuana,mx";
      const unidades = "metric";
      const lang = "es";

      const selectors = {
        temp: ".temp",
        estado: ".estado",
        hora: ".hora",
        iconImg: ".clima-icon-img",
        feels: ".feels",
        hum: ".hum",
        wind: ".wind",
        minmax: ".minmax",
        prevision: ".prevision"
      };

      function qs(sel){ return document.querySelector(sel); }

      /**
       * FUNCI√ìN: cargarClimaActual
       * PROP√ìSITO: Obtener y mostrar datos del clima actual
       * ENTRADA: Ninguna
       * SALIDA: Ninguna (actualiza DOM)
       */
      async function cargarClimaActual() {
        try {
          const url = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(ciudad)}&units=${unidades}&lang=${lang}&appid=${apiKey}`;
          const resp = await fetch(url);
          if (!resp.ok) throw new Error("HTTP " + resp.status);
          const data = await resp.json();

          const temp = Math.round(data.main.temp);
          const desc = (data.weather && data.weather[0] && data.weather[0].description) ? data.weather[0].description : "";
          const icon = (data.weather && data.weather[0] && data.weather[0].icon) ? data.weather[0].icon : null;
          const feels = Math.round(data.main.feels_like);
          const hum = data.main.humidity;
          const wind = data.wind && data.wind.speed ? data.wind.speed : null;
          const tempMin = Math.round(data.main.temp_min);
          const tempMax = Math.round(data.main.temp_max);

          if (qs(selectors.temp)) qs(selectors.temp).textContent = `${temp}¬∞C`;
          if (qs(selectors.estado)) qs(selectors.estado).textContent = desc;
          if (qs(selectors.hora)) qs(selectors.hora).textContent = `Actualizado ${new Date().toLocaleTimeString()}`;
          if (qs(selectors.feels)) qs(selectors.feels).textContent = `Sensaci√≥n: ${feels}¬∞C`;
          if (qs(selectors.hum)) qs(selectors.hum).textContent = `Humedad: ${hum}%`;
          if (qs(selectors.wind)) qs(selectors.wind).textContent = `Viento: ${wind ?? '--'} m/s`;
          if (qs(selectors.minmax)) qs(selectors.minmax).textContent = `Min: ${tempMin}¬∞C ‚Ä¢ Max: ${tempMax}¬∞C`;

          if (icon && qs(selectors.iconImg)) {
            qs(selectors.iconImg).src = `https://openweathermap.org/img/wn/${icon}@2x.png`;
            qs(selectors.iconImg).alt = desc;
          }
        } catch (err) {
          console.error("Error obteniendo clima actual:", err);
          if (qs(selectors.estado)) qs(selectors.estado).textContent = "No disponible";
        }
      }

      /**
       * FUNCI√ìN: cargarPronostico5dias
       * PROP√ìSITO: Obtener y mostrar pron√≥stico de 5 d√≠as
       * ENTRADA: Ninguna
       * SALIDA: Ninguna (actualiza DOM)
       */
      async function cargarPronostico5dias() {
        try {
          const url = `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(ciudad)}&units=${unidades}&lang=${lang}&appid=${apiKey}`;
          const resp = await fetch(url);
          if (!resp.ok) throw new Error("HTTP " + resp.status);
          const data = await resp.json();
          const list = data.list || [];

          // Agrupar por fecha (YYYY-MM-DD)
          const dias = {};
          list.forEach(item => {
            const date = new Date(item.dt * 1000);
            const diaKey = date.toISOString().slice(0,10);
            if (!dias[diaKey]) dias[diaKey] = [];
            dias[diaKey].push(item);
          });

          const claves = Object.keys(dias).slice(0,5); // primeros 5 d√≠as
          const cont = qs(selectors.prevision);
          if (!cont) return;
          cont.innerHTML = "";

          claves.forEach(k => {
            const entradas = dias[k];
            // obtener temp promedio o el que est√© a las 12:00 si existe
            let elegido = entradas.find(e => new Date(e.dt*1000).getHours() === 12) || entradas[Math.floor(entradas.length/2)];
            const temp = Math.round(elegido.main.temp);
            const icon = elegido.weather && elegido.weather[0] && elegido.weather[0].icon ? elegido.weather[0].icon : null;
            const diaNombre = new Date(k).toLocaleDateString(undefined, { weekday: 'short' }); // ej. "lun"

            const div = document.createElement('div');
            div.className = "dia";
            div.innerHTML = `
              <div class="dday">${diaNombre}</div>
              ${icon ? `<div><img src="https://openweathermap.org/img/wn/${icon}.png" alt="" /></div>` : ''}
              <div class="dtemp">${temp}¬∞</div>
            `;
            cont.appendChild(div);
          });

        } catch (err) {
          console.error("Error obteniendo pron√≥stico:", err);
        }
      }

      // carga inicial
      cargarClimaActual();
      cargarPronostico5dias();

      // actualiza cada 10 minutos
      setInterval(() => { cargarClimaActual(); cargarPronostico5dias(); }, 600000);
    });
    
  </script>
  <!-- ===== MODAL DE CONFIRMACI√ìN PARA ELIMINAR ACTUALIZACIONES ===== -->
<div id="modalConfirmacionEliminar" class="modal-confirmacion">
    <div class="modal-confirmacion-contenido">
        <div class="modal-confirmacion-header">
            <div class="modal-confirmacion-icono">üóëÔ∏è</div>
            <h3 style="margin: 0; font-size: 20px;">Eliminar Actualizaci√≥n</h3>
        </div>
        
        <div class="modal-confirmacion-body">
            <p style="margin: 0 0 15px 0; font-weight: 500; color: #333;">
                ¬øEst√°s seguro de que deseas eliminar esta actualizaci√≥n?
            </p>
            
            <div class="modal-confirmacion-descripcion">
                <p style="margin: 0 0 8px 0; font-weight: 600; color: #495057; font-size: 14px;">
                    Contenido a eliminar:
                </p>
                <p id="modalDescripcionActualizacion" style="margin: 0; color: #666; font-style: italic; font-size: 14px; line-height: 1.4;">
                    Cargando descripci√≥n...
                </p>
            </div>
            
            <div class="modal-confirmacion-advertencia">
                <div style="color: #856404; font-size: 16px;">‚ö†Ô∏è</div>
                <div>
                    <p style="margin: 0; color: #856404; font-size: 14px; font-weight: 600;">
                        Advertencia
                    </p>
                    <p style="margin: 5px 0 0 0; color: #856404; font-size: 13px;">
                        Esta acci√≥n no se puede deshacer. La actualizaci√≥n se eliminar√° permanentemente.
                    </p>
                </div>
            </div>
            
            <div class="modal-confirmacion-footer">
                <button id="btnCancelarEliminar" class="btn-modal-cancelar">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button id="btnConfirmarEliminar" class="btn-modal-eliminar">
                    <i class="fas fa-trash"></i> Eliminar Permanentemente
                </button>
            </div>
        </div>
    </div>
</div>
</body>
</html>
  