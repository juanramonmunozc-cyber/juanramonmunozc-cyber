<!DOCTYPE html>
<html lang="es">
<head> 
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Centro de Atenci√≥n CESPT - Quejas y Reportes</title>
  <link rel="icon" type="image/png" href="crisis.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      font-family: Arial, Helvetica, sans-serif; 
      margin:0; 
      padding:0;     
      background:#f2f2f2; 
    }
/* ==== FIX PARA EVITAR DESBORDAMIENTO HORIZONTAL ==== */
    html, body {
      width: 100% !important;
      overflow-x: hidden !important;
    }
    h1 { color:#7c002a; margin-top:18px; font-size:40px; text-align:center; font-weight:700; }
    h2 { color:#7c002a; margin-top:6px; font-size:20px; text-align:center; font-weight:500; }

    /* MENU SUPERIOR */
    .menu-superior {
      width: 100%;
      background:#6a0a24;
      padding: 12px 0;
      display: flex;
      justify-content: center;
      gap: 28px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .menu-superior a { 
      color:white; 
      font-size:18px; 
      font-weight:bold; 
      text-decoration:none; 
      cursor:pointer; 
      padding: 8px 16px;
      border-radius: 5px;
      transition: all 0.3s ease;
    }
    .menu-superior a:hover { 
      background: rgba(255,255,255,0.2);
    }
    .menu-superior a.activo {
      background: rgba(255,255,255,0.3);
      box-shadow: 0 0 10px rgba(255,255,255,0.2);
    }

    /* SECCIONES GENERALES */
    .seccion {
      max-width:900px;
      margin:18px auto;
      background:#fff;
      padding:20px;
      border-radius:10px;
      border:2px solid #7c002a;
      font-size:16px;
      position: relative;
    }
    .oculto { display:none; }

    /* BOT√ìN DE ADMINISTRADORES COMO C√çRCULO */
    #btnLogin {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: #6a0a24;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      z-index: 1005;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }

    #btnLogin:hover {
      background: #7c002a;
      transform: scale(1.1);
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }

    /* Indicador de sesi√≥n */
    #sesionInfo {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      z-index: 1005;
      font-size: 14px;
      display: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* MAPA */
    .map-box {
      width: 100%;
      padding: 30px 0;
      display:flex;
      justify-content:center;
      margin-top:20px;
      border-radius:8px;
      background: linear-gradient(90deg, #ffffff 40%, #7c002a 100%);
    }

    .map-box > #map {
      width: 90%;
      max-width: 980px;
      height: 550px;
      border-radius:12px;
      border:3px solid #7c002a;
      background: linear-gradient(180deg, #ffffff 0%, #fff 70%, rgba(124,0,42,0.06) 100%);
      box-shadow:0 6px 18px rgba(0,0,0,0.12);
    }

    /* BOT√ìN AGREGAR QUEJA */
    #btnAgregarQueja {
      position:fixed;
      bottom:20px;
      right:20px;
      padding:15px 20px;
      background:#007bff;
      color:#fff;
      border:none;
      border-radius:50px;
      cursor:pointer;
      box-shadow:0 4px 6px rgba(0,0,0,.25);
      font-size:16px;
      z-index:1003
    }

    #btnAgregarQueja:hover { background:#0056b3 }

    /* MODAL */
    #overlay {
      display:none;
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,.6);
      z-index:1002
    }

    #formContainer {
      display:none;
      position:fixed;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      background:#fff;
      padding:20px;
      border-radius:10px;
      width:400px;
      box-shadow:0 6px 18px rgba(0,0,0,.3);
      z-index:1003
    }

    #formContainer h3 { margin-top:0 }
    #formContainer label { font-weight:700; display:block; margin-top:10px }
    #formContainer select, #formContainer textarea, #formContainer input {
      width:100%; padding:8px; margin-top:6px;
      border:1px solid #ccc; border-radius:6px;
      font-size:14px;
    }

    #otroProblemaContainer {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 6px;
      border-left: 4px solid #7c002a;
    }

    #closeForm {
      position:absolute; top:8px; right:12px; cursor:pointer;
      font-weight:700; font-size:20px; color:#333;
    }
    #mapMessage {
      display:none;
      position:fixed;
      top:12px; left:50%;
      transform:translateX(-50%);
      background:#ffc107;
      color:#333;
      padding:10px 18px;
      border-radius:6px;
      z-index:1004;
      font-weight:700;
    }

    /* DETALLE REPORTE - MEJORADO */
    #detail {
      display:none;
      max-width:900px;
      margin:20px auto;
      background:#fff;
      padding:24px;
      border-radius:10px;
      border:2px solid #7c002a;
    }

    /* SISTEMA DE BADGES DE PRIORIDAD - NUEVO */
    .badge-prioridad-alta { 
        background: #dc3545; 
        color: white; 
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .badge-prioridad-media { 
        background: #ffc107; 
        color: black; 
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .badge-prioridad-baja { 
        background: #28a745; 
        color: white; 
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    /* Badge de urgencia */
    .badge-urgencia { 
        animation: pulse 2s infinite; 
        background: #ff4136; 
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    /* Estilos adicionales para la vista de detalle */
    .estado-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      text-transform: capitalize;
    }
    
    .estado-pendiente {
      background: #fff3cd;
      color: #856404;
    }
    
    .estado-aprobado {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .estado-resuelto {
      background: #d4edda;
      color: #155724;
    }

    .estado-en-proceso {
      background: #fd7e14;
      color: white;
    }
    
    .detail-field {
      margin-bottom: 10px;
    }
    
    .thumb:hover {
      border-color: #7c002a;
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Estilos para las miniaturas de fotos */
    .thumb {
      width: 120px;
      height: 120px;
      object-fit: cover;
      margin: 8px;
      cursor: pointer;
      border: 2px solid #ddd;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    /* Modal para ver foto en grande */
    #modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    #modalImg {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    #closeModal {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 40px;
      cursor: pointer;
      background: none;
      border: none;
      z-index: 10001;
    }
    #closeModal:hover {
      color: #ff6b6b;
    }

    /* Estilos para tarjetas de reportes */
    .reporte-card {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      background: #fafafa;
      transition: all 0.3s ease;
    }
    .reporte-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    .reporte-card h3 {
      margin: 0 0 5px 0;
      color: #7c002a;
    }
    .reporte-card .fecha {
      color: #666;
      font-size: 14px;
    }
    .reporte-card .descripcion {
      margin-top: 10px;
      color: #333;
    }
    .reporte-card .estado {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-top: 8px;
    }
    
    .estado-pendiente { background: #fff3cd; color: #856404; }
    .estado-aprobado { background: #d1ecf1; color: #0c5460; }
    .estado-resuelto { background: #d4edda; color: #155724; }

    /* ESTILOS PARA BUSCADORES */
    #buscadorActualizaciones, #buscadorReportes, #filtroEstado {
      transition: all 0.3s ease;
      border: 2px solid #7c002a;
    }

    #buscadorActualizaciones:focus, #buscadorReportes:focus, #filtroEstado:focus {
      outline: none;
      border-color: #ff6b9d;
      box-shadow: 0 0 0 3px rgba(124, 0, 42, 0.1);
    }

    /* CONTADOR DE RESULTADOS */
    .contador-resultados {
      margin-bottom: 15px;
      color: #666;
      font-style: italic;
      text-align: right;
      font-size: 14px;
    }

    /* MENSAJE SIN RESULTADOS */
    .sin-resultados {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
      background: #f9f9f9;
      border-radius: 8px;
      border: 2px dashed #ddd;
    }

    /* ESTILOS PARA ACTUALIZACIONES DE REPORTES */
    .actualizacion-item {
      border: 1px solid #e0e0e0;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      background: #fafafa;
      transition: all 0.3s ease;
    }

    .actualizacion-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .actualizacion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .actualizacion-titulo {
      font-weight: bold;
      color: #7c002a;
      font-size: 16px;
      margin: 0;
    }

    .actualizacion-fecha {
      color: #666;
      font-size: 12px;
    }

    .actualizacion-descripcion {
      color: #333;
      margin-bottom: 8px;
    }

    .actualizacion-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #666;
    }

    .badge-estado {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }


    .ultima-actualizacion {
      border-left: 4px solid #28a745;
      background: #f8fff8 !important;
    }

    /* Bot√≥n para agregar actualizaci√≥n */
    .btn-agregar-actualizacion {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
    }
    
    .btn-agregar-actualizacion:hover {
      background: #218838;
    }

    /* Secci√≥n Misi√≥n y Visi√≥n */
    .mision-vision {
      margin-top:25px;
      display:flex;
      align-items:flex-start;
      gap:30px;
    }

    .logo {
      text-align:center;
      width:200px;
    }

    .logo img {
      width:130px;
    }

    .tabs-container {
      flex:1;
    }

    .tabs {
      display:flex;
      margin-bottom:15px;
      border-bottom:2px solid #ddd;
    }

    .tab {
      flex:1;
      text-align:center;
      padding:10px;
      cursor:pointer;
      font-weight:bold;
      border-radius:8px 8px 0 0;
    }

    .tab.active {
      background:#6a0a24;
      color:white;
    }

    .tab-content {
      display:none;
      line-height:1.6;
      color:#333;
    }

    .tab-content.active {
      display:block;
    }

    /* Bot√≥n cerrar secciones */
    .cerrar-seccion {
      position:absolute;
      top:10px;
      right:15px;
      cursor:pointer;
      font-size:22px;
      font-weight:bold;
      color:#7c002a;
    }

    @media (max-width:700px){
      h1 { font-size:30px; }
      h2 { font-size:16px; }
      .map-box > #map { width:94%; height:500px; }
      .menu-superior { gap:14px; padding:10px 0; }
      .menu-superior a { font-size:15px; padding: 6px 12px; }
      .thumb {
        width: 100px;
        height: 100px;
        margin: 5px;
      }
      /* BUSCADORES RESPONSIVE */
      #buscadorActualizaciones, #buscadorReportes, #filtroEstado {
        font-size: 14px;
        padding: 10px;
      }
      .actualizacion-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .actualizacion-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }
      #btnLogin, #sesionInfo {
        top: 10px;
        right: 10px;
        font-size: 12px;
      }
      #btnLogin {
        width: 50px;
        height: 50px;
        font-size: 20px;
      }
      #formContainer {
        width: 90%;
        max-width: 350px;
      }
      .mision-vision {
        flex-direction: column;
        gap: 15px;
      }
      .logo {
        width: 100%;
      }
      #detailContent {
        padding: 15px;
      }
    }
      .footer-gob {
        background: #3d3c3c;
        color: white;
        padding: 40px 20px 0;
        font-family: 'Arial', sans-serif;
        width: 100%;
      }

      .footer-container {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 40px;
        max-width: 1400px;
        margin: auto;
        padding-bottom: 30px;
        width: 100%;
      }

      .footer-col {
        min-width: 180px;
        flex: 1;
      }

      .footer-col h3 {
        color: #d6c28a;
        margin-bottom: 10px;
        font-size: 17px;
      }

      .footer-col ul {
        list-style: none;
        padding: 0;
      margin: 0;
      }

      .footer-col li {
        margin-bottom: 8px;
         font-size: 14px;
      }

/* Logo */
     .logo-col {
      text-align: center;
      flex: 1.2;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .logo-col h2 {
      margin: 10px 0 0;
      font-size: 26px;
      line-height: 22px;
    }

      .logo-col .escudo {
        width: 170px;
        height: 170px;
        background-image: url("https://i.postimg.cc/0NMGTZk5/yaestodajejej.png"); 
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        margin-bottom: 10px;
      }

/* Clima */
      .clima-col .clima-box {
        border: 1px solid #ffffff30;
        padding: 12px;
        border-radius: 8px;
        background: #ffffff10;
        width: 220px;
      }

      .clima-top {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .clima-icon-img {
        width: 56px;
        height: 56px;
        display: block;
      }

      .clima-details {
        display: block;
        margin-top: 8px;
        font-size: 13px;
        color: #fff;
        opacity: 0.95;
      }

      .clima-details span {
        display: block;
        margin: 4px 0;
      }

      .prevision {
        margin-top: 10px;
        display: flex;
        gap: 8px;
        overflow-x: auto;
      }

      .prevision .dia {
        min-width: 46px;
        text-align: center;
        font-size: 12px;
        color: #fff;
        background: #ffffff15;
        padding: 6px;
        border-radius: 6px;
      }

      .prevision .dia .dtemp {
        font-weight: 700;
        display: block;
        margin-top: 6px;
      }

/* Copy */
      .footer-copy {
        width: 100vw !important;
        margin: 0 !important;
        padding: 12px;
        background: #7c002a;
        text-align: center;
        color: white;
        font-size: 14px;
        position: relative;
        left: 50%;
        right: 50%;
        transform: translateX(-50%);
      }
      
  </style>
</head>
<body>
<h1>Centro de atenci√≥n CESPT</h1>
<h2>Atenci√≥n ciudadana: Quejas, ayudas y reportes</h2>

<!-- Bot√≥n de login/sesi√≥n como c√≠rculo con icono -->
<button id="btnLogin" title="Acceso Administradores">
  <i class="fas fa-user"></i>
</button>
<div id="sesionInfo"></div>

<nav class="menu-superior">
  <a href="#actualizaciones" id="btnActualizaciones">Actualizaciones</a>
  <a href="#reportes" id="btnReportes">Reportes</a>
  <a href="#ayuda" id="btnAyuda">Ayuda</a>
</nav>

<!-- ===========================
     SECCI√ìN ACTUALIZACIONES
=========================== -->
<section id="actualizaciones" class="seccion oculto">
  <span class="cerrar-seccion" id="cerrarActualizaciones">&times;</span>
  <h2 style="margin-top:0">Actualizaciones de Reportes</h2>

  <!-- BUSCADOR ACTUALIZACIONES -->
  <div style="margin-bottom: 20px;">
    <input type="text" id="buscadorActualizaciones" placeholder="üîç Buscar en actualizaciones..." 
           style="width: calc(100% - 10px); padding: 12px; border: 2px solid #7c002a; border-radius: 8px; font-size: 16px;">
  </div>

  <div id="contenidoActualizaciones">
    <!-- Las actualizaciones se cargar√°n din√°micamente aqu√≠ -->
  </div>
</section>

<!-- ===========================
     SECCI√ìN REPORTES (LISTA)
=========================== -->
<section id="reportes" class="seccion oculto">
  <span class="cerrar-seccion" id="cerrarReportes">&times;</span>
  <h2>Reportes atendidos</h2>

  <!-- BUSCADOR REPORTES -->
  <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
    <input type="text" id="buscadorReportes" placeholder="üîç Buscar por calle, descripci√≥n o estado..." 
           style="flex: 1; min-width: 250px; padding: 12px; border: 2px solid #7c002a; border-radius: 8px; font-size: 16px;">
    
    <select id="filtroEstado" style="padding: 12px; border: 2px solid #7c002a; border-radius: 8px; font-size: 16px; min-width: 180px;">
      <option value="todos">Todos los estados</option>
      <option value="pendiente">Pendiente</option>
      <option value="aprobado">Aprobado</option>
      <option value="resuelto">Resuelto</option>
    </select>
  </div>

  <div id="listaReportes"></div>
</section>

<!-- ===========================
     SECCI√ìN AYUDA
=========================== -->
<section id="ayuda" class="seccion oculto">
  <span class="cerrar-seccion" id="cerrarAyuda">&times;</span>
  <h2>Ayuda y contacto</h2>

  <p>Si necesitas asistencia inmediata, puedes comunicarte a:</p>

  <ul>
    <li>Atenci√≥n CESPT: <strong>664-928-4421</strong></li>
    <li>Reportes de agua: <strong>664-701-1129</strong></li>
    <li>Emergencias hidr√°ulicas: <strong>664-884-9033</strong></li>
  </ul>

  <p>Correos electr√≥nicos de contacto:</p>

  <ul>
    <li>soporte@cespt-ayuda.com</li>
    <li>reportes@tij-cespt.org</li>
    <li>asistencia.usuarios@aguatj.net</li>
  </ul>

</section>

<!-- MAPA + UI -->
<div class="map-box">
  <div id="map"></div>
</div>

<!-- Secci√≥n Misi√≥n y Visi√≥n -->

<button id="btnAgregarQueja">Agregar Queja</button>
<div id="overlay"></div>
<div id="mapMessage">Haz clic en el mapa para colocar tu queja</div>

<!-- Formulario para agregar queja -->
<div id="formContainer">
  <span id="closeForm">&times;</span>
  <h3>Nuevo Reporte</h3>
  <form id="formQueja">
    <label>Tipo de problema:</label>
    <select id="tipoProblema" required>
      <option value="">-- Selecciona un problema --</option>
      <option value="Fuga de agua">üíß Fuga de agua en tuber√≠a</option>
      <option value="Falta de agua">üö∞ Falta de suministro de agua</option>
      <option value="Agua turbia">üåä Agua turbia o con sedimentos</option>
      <option value="Baja presi√≥n">üìâ Baja presi√≥n de agua</option>
      <option value="Drenaje tapado">üöΩ Drenaje tapado o colapsado</option>
      <option value="Fuga en alcantarilla">üï≥Ô∏è Fuga en alcantarilla</option>
      <option value="Contaminaci√≥n">‚ö†Ô∏è Contaminaci√≥n en fuente de agua</option>
      <option value="Medidor da√±ado">üîß Medidor de agua da√±ado</option>
      <option value="Fuga en toma domiciliaria">üè† Fuga en toma domiciliaria</option>
      <option value="Inundaci√≥n">üåßÔ∏è Inundaci√≥n por drenaje</option>
      <option value="otro">‚ùì Otro tipo de problema</option>
    </select>
    
    <!-- Campo para "Otro problema" -->
    <div id="otroProblemaContainer">
      <label>Especifica el problema:</label>
      <input type="text" id="otroProblema" placeholder="Describe el problema espec√≠fico">
    </div>
    
    <label>Descripci√≥n adicional:</label>
    <textarea id="descripcion" rows="3" placeholder="Describe con m√°s detalle el problema (opcional)"></textarea>
    
    <button type="submit">Enviar Reporte</button>
  </form>
</div>

<!-- Formulario para agregar actualizaci√≥n -->
<div id="formActualizacionContainer" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; border-radius:10px; width:360px; box-shadow:0 6px 18px rgba(0,0,0,.3); z-index:1003">
  <span id="closeFormActualizacion" style="position:absolute; top:8px; right:12px; cursor:pointer; font-weight:700; font-size:20px; color:#333;">&times;</span>
  <h3>Agregar Actualizaci√≥n</h3>
  <form id="formActualizacion">
    <input type="hidden" id="reporteIdActualizacion">
    <label>Descripci√≥n del avance:</label>
    <p><textarea id="descripcionActualizacion" rows="4" placeholder="Describe el avance del reporte..." required></textarea></p>
    <label>Estado:</label>
    <select id="estadoActualizacion" required>
      <option value="aprobado">aprobado</option>
      <option value="resuelto">resuelto</option>
    </select>
    <p><label>T√©cnico asignado:</label></p>
    <p><input type="text" id="tecnicoActualizacion" placeholder="Nombre del t√©cnico"><p></p>
    <button type="submit" style="margin-top:15px;">Guardar Actualizaci√≥n</button>
  </form>
</div>

<!-- Formulario de login -->
<div id="formLoginContainer" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; border-radius:10px; width:300px; box-shadow:0 6px 18px rgba(0,0,0,.3); z-index:1003">
  <span id="closeFormLogin" style="position:absolute; top:8px; right:12px; cursor:pointer; font-weight:700; font-size:20px; color:#333;">&times;</span>
  <h3>Acceso Administradores</h3>
  <form id="formLogin">
    <label>Usuario:</label>
    <input type="text" id="usuarioLogin" placeholder="Usuario" required>
    <label>Contrase√±a:</label>
    <input type="password" id="passwordLogin" placeholder="Contrase√±a" required>
    <button type="submit" style="margin-top:15px;">Iniciar Sesi√≥n</button>
  </form>
</div>

<!-- VISTA DETALLE MEJORADA (se muestra cuando hay ?id=...) -->
<div id="detail">
  <div style="display: flex; align-items: center; margin-bottom: 20px;">
    <a class="back" id="backToMap" href="#" style="display: inline-flex; align-items: center; text-decoration: none; color: #7c002a; font-weight: bold; margin-right: 20px;">
      <i class="fas fa-arrow-left" style="margin-right: 8px;"></i> Volver al mapa
    </a>
    <h1 style="margin: 0; color: #7c002a; text-align: center; flex: 1; padding: 0 20px;">
    Detalle del Reporte
  </h1>
  </div>

  <div id="detailContent" style="background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #ddd;">
    <!-- Informaci√≥n b√°sica del reporte -->
    <div style="margin-bottom: 25px;">
      <h2 id="detailStreet" style="margin-top: 0; color: #333; border-bottom: 2px solid #7c002a; padding-bottom: 10px;">
        Calle ...
        <div id="detailBadges" style="margin-top: 10px;"></div>
      </h2>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div class="detail-field">
          <strong>Estado:</strong> 
          <span id="detailEstado" class="estado-badge estado-pendiente">Cargando...</span>
        </div>
        <div class="detail-field">
          <strong>D√≠as transcurridos:</strong> 
          <span id="detailDias">0 d√≠as</span>
        </div>
        <div class="detail-field">
          <strong>Fecha de reporte:</strong> 
          <span id="detailFecha">--</span>
        </div>
      </div>
      
      <div class="detail-field" style="margin-bottom: 15px;">
        <strong>Descripci√≥n:</strong> 
        <div id="detailDescription" style="background: white; padding: 12px; border-radius: 6px; margin-top: 5px; border-left: 4px solid #7c002a;">
          Cargando descripci√≥n...
        </div>
      </div>
    </div>

    <!-- Galer√≠a de fotos -->
    <div style="margin-bottom: 25px;">
      <h3 style="color: #7c002a; margin-bottom: 15px;">
        <i class="fas fa-camera" style="margin-right: 8px;"></i>Fotos del Reporte
      </h3>
      <div id="detailPhotos" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start;">
        <div style="color:#666; padding: 20px; text-align: center; width: 100%;">
          Cargando fotos...
        </div>
      </div>
    </div>

    <!-- Historial de actualizaciones -->
    <div style="margin-bottom: 25px;">
      <h3 style="color: #7c002a; margin-bottom: 15px;">
        <i class="fas fa-history" style="margin-right: 8px;"></i>Historial de Actualizaciones
      </h3>
      <div id="detailActualizaciones" style="max-height: 300px; overflow-y: auto; padding-right: 10px;">
        <div style="color:#666; padding: 20px; text-align: center;">
          Cargando actualizaciones...
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para ver fotos en grande -->
<div id="modal">
  <button id="closeModal">&times;</button>
  <img id="modalImg" src="" alt="Foto del reporte">
</div>

<div class="seccion mision-vision">
  <!-- Columna izquierda (Logo + T√≠tulo) -->
  <div class="logo">
    <img src="https://i.postimg.cc/MZNxy32H/AGUAA.png" alt="Logo CESPT">
    <h2 style="color:#7c002a; margin-top:10px;">Centro de atenci√≥n</h2>
  </div>

  <!-- Columna derecha (Tabs y contenido) -->
  <div class="tabs-container">
    <!-- Tabs -->
    <div class="tabs">
      <div id="tabMision" class="tab active">Misi√≥n</div>
      <div id="tabVision" class="tab">Visi√≥n</div>
    </div>

    <!-- Contenidos -->
    <div id="mision" class="tab-content active">
      Nuestra misi√≥n es facilitar a los habitantes de Tijuana un sistema √°gil,
       transparente y f√°cil de usar para reportar fugas de agua,
        postes ca√≠dos, fallas en el alumbrado y otras incidencias urbanas.
         Trabajamos para canalizar cada reporte a las dependencias correspondientes,
          monitorear su atenci√≥n y brindar informaci√≥n clara al ciudadano,
           contribuyendo as√≠ a una ciudad m√°s ordenada, funcional y segura.
    </div>

    <div id="vision" class="tab-content">
      Ser la plataforma l√≠der en Tijuana para el reporte y atenci√≥n de incidencias urbanas,
       promoviendo una ciudad m√°s segura,
        eficiente y sustentable mediante tecnolog√≠a accesible y una participaci√≥n ciudadana activa.
         Aspiramos a convertirnos en el puente confiable entre la comunidad y las autoridades,
          impulsando soluciones r√°pidas que mejoren la calidad de vida de todos los tijuanenses.
    </div>
  </div>
</div>
<section id="recomendaciones" class="seccion"
style="position:relative; max-width:1000px; margin:40px auto; background:#fff;
padding:30px; border-radius:10px; border:2px solid #ddd;">

  <!-- T√çTULO  -->
  <div style="display:flex; align-items:center; margin-bottom:25px;">
    <!-- Barra lateral gobiernojejej -->
    <div style="width:12px; height:45px; background:#7c002a; border-radius:3px; margin-right:15px;"></div>

    <h2 style="margin:0; font-size:32px; font-weight:700; color:#333;">
      Recomendaciones en caso de:
    </h2>
  </div>

  <!-- GRID DE TARJETAS -->
  <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr)); gap:20px;">

    <!-- 1 -->
    <div style="border:1px solid #ddd; padding:20px; border-radius:10px; background:#fafafa;">
      <h3 style="margin-top:0; color:#7c002a;">Fuga de Agua</h3>
      <p style="margin:0;">
        ‚Ä¢ Cierra la llave de paso principal.<br>
        ‚Ä¢ Evita usar dispositivos el√©ctricos cerca.<br>
        ‚Ä¢ Reporta inmediatamente al √°rea correspondiente.<br>
        ‚Ä¢ Si el agua es turbia o huele mal, no la utilises.
      </p>
    </div>

    <!--  2 -->
    <div style="border:1px solid #ddd; padding:20px; border-radius:10px; background:#fafafa;">
      <h3 style="margin-top:0; color:#7c002a;">Poste Ca√≠do</h3>
      <p style="margin:0;">
        ‚Ä¢ No te acerques ni toques cables sueltos.<br>
        ‚Ä¢ Mant√©n alejadas a otras personas.<br>
        ‚Ä¢ Reporta de inmediato a emergencias o a la compa√±√≠a de energ√≠a.<br>
        ‚Ä¢ No intentes mover el poste.
      </p>
    </div>

    <!-- 3 -->
    <div style="border:1px solid #ddd; padding:20px; border-radius:10px; background:#fafafa;">
      <h3 style="margin-top:0; color:#7c002a;">Fallas de Luz</h3>
      <p style="margin:0;">
        ‚Ä¢ Verifica si solo tu casa est√° afectada.<br>
        ‚Ä¢ No manipules el medidor.<br>
        ‚Ä¢ Desconecta aparatos sensibles.<br>
        ‚Ä¢ Reporta el fallo si persiste.
      </p>
    </div>

    <!-- 4 -->
    <div style="border:1px solid #ddd; padding:20px; border-radius:10px; background:#fafafa;">
      <h3 style="margin-top:0; color:#7c002a;">Olor a Gas</h3>
      <p style="margin:0;">
        ‚Ä¢ No prendas luces ni aparatos el√©ctricos.<br>
        ‚Ä¢ Ventila abriendo puertas y ventanas.<br>
        ‚Ä¢ Cierra la llave del tanque si es seguro hacerlo.<br>
        ‚Ä¢ Desaloja si el olor es fuerte y reporta.
      </p>
    </div>

    <!--  5  -->
    <div style="border:1px solid #ddd; padding:20px; border-radius:10px; background:#fafafa;">
      <h3 style="margin-top:0; color:#7c002a;">Alcantarilla Tapada</h3>
      <p style="margin:0;">
        ‚Ä¢ Evita destapar por tu cuenta.<br>
        ‚Ä¢ No arrojes objetos o basura.<br>
        ‚Ä¢ Reporta de inmediato para evitar inundaciones.<br>
        ‚Ä¢ Mant√©n a ni√±os alejados del √°rea.
      </p>
    </div>

    <!--  6  -->
    <div style="border:1px solid #ddd; padding:20px; border-radius:10px; background:#fafafa;">
      <h3 style="margin-top:0; color:#7c002a;">Incendio Cercano</h3>
      <p style="margin:0;">
        ‚Ä¢ Mant√©n la calma y evacua la zona.<br>
        ‚Ä¢ No intentes apagarlo si es grande.<br>
        ‚Ä¢ Llama inmediatamente al 911.<br>
        ‚Ä¢ Evita inhalar humo o acercarte.
      </p>
    </div>

  </div>
</section>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-database-compat.js"></script>

<script>
/* ---------- Config Firebase --------- */
const firebaseConfig = {
  apiKey: "AIzaSyBKBEacMSzpEjh2Pd2zX-ij6EsDMxcb84M",
  authDomain: "mapa-de-quejas-e5354.firebaseapp.com",
  databaseURL: "https://mapa-de-quejas-e5354-default-rtdb.firebaseio.com",
  projectId: "mapa-de-quejas-e5354",
  storageBucket: "mapa-de-quejas-e5354.appspot.com",
  messagingSenderId: "1098104212670",
  appId: "1:1098104212670:web:fa91e20fb729dcd8be22ef",
  measurementId: "G-XJ015E8YWX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------- Sistema de Autenticaci√≥n ---------- */
let usuarioAutenticado = false;
let mapa = null;
let marcadores = {};

const usuariosAutorizados = {
  "Ramon": "trebol",
  "Nicole": "jeje",
  "tecnico2": "tecnico456"
};

/* ---------- Variables globales para el estado del men√∫ ---------- */
let seccionActual = null;

/* ---------- Helpers (reutilizables) ---------- */
function escapeHtml(str){
  if (str === null || str === undefined) return '';
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

function roundCoord(num){ return Math.round(Number(num) * 1000) / 1000; }

function createIcon(color) {
  return L.icon({
    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });
}

function getMarkerColor(count) {
  if (count >= 5) return 'red';
  if (count >= 3) return 'orange';
  return 'blue';
}

// Funci√≥n para calcular d√≠as transcurridos en UTC
function calcularDiasUTC(fechaCreacionMs) {
  const fechaCreacion = new Date(fechaCreacionMs);
  const hoy = new Date();

  const fechaCreacionUTC = Date.UTC(fechaCreacion.getUTCFullYear(), fechaCreacion.getUTCMonth(), fechaCreacion.getUTCDate());
  const hoyUTC = Date.UTC(hoy.getUTCFullYear(), hoy.getUTCMonth(), hoy.getUTCDate());

  const diffMs = hoyUTC - fechaCreacionUTC;
  const dias = Math.round(diffMs / (1000 * 60 * 60 * 24));
  return dias;
}

// Funci√≥n mejorada: Determinar color y parpadeo basado en d√≠as y agrupamiento
function determinarColorYParpadeo(dias, count) {
  let color = 'blue';
  let parpadeo = false;
  
  // Sistema de d√≠as tiene prioridad
  if (dias >= 14) {
    color = 'red';
    parpadeo = true;
  } else if (dias >= 7) {
    color = 'orange';
  } else {
    // Si no cumple d√≠as, usar sistema de agrupamiento
    color = getMarkerColor(count);
  }
  
  return { color, parpadeo };
}

/* ---------- SISTEMA DE PRIORIDADES - NUEVO ---------- */
function calcularPrioridad(reporte) {
    const dias = calcularDiasUTC(reporte.fechaCreacion);
    const tipo = reporte.description || '';
    
    // Prioridad por tipo de problema
    const prioridadesPorTipo = {
        'Fuga de agua': 3,
        'Inundaci√≥n': 3,
        'Contaminaci√≥n': 3,
        'Falta de agua': 2,
        'Agua turbia': 2,
        'Baja presi√≥n': 1,
        'Drenaje tapado': 2,
        'Medidor da√±ado': 1
    };
    
    let prioridad = 1; // Por defecto baja
    
    // Buscar coincidencia en el tipo de problema
    for (const [key, value] of Object.entries(prioridadesPorTipo)) {
        if (tipo.includes(key)) {
            prioridad = value;
            break;
        }
    }
    
    // Aumentar prioridad seg√∫n d√≠as transcurridos
    if (dias > 7) prioridad = Math.min(prioridad + 1, 3);
    if (dias > 14) prioridad = 3; // M√°xima prioridad
    
    return prioridad;
}

function obtenerBadgePrioridad(prioridad) {
    switch(prioridad) {
        case 3:
            return '<span class="badge-prioridad-alta"><i class="fas fa-exclamation-triangle"></i> ALTA</span>';
        case 2:
            return '<span class="badge-prioridad-media"><i class="fas fa-exclamation-circle"></i> MEDIA</span>';
        default:
            return '<span class="badge-prioridad-baja"><i class="fas fa-info-circle"></i> BAJA</span>';
    }
}

function obtenerBadgeUrgencia(dias) {
    if (dias >= 14) {
        return '<span class="badge-urgencia"><i class="fas fa-bell"></i> URGENTE</span>';
    }
    return '';
}

// Funci√≥n para mostrar fotos en modal
function mostrarImagen(src) {
  document.getElementById("modalImg").src = src;
  document.getElementById("modal").style.display = "flex";
}

// Cerrar modal al hacer clic en la X
document.getElementById("closeModal").addEventListener("click", function() {
  document.getElementById("modal").style.display = "none";
});

// Cerrar modal al hacer clic fuera de la imagen
document.getElementById("modal").addEventListener("click", function(e) {
  if (e.target.id === "modal") {
    document.getElementById("modal").style.display = "none";
  }
});

/* ---------- FUNCIONALIDAD PARA "OTRO PROBLEMA" ---------- */
function inicializarCampoOtroProblema() {
  const tipoProblemaSelect = document.getElementById('tipoProblema');
  const otroProblemaContainer = document.getElementById('otroProblemaContainer');
  const otroProblemaInput = document.getElementById('otroProblema');
  
  tipoProblemaSelect.addEventListener('change', function() {
    if (this.value === 'otro') {
      otroProblemaContainer.style.display = 'block';
      otroProblemaInput.required = true;
    } else {
      otroProblemaContainer.style.display = 'none';
      otroProblemaInput.required = false;
      otroProblemaInput.value = '';
    }
  });
}

/* ---------- SISTEMA DE AUTENTICACI√ìN ---------- */

function iniciarSesion(usuario, password) {
  if (usuariosAutorizados[usuario] && usuariosAutorizados[usuario] === password) {
    usuarioAutenticado = true;
    localStorage.setItem('cespt_usuario', usuario);
    actualizarInterfazAutenticacion();
    cerrarFormularioLogin();
    return true;
  }
  return false;
}

function cerrarSesion() {
  usuarioAutenticado = false;
  localStorage.removeItem('cespt_usuario');
  actualizarInterfazAutenticacion();
}

function verificarSesionGuardada() {
  const usuarioGuardado = localStorage.getItem('cespt_usuario');
  if (usuariosAutorizados[usuarioGuardado]) {
    usuarioAutenticado = true;
    actualizarInterfazAutenticacion();
  }
}

function actualizarInterfazAutenticacion() {
  const btnLogin = document.getElementById('btnLogin');
  const sesionInfo = document.getElementById('sesionInfo');
  
  if (usuarioAutenticado) {
    const usuario = localStorage.getItem('cespt_usuario');
    btnLogin.style.display = 'none';
    sesionInfo.style.display = 'block';
    sesionInfo.innerHTML = `Conectado como: ${usuario} <button onclick="cerrarSesion()" style="margin-left:10px; background:#dc3545; color:white; border:none; border-radius:3px; padding:2px 6px; cursor:pointer;">Cerrar</button>`;
    
    // Mostrar botones de actualizaci√≥n
    document.querySelectorAll('.btn-agregar-actualizacion').forEach(btn => {
      btn.style.display = 'inline-block';
    });
    
    // ACTUALIZAR POPUPS DEL MAPA - ESTA L√çNEA ES CR√çTICA
    actualizarPopupsMapa();
  } else {
    btnLogin.style.display = 'block';
    sesionInfo.style.display = 'none';
    
    // Ocultar botones de actualizaci√≥n
    document.querySelectorAll('.btn-agregar-actualizacion').forEach(btn => {
      btn.style.display = 'none';
    });
    
    // ACTUALIZAR POPUPS DEL MAPA - ESTA L√çNEA ES CR√çTICA
    actualizarPopupsMapa();
  }
}

function actualizarPopupsMapa() {
  if (!mapa) return;
  
  Object.keys(marcadores).forEach(key => {
    const marker = marcadores[key];
    const popup = marker.getPopup();
    if (popup) {
      let content = popup.getContent();
      
      // Buscar y reemplazar el bot√≥n de actualizaci√≥n
      const botonActualizacionRegex = /<button class="btn-agregar-actualizacion"[^>]*>.*?<\/button>/gi;
      
      if (usuarioAutenticado) {
        // Si el usuario est√° autenticado, agregar/actualizar el bot√≥n
        if (content.includes('btn-agregar-actualizacion')) {
          // Reemplazar el bot√≥n existente
          content = content.replace(botonActualizacionRegex, 
            `<button class="btn-agregar-actualizacion" onclick="abrirFormularioActualizacion('${key}')">Agregar Actualizaci√≥n</button>`);
        } else {
          // Agregar el bot√≥n si no existe
          // Buscar donde insertarlo (despu√©s del enlace "Ver m√°s")
          const verMasIndex = content.indexOf('</a></div>');
          if (verMasIndex !== -1) {
            const before = content.substring(0, verMasIndex + 10); // +10 para incluir </a></div>
            const after = content.substring(verMasIndex + 10);
            content = before + 
              `<div style="margin-top:8px">
                <button class="btn-agregar-actualizacion" onclick="abrirFormularioActualizacion('${key}')">Agregar Actualizaci√≥n</button>
              </div>` + 
              after;
          }
        }
      } else {
        // Si el usuario NO est√° autenticado, eliminar el bot√≥n
        content = content.replace(botonActualizacionRegex, '');
      }
      
      marker.setPopupContent(content);
    }
  });
}

function abrirFormularioLogin() {
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('formLoginContainer').style.display = 'block';
}

function cerrarFormularioLogin() {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('formLoginContainer').style.display = 'none';
  document.getElementById('formLogin').reset();
}

// Event listeners para autenticaci√≥n
document.getElementById('btnLogin').addEventListener('click', abrirFormularioLogin);
document.getElementById('closeFormLogin').addEventListener('click', cerrarFormularioLogin);

document.getElementById('formLogin').addEventListener('submit', function(e) {
  e.preventDefault();
  const usuario = document.getElementById('usuarioLogin').value;
  const password = document.getElementById('passwordLogin').value;
  
  if (iniciarSesion(usuario, password)) {
    alert('Inicio de sesi√≥n exitoso');
  } else {
    alert('Usuario o contrase√±a incorrectos');
  }
});

/* ---------- SISTEMA DE ACTUALIZACIONES MEJORADO ---------- */

// CARGAR ACTUALIZACIONES DE REPORTES
function cargarActualizacionesReportes() {
  const contenedor = document.getElementById('contenidoActualizaciones');
  contenedor.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Cargando actualizaciones...</div>';

  db.ref('reportes').once('value').then(snapshot => {
    const reportesConActualizaciones = [];
    
    snapshot.forEach(child => {
      const data = child.val();
      if (!data) return;
      
      // Solo mostrar reportes que tienen actualizaciones
      if (data.actualizaciones && Object.keys(data.actualizaciones).length > 0) {
        reportesConActualizaciones.push({
          id: child.key,
          data: data
        });
      }
    });

    if (reportesConActualizaciones.length === 0) {
      contenedor.innerHTML = `
        <div class="sin-resultados">
          <div style="font-size: 48px; margin-bottom: 10px;">üìã</div>
          <h3 style="color: #666; margin-bottom: 10px;">No hay actualizaciones disponibles</h3>
          <p>Los reportes aparecer√°n aqu√≠ cuando tengan actualizaciones del equipo t√©cnico</p>
        </div>
      `;
      return;
    }

    // Ordenar reportes por fecha de √∫ltima actualizaci√≥n (m√°s reciente primero)
    reportesConActualizaciones.sort((a, b) => {
      const ultimaActualizacionA = obtenerUltimaActualizacion(a.data.actualizaciones);
      const ultimaActualizacionB = obtenerUltimaActualizacion(b.data.actualizaciones);
      return (ultimaActualizacionB?.fecha || 0) - (ultimaActualizacionA?.fecha || 0);
    });

    mostrarActualizacionesEnLista(reportesConActualizaciones, contenedor);
    
  }).catch(err => {
    console.error('Error cargando actualizaciones:', err);
    contenedor.innerHTML = '<div class="sin-resultados"><p style="color:#666;">Error cargando actualizaciones.</p></div>';
  });
}

// FUNCI√ìN PARA OBTENER LA √öLTIMA ACTUALIZACI√ìN
function obtenerUltimaActualizacion(actualizaciones) {
  if (!actualizaciones) return null;
  
  const actualizacionesArray = Object.values(actualizaciones);
  if (actualizacionesArray.length === 0) return null;
  
  // Ordenar por fecha (m√°s reciente primero)
  actualizacionesArray.sort((a, b) => b.fecha - a.fecha);
  
  return actualizacionesArray[0];
}

// FUNCI√ìN PARA MOSTRAR ACTUALIZACIONES EN LISTA
function mostrarActualizacionesEnLista(reportes, contenedor) {
  let html = '';
  
  reportes.forEach(reporte => {
    const data = reporte.data;
    const actualizacionesArray = Object.values(data.actualizaciones || {});
    
    // Ordenar actualizaciones por fecha (m√°s reciente primero)
    actualizacionesArray.sort((a, b) => b.fecha - a.fecha);
    
    const ultimaActualizacion = actualizacionesArray[0];
    const totalActualizaciones = actualizacionesArray.length;
    const diasPasados = calcularDiasUTC(data.fechaCreacion);
    const prioridad = calcularPrioridad(data);
    
    html += `
      <div class="actualizacion-item ${ultimaActualizacion ? 'ultima-actualizacion' : ''}">
        <div class="actualizacion-header">
          <div style="display: flex; align-items: center; gap: 10px;">
            <div class="actualizacion-titulo">
              üìç ${escapeHtml(data.street || 'Ubicaci√≥n desconocida')}
            </div>
            ${obtenerBadgePrioridad(prioridad)}
            ${obtenerBadgeUrgencia(diasPasados)}
          </div>
          <div class="actualizacion-fecha">
            ${new Date(ultimaActualizacion.fecha).toLocaleDateString('es-MX')}
          </div>
        </div>
        
        <div class="actualizacion-descripcion">
          <strong>Reporte original:</strong> ${escapeHtml(data.description || 'Sin descripci√≥n')}
        </div>
        
        ${actualizacionesArray.map((actualizacion, index) => `
          <div style="
            margin-bottom: ${index < actualizacionesArray.length - 1 ? '10px' : '0'}; 
            padding: ${index === 0 ? '0' : '10px 0'};
            ${index > 0 ? 'border-top: 1px dashed #ddd;' : ''}
          ">
            <div style="font-weight: bold; color: #7c002a; margin-bottom: 5px;">
              Actualizaci√≥n
            </div>
            <div style="color: #333; margin-bottom: 5px;">
              ${actualizacion.descripcion || 'Sin descripci√≥n adicional'}
            </div>
            <div class="actualizacion-meta">
              <span>${new Date(actualizacion.fecha).toLocaleString('es-MX')}</span>
              ${actualizacion.estado ? `
                <span class="badge-estado estado-${actualizacion.estado}">
                  ${actualizacion.estado}
                </span>
              ` : ''}
              ${actualizacion.tecnico ? `<span>T√©cnico: ${actualizacion.tecnico}</span>` : ''}
              ${actualizacion.usuario ? `<span>Por: ${actualizacion.usuario}</span>` : ''}
            </div>
          </div>
        `).join('')}
        
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
          <div class="actualizacion-meta">
            <span>üìä ${totalActualizaciones} actualizacion${totalActualizaciones !== 1 ? 'es' : ''}</span>
            <a href="?id=${reporte.id}" style="color: #0056b3; text-decoration: underline;">
              Ver reporte completo
            </a>
          </div>
        </div>
      </div>
    `;
  });
  
  // Agregar contador
  const contador = document.createElement('div');
  contador.className = 'contador-resultados';
  contador.textContent = `${reportes.length} reportes con actualizaciones`;
  
  contenedor.innerHTML = '';
  contenedor.appendChild(contador);
  contenedor.insertAdjacentHTML('beforeend', html);
}

/* ---------- SISTEMA PARA AGREGAR ACTUALIZACIONES ---------- */

// Funci√≥n para abrir el formulario de actualizaci√≥n
function abrirFormularioActualizacion(reporteId) {
  if (!usuarioAutenticado) {
    alert('Solo el personal autorizado puede agregar actualizaciones. Por favor, inicie sesi√≥n.');
    abrirFormularioLogin();
    return;
  }
  
  document.getElementById('reporteIdActualizacion').value = reporteId;
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('formActualizacionContainer').style.display = 'block';
}

// Funci√≥n para cerrar el formulario de actualizaci√≥n
function cerrarFormularioActualizacion() {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('formActualizacionContainer').style.display = 'none';
  document.getElementById('formActualizacion').reset();
}

// Funci√≥n para guardar una actualizaci√≥n
function guardarActualizacion(reporteId, descripcion, estado, tecnico) {
  if (!usuarioAutenticado) {
    alert('Error de autenticaci√≥n. Por favor, inicie sesi√≥n nuevamente.');
    return;
  }
  
  const nuevaActualizacion = {
    titulo: "Actualizaci√≥n", // Siempre ser√° "Actualizaci√≥n"
    descripcion: descripcion,
    estado: estado,
    tecnico: tecnico || '',
    fecha: Date.now(),
    usuario: localStorage.getItem('cespt_usuario')
  };
  
  // Obtener referencia al reporte
  const reporteRef = db.ref('reportes/' + reporteId);
  
  // Obtener el reporte actual para actualizar el estado
  reporteRef.once('value').then(snapshot => {
    const reporte = snapshot.val();
    const actualizaciones = reporte.actualizaciones || {};
    
    // Agregar la nueva actualizaci√≥n
    const nuevaKey = db.ref().child('actualizaciones').push().key;
    actualizaciones[nuevaKey] = nuevaActualizacion;
    
    // Actualizar el reporte con la nueva actualizaci√≥n y el nuevo estado
    reporteRef.update({
      actualizaciones: actualizaciones,
      status: estado  // Actualizar el estado principal del reporte
    }).then(() => {
      alert('Actualizaci√≥n guardada correctamente');
      cerrarFormularioActualizacion();
      
      // Recargar las actualizaciones si estamos en esa secci√≥n
      if (seccionActual === 'actualizaciones') {
        cargarActualizacionesReportes();
      }
      
      // Actualizar el marcador en el mapa si existe
      if (marcadores[reporteId]) {
        actualizarMarcadorEnMapa(reporteId, estado);
      }
    }).catch(error => {
      console.error('Error al guardar la actualizaci√≥n:', error);
      alert('Error al guardar la actualizaci√≥n');
    });
  });
}

// Funci√≥n para actualizar el marcador en el mapa
function actualizarMarcadorEnMapa(reporteId, nuevoEstado) {
  if (marcadores[reporteId] && mapa) {
    // Aqu√≠ puedes cambiar el icono del marcador seg√∫n el estado
    let color = 'blue';
    if (nuevoEstado === 'pendiente') color = 'blue';
    if (nuevoEstado === 'aprobado') color = 'orange';
    if (nuevoEstado === 'resuelto') color = 'green';
    
    const nuevoIcono = createIcon(color);
    marcadores[reporteId].setIcon(nuevoIcono);
  }
}

// Event listener para el formulario de actualizaci√≥n
document.getElementById('formActualizacion').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const reporteId = document.getElementById('reporteIdActualizacion').value;
  const descripcion = document.getElementById('descripcionActualizacion').value;
  const estado = document.getElementById('estadoActualizacion').value;
  const tecnico = document.getElementById('tecnicoActualizacion').value;
  
  guardarActualizacion(reporteId, descripcion, estado, tecnico);
});

// Event listener para cerrar el formulario de actualizaci√≥n
document.getElementById('closeFormActualizacion').addEventListener('click', cerrarFormularioActualizacion);

/* ---------- FUNCIONALIDAD DE BUSCADORES ---------- */

// BUSCADOR DE ACTUALIZACIONES
function inicializarBuscadorActualizaciones() {
  const buscador = document.getElementById('buscadorActualizaciones');
  
  buscador.addEventListener('input', function() {
    const textoBusqueda = this.value.toLowerCase().trim();
    const items = document.querySelectorAll('.actualizacion-item');
    let itemsVisibles = 0;
    
    items.forEach(item => {
      const textoCompleto = item.textContent.toLowerCase();
      const coincide = textoBusqueda === '' || textoCompleto.includes(textoBusqueda);
      
      if (coincide) {
        item.style.display = 'block';
        itemsVisibles++;
        
        // Resaltar texto coincidente
        resaltarTexto(item, textoBusqueda);
      } else {
        item.style.display = 'none';
      }
    });
    
    // Actualizar contador
    const contador = document.querySelector('#contenidoActualizaciones .contador-resultados');
    if (contador) {
      contador.textContent = `${itemsVisibles} reportes con actualizaciones encontrados`;
    }
    
    // Mostrar mensaje si no hay resultados
    if (itemsVisibles === 0 && textoBusqueda !== '') {
      const contenedor = document.getElementById('contenidoActualizaciones');
      const mensajeExistente = contenedor.querySelector('.sin-resultados');
      if (!mensajeExistente) {
        const mensaje = document.createElement('div');
        mensaje.className = 'sin-resultados';
        mensaje.innerHTML = `
          <div style="font-size: 48px; margin-bottom: 10px;">üîç</div>
          <h3 style="color: #666; margin-bottom: 10px;">No se encontraron actualizaciones</h3>
          <p>Intenta con otros t√©rminos de b√∫squeda</p>
        `;
        contenedor.appendChild(mensaje);
      }
    } else {
      const mensajeExistente = document.querySelector('#contenidoActualizaciones .sin-resultados');
      if (mensajeExistente) {
        mensajeExistente.remove();
      }
    }
  });
}

// BUSCADOR DE REPORTES
function inicializarBuscadorReportes() {
  const buscador = document.getElementById('buscadorReportes');
  const filtroEstado = document.getElementById('filtroEstado');
  
  function filtrarReportes() {
    const textoBusqueda = buscador.value.toLowerCase().trim();
    const estadoSeleccionado = filtroEstado.value;
    const tarjetas = document.querySelectorAll('.reporte-card');
    let tarjetasVisibles = 0;
    
    tarjetas.forEach(tarjeta => {
      const textoCompleto = tarjeta.textContent.toLowerCase();
      const estadoTarjeta = tarjeta.querySelector('.estado').textContent.toLowerCase();
      
      const coincideTexto = textoBusqueda === '' || textoCompleto.includes(textoBusqueda);
      const coincideEstado = estadoSeleccionado === 'todos' || estadoTarjeta === estadoSeleccionado;
      
      if (coincideTexto && coincideEstado) {
        tarjeta.style.display = 'block';
        tarjetasVisibles++;
        
        // Resaltar texto coincidente
        resaltarTexto(tarjeta, textoBusqueda);
      } else {
        tarjeta.style.display = 'none';
      }
    });
    
    // Mostrar mensaje si no hay resultados
    mostrarMensajeSinResultados('reportes', tarjetasVisibles);
  }
  
  buscador.addEventListener('input', filtrarReportes);
  filtroEstado.addEventListener('change', filtrarReportes);
}

// FUNCI√ìN PARA RESALTAR TEXTO
function resaltarTexto(elemento, textoBusqueda) {
  if (!textoBusqueda) return;
  
  const elementosTexto = elemento.querySelectorAll('h3, .descripcion, .fecha, p, .actualizacion-titulo, .actualizacion-descripcion');
  elementosTexto.forEach(el => {
    const textoOriginal = el.textContent;
    const regex = new RegExp(`(${textoBusqueda})`, 'gi');
    const textoResaltado = textoOriginal.replace(regex, '<mark style="background: #ffeb3b; padding: 2px 4px; border-radius: 3px;">$1</mark>');
    el.innerHTML = textoResaltado;
  });
}

// FUNCI√ìN PARA MOSTRAR MENSAJES SIN RESULTADOS
function mostrarMensajeSinResultados(seccion, cantidadVisibles) {
  let contenedor, tipo;
  
  if (seccion === 'actualizaciones') {
    contenedor = document.getElementById('contenidoActualizaciones');
    tipo = 'actualizaciones';
  } else {
    contenedor = document.getElementById('listaReportes');
    tipo = 'reportes';
  }
  
  // Remover mensaje anterior si existe
  const mensajeAnterior = contenedor.querySelector('.sin-resultados');
  if (mensajeAnterior) {
    mensajeAnterior.remove();
  }
  
  // Remover contador anterior si existe
  const contadorAnterior = contenedor.querySelector('.contador-resultados');
  if (contadorAnterior) {
    contadorAnterior.remove();
  }
  
  // Agregar contador de resultados
  const contador = document.createElement('div');
  contador.className = 'contador-resultados';
  contador.textContent = `${cantidadVisibles} ${tipo} encontrados`;
  if (contenedor.firstChild) {
    contenedor.insertBefore(contador, contenedor.firstChild);
  } else {
    contenedor.appendChild(contador);
  }
  
  // Mostrar mensaje si no hay resultados
  if (cantidadVisibles === 0) {
    const mensaje = document.createElement('div');
    mensaje.className = 'sin-resultados';
    mensaje.innerHTML = `
      <div style="font-size: 48px; margin-bottom: 10px;">üîç</div>
      <h3 style="color: #666; margin-bottom: 10px;">No se encontraron ${tipo}</h3>
      <p>Intenta con otros t√©rminos de b√∫squeda</p>
    `;
    contenedor.appendChild(mensaje);
  }
}

/* ---------- FUNCI√ìN PARA MANEJAR EL MEN√ö ---------- */
function toggleSeccion(seccionId) {
  const seccion = document.getElementById(seccionId);
  const boton = document.getElementById(`btn${seccionId.charAt(0).toUpperCase() + seccionId.slice(1)}`);
  
  // Si ya est√° activa, la cerramos
  if (seccionActual === seccionId) {
    seccion.style.display = 'none';
    boton.classList.remove('activo');
    seccionActual = null;
    return;
  }
  
  // Cerramos la secci√≥n actual si existe
  if (seccionActual) {
    document.getElementById(seccionActual).style.display = 'none';
    document.getElementById(`btn${seccionActual.charAt(0).toUpperCase() + seccionActual.slice(1)}`).classList.remove('activo');
  }
  
  // Abrimos la nueva secci√≥n
  seccion.style.display = 'block';
  boton.classList.add('activo');
  seccionActual = seccionId;
  
  // Scroll suave hacia la secci√≥n
  window.scrollTo({top: seccion.offsetTop - 20, behavior: 'smooth'});
  
  // INICIALIZAR BUSCADORES AL ABRIR SECCI√ìN
  if (seccionId === 'reportes') {
    cargarListaReportes();
    // Peque√±o delay para asegurar que las tarjetas se cargaron
    setTimeout(() => {
      inicializarBuscadorReportes();
    }, 100);
  } else if (seccionId === 'actualizaciones') {
    cargarActualizacionesReportes();
    // Peque√±o delay para asegurar que las actualizaciones se cargaron
    setTimeout(() => {
      inicializarBuscadorActualizaciones();
    }, 100);
  }
}

/* ---------- RUTEO: si hay ?id=abc mostramos detalle ---------- */
const urlParams = new URLSearchParams(window.location.search);
const detailId = urlParams.get('id');
const detailEl = document.getElementById('detail');

if (detailId) {
  // mostrar detalle (oculta mapa y UI)
  document.querySelector('.map-box').style.display = 'none';
  document.getElementById('btnAgregarQueja').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('formContainer').style.display = 'none';
  document.getElementById('mapMessage').style.display = 'none';
  detailEl.style.display = 'block';
  mostrarDetalle(detailId);
} else {
  detailEl.style.display = 'none';
  initMap();
}

/* ---------- FUNCI√ìN mostrarDetalle(id) MEJORADA ---------- */
function mostrarDetalle(id) {
  const ref = db.ref('reportes/' + id);
  ref.once('value').then(snap => {
    const data = snap.val();
    if (!data) {
      document.getElementById('detailContent').innerHTML = 
        '<div style="text-align: center; padding: 40px; color: #666;">' +
        '<i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>' +
        '<h3>Reporte no encontrado</h3>' +
        '<p>El reporte solicitado no existe o ha sido eliminado.</p>' +
        '</div>';
      return;
    }
    
    const street = data.street || 'Calle desconocida, Tijuana';
    const description = data.description || 'No hay descripci√≥n disponible.';
    const estado = data.status || 'pendiente';
    
    // C√ÅLCULO DE D√çAS MEJORADO
    const fechaCreacionMs = data.fechaCreacion ? 
      (data.fechaCreacion.toMillis ? data.fechaCreacion.toMillis() : data.fechaCreacion) : 
      Date.now();
    const diasPasados = calcularDiasUTC(fechaCreacionMs);
    
    // Formatear fecha de creaci√≥n
    const fechaCreacion = new Date(fechaCreacionMs);
    const fechaFormateada = fechaCreacion.toLocaleDateString('es-MX', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    // Calcular prioridad y badges
    const prioridad = calcularPrioridad(data);
    const badgePrioridad = obtenerBadgePrioridad(prioridad);
    const badgeUrgencia = obtenerBadgeUrgencia(diasPasados);

    // Actualizar la informaci√≥n b√°sica
    document.getElementById('detailStreet').innerHTML = `
      ${street}
      <div id="detailBadges" style="margin-top: 10px;">
        ${badgePrioridad}
        ${badgeUrgencia}
      </div>
    `;
    document.getElementById('detailDescription').textContent = description;
    document.getElementById('detailDias').textContent = `${diasPasados} d√≠as`;
    document.getElementById('detailFecha').textContent = fechaFormateada;
    
    // Actualizar estado con el badge correspondiente
    const estadoElement = document.getElementById('detailEstado');
    estadoElement.textContent = estado;
    estadoElement.className = 'estado-badge estado-' + estado;
    
    // Cargar fotos
    const photosContainer = document.getElementById('detailPhotos');
    photosContainer.innerHTML = '';
    
    if (data.foto) {
      if (Array.isArray(data.foto)) {
        // M√∫ltiples fotos
        data.foto.forEach(f => {
          const imgContainer = document.createElement('div');
          imgContainer.style.position = 'relative';
          imgContainer.style.cursor = 'pointer';
          
          const img = document.createElement('img');
          img.src = `Fotos/${f}`;
          img.className = 'thumb';
          img.onclick = () => mostrarImagen(`Fotos/${f}`);
          img.style.width = '120px';
          img.style.height = '120px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '8px';
          img.style.border = '2px solid #ddd';
          img.style.transition = 'all 0.3s ease';
          
          imgContainer.appendChild(img);
          photosContainer.appendChild(imgContainer);
        });
      } else {
        // Una sola foto
        const imgContainer = document.createElement('div');
        imgContainer.style.position = 'relative';
        imgContainer.style.cursor = 'pointer';
        
        const img = document.createElement('img');
        img.src = `Fotos/${data.foto}`;
        img.className = 'thumb';
        img.onclick = () => mostrarImagen(`Fotos/${data.foto}`);
        img.style.width = '120px';
        img.style.height = '120px';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '8px';
        img.style.border = '2px solid #ddd';
        img.style.transition = 'all 0.3s ease';
        
        imgContainer.appendChild(img);
        photosContainer.appendChild(imgContainer);
      }
    } else if (data.photo) {
      // Compatibilidad con campo "photo"
      const imgContainer = document.createElement('div');
      imgContainer.style.position = 'relative';
      imgContainer.style.cursor = 'pointer';
      
      const img = document.createElement('img');
      img.src = data.photo;
      img.className = 'thumb';
      img.onclick = () => mostrarImagen(data.photo);
      img.style.width = '120px';
      img.style.height = '120px';
      img.style.objectFit = 'cover';
      img.style.borderRadius = '8px';
      img.style.border = '2px solid #ddd';
      img.style.transition = 'all 0.3s ease';
      
      imgContainer.appendChild(img);
      photosContainer.appendChild(imgContainer);
    } else {
      photosContainer.innerHTML = 
        '<div style="color:#666; padding: 20px; text-align: center; width: 100%;">' +
        '<i class="fas fa-image" style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;"></i>' +
        '<p>No hay fotos disponibles para este reporte</p>' +
        '</div>';
    }
    
    // Cargar historial de actualizaciones
    cargarHistorialActualizaciones(id);
    
  }).catch(err => {
    document.getElementById('detailContent').innerHTML = 
      '<div style="text-align: center; padding: 40px; color: #666;">' +
      '<i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>' +
      '<h3>Error al cargar el reporte</h3>' +
      '<p>Ocurri√≥ un problema al cargar la informaci√≥n del reporte.</p>' +
      '</div>';
    console.error(err);
  });

  document.getElementById('backToMap').addEventListener('click', (e) => {
    e.preventDefault();
    window.location.href = window.location.pathname;
  });
  
  // Mostrar/ocultar bot√≥n de actualizaci√≥n seg√∫n autenticaci√≥n
  const btnActualizacion = document.getElementById('btnAgregarActualizacionDetalle');
  if (usuarioAutenticado) {
    btnActualizacion.style.display = 'inline-block';
    btnActualizacion.onclick = () => abrirFormularioActualizacion(detailId);
  } else {
    btnActualizacion.style.display = 'none';
  }
}

/* ---------- FUNCI√ìN PARA CARGAR HISTORIAL DE ACTUALIZACIONES ---------- */
function cargarHistorialActualizaciones(reporteId) {
  const contenedor = document.getElementById('detailActualizaciones');
  
  db.ref('reportes/' + reporteId).once('value').then(snapshot => {
    const data = snapshot.val();
    if (!data || !data.actualizaciones) {
      contenedor.innerHTML = 
        '<div style="color:#666; padding: 20px; text-align: center;">' +
        '<i class="fas fa-info-circle" style="margin-right: 8px;"></i>' +
        'No hay actualizaciones disponibles para este reporte.' +
        '</div>';
      return;
    }
    
    const actualizaciones = Object.values(data.actualizaciones);
    
    // Ordenar por fecha (m√°s reciente primero)
    actualizaciones.sort((a, b) => b.fecha - a.fecha);
    
    if (actualizaciones.length === 0) {
      contenedor.innerHTML = 
        '<div style="color:#666; padding: 20px; text-align: center;">' +
        '<i class="fas fa-info-circle" style="margin-right: 8px;"></i>' +
        'No hay actualizaciones disponibles para este reporte.' +
        '</div>';
      return;
    }
    
    let html = '';
    actualizaciones.forEach((act, index) => {
      const fecha = new Date(act.fecha);
      const fechaFormateada = fecha.toLocaleDateString('es-MX', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      html += `
        <div class="actualizacion-item ${index === 0 ? 'ultima-actualizacion' : ''}" 
             style="border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #fafafa;">
          <div class="actualizacion-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div class="actualizacion-titulo" style="font-weight: bold; color: #7c002a; font-size: 16px; margin: 0;">
              Actualizaci√≥n
            </div>
            <div class="actualizacion-fecha" style="color: #666; font-size: 12px;">
              ${fechaFormateada}
            </div>
          </div>
          
          <div class="actualizacion-descripcion" style="color: #333; margin-bottom: 8px;">
            ${act.descripcion || 'Sin descripci√≥n adicional'}
          </div>
          
          <div class="actualizacion-meta" style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #666;">
            <div>
              ${act.estado ? `
                <span class="badge-estado estado-${act.estado}" style="padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                  ${act.estado}
                </span>
              ` : ''}
              ${act.tecnico ? `<span style="margin-left: 10px;">T√©cnico: ${act.tecnico}</span>` : ''}
            </div>
            ${act.usuario ? `<span>Por: ${act.usuario}</span>` : ''}
          </div>
        </div>
      `;
    });
    
    contenedor.innerHTML = html;
    
  }).catch(err => {
    console.error('Error cargando actualizaciones:', err);
    contenedor.innerHTML = 
      '<div style="color:#666; padding: 20px; text-align: center;">' +
      '<i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>' +
      'Error al cargar las actualizaciones.' +
      '</div>';
  });
}

/* ---------- FUNCIONES MAPA (cuando no hay ?id) ---------- */
function initMap(){
  mapa = L.map('map');
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap contributors'
}).addTo(mapa);

  fetch("https://nominatim.openstreetmap.org/search?city=Tijuana&format=json")
    .then(r => r.json())
    .then(data => {
      if (data.length > 0) mapa.setView([parseFloat(data[0].lat), parseFloat(data[0].lon)], 12);
      else mapa.setView([32.533, -117.033], 12);
    })
    .catch(()=> mapa.setView([32.533, -117.033], 12));

  function addMarker(lat, lng, key, street, descripcion = '', rawData = {}, count = 1){
    // C√ÅLCULO DE D√çAS MEJORADO
    const fechaCreacionMs = rawData.fechaCreacion ? (rawData.fechaCreacion.toMillis ? rawData.fechaCreacion.toMillis() : rawData.fechaCreacion) : Date.now();
    const diasPasados = calcularDiasUTC(fechaCreacionMs);
    
    // SISTEMA COMBINADO: d√≠as + agrupamiento
    const { color, parpadeo } = determinarColorYParpadeo(diasPasados, count);
    const icon = createIcon(color);
    
    const marker = L.marker([lat, lng], { icon }).addTo(mapa);
    
    // Guardar referencia al marcador
    marcadores[key] = marker;
    
    const streetEsc = escapeHtml(street || 'Calle desconocida, Tijuana');
    const descEsc = escapeHtml(descripcion || '');

    // Calcular prioridad para el popup
    const prioridad = calcularPrioridad(rawData);
    const badgePrioridad = obtenerBadgePrioridad(prioridad);
    const badgeUrgencia = obtenerBadgeUrgencia(diasPasados);

    const popupHtml = `
      <div style="min-width: 280px;">
        <div style="border-bottom: 2px solid #7c002a; padding-bottom: 8px; margin-bottom: 10px;">
          <div style="font-weight:700; color: #7c002a;">üìç ${streetEsc}</div>
        </div>
        
        <div style="margin-bottom: 8px;">
          <strong>Tipo:</strong> ${descEsc.split(':')[0] || descEsc}
        </div>
        
        <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
          ${badgePrioridad}
          ${badgeUrgencia}
          <span class="estado-badge estado-${rawData.status || 'pendiente'}">${rawData.status || 'pendiente'}</span>
        </div>
        
        <div style="margin-bottom: 8px;">
          <strong><i class="far fa-clock"></i> D√≠as:</strong> ${diasPasados} d√≠as
        </div>
        
        <div style="border-top: 1px solid #eee; padding-top: 10px; display: flex; justify-content: space-between;">
          <a href="?id=${key}" style="color: #7c002a; font-weight: bold; text-decoration: none;">
            <i class="fas fa-external-link-alt"></i> Ver detalles
          </a>
          ${usuarioAutenticado ? `
            <button class="btn-agregar-actualizacion" onclick="abrirFormularioActualizacion('${key}')" style="padding: 4px 8px; font-size: 12px;">
              <i class="fas fa-edit"></i> Actualizar
            </button>
          ` : ''}
        </div>
      </div>
    `;

    marker.bindPopup(popupHtml);

    // EFECTO DE PARPADEO
    if (parpadeo) {
      let visible = true;
      const intervalo = setInterval(() => {
        if (mapa.hasLayer(marker)) {
          marker.setIcon(createIcon(visible ? 'red' : 'grey'));
          visible = !visible;
        } else {
          clearInterval(intervalo);
        }
      }, 500);
    }

    // doble click para eliminar (solo para pruebas)
    marker.on('dblclick', () => {
      if (confirm('¬øEliminar este reporte?')) {
        mapa.removeLayer(marker);
        db.ref('reportes/' + key).remove();
        delete marcadores[key];
      }
    });

    return marker;
  }

  // CARGAR TODOS los reportes para mostrarlos en el mapa (aprobados + pendientes)
  db.ref('reportes').once('value').then(snapshot => {
    const reportCount = {}; // para agrupar por coordenadas
    snapshot.forEach(child => {
      const data = child.val();
      if (!data) return;
      // agrupar por coord redondeada (incluso si faltan lat/lng salta)
      if (data.lat == null || data.lng == null) return;
      const keyCoords = `${roundCoord(data.lat)},${roundCoord(data.lng)}`;
      if (!reportCount[keyCoords]) reportCount[keyCoords] = 0;
      reportCount[keyCoords]++;
    });

    snapshot.forEach(child => {
      const data = child.val();
      if (!data) return;
      if (data.lat == null || data.lng == null) return;
      const key = child.key;
      const keyCoords = `${roundCoord(data.lat)},${roundCoord(data.lng)}`;
      const count = reportCount[keyCoords] || 0;
      
      // Usar la funci√≥n addMarker que aplica colores y parpadeo correctamente
      addMarker(data.lat, data.lng, key, data.street || 'Calle desconocida, Tijuana', 
                data.description || '', data, count);
    });
  }).catch(err => console.error(err));

  /* ---------- CARGAR LISTA DE REPORTES ---------- */
  window.cargarListaReportes = function() {
    const listaContainer = document.getElementById('listaReportes');
    db.ref('reportes').once('value').then(snapshot => {
      listaContainer.innerHTML = '';
      const items = [];
      snapshot.forEach(child => {
        const data = child.val();
        if (!data) return;
        items.push({ id: child.key, val: data });
      });

      if (items.length === 0) {
        listaContainer.innerHTML = '<div class="sin-resultados"><p style="color:#666;">No hay reportes actualmente.</p></div>';
        return;
      }

      // Ordenar por fecha m√°s reciente primero
      items.sort((a, b) => {
        const fechaA = a.val.fechaCreacion || a.val.timestamp || 0;
        const fechaB = b.val.fechaCreacion || b.val.timestamp || 0;
        return fechaB - fechaA;
      });

      // mostrar cada uno
      items.forEach(item => {
        const data = item.val;
        
        // C√°lculo de d√≠as mejorado
        const fechaCreacionMs = data.fechaCreacion ? (data.fechaCreacion.toMillis ? data.fechaCreacion.toMillis() : data.fechaCreacion) : Date.now();
        const diasPasados = calcularDiasUTC(fechaCreacionMs);
        
        // Calcular prioridad
        const prioridad = calcularPrioridad(data);
        const badgePrioridad = obtenerBadgePrioridad(prioridad);
        const badgeUrgencia = obtenerBadgeUrgencia(diasPasados);
        
        const card = document.createElement('div');
        card.className = 'reporte-card';
        
        // Determinar clase de estado CORREGIDO
        let estadoClass = 'estado-pendiente';
        if (data.status === 'aprobado') {
          estadoClass = 'estado-aprobado';
        } else if (data.status === 'resuelto') {
          estadoClass = 'estado-resuelto';
        }
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <h3 style="margin: 0; color: #7c002a; flex: 1;">${escapeHtml(data.street || 'Ubicaci√≥n desconocida')}</h3>
            <div style="text-align: right;">
              ${badgePrioridad}
              ${badgeUrgencia}
            </div>
          </div>
          <div class="fecha" style="color: #666; font-size: 14px; margin-bottom: 8px;">
            <i class="far fa-clock"></i> Reportado hace ${diasPasados} d√≠as
          </div>
          <div class="descripcion" style="margin-bottom: 10px;">${escapeHtml(data.description || 'Sin descripci√≥n')}</div>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span class="estado-badge estado-${data.status || 'pendiente'}">${data.status || 'pendiente'}</span>
            <div>
              <a href="?id=${item.id}" style="color:#0056b3; text-decoration:underline; margin-right: 10px;">Ver detalles</a>
              ${usuarioAutenticado ? `
                <button class="btn-agregar-actualizacion" onclick="abrirFormularioActualizacion('${item.id}')">Actualizar</button>
              ` : ''}
            </div>
          </div>
        `;
        listaContainer.appendChild(card);
      });

      // INICIALIZAR BUSCADOR DESPU√âS DE CARGAR
      inicializarBuscadorReportes();
      
    }).catch(err => {
      listaContainer.innerHTML = '<div class="sin-resultados"><p style="color:#666;">Error cargando reportes.</p></div>';
      console.error('Error cargando reportes:', err);
    });
  };

  // Cargar lista inicial de reportes
  cargarListaReportes();

  /* ---------- UI form y creaci√≥n de reportes ---------- */
  const overlay = document.getElementById('overlay');
  const formContainer = document.getElementById('formContainer');
  const closeForm = document.getElementById('closeForm');
  const formQueja = document.getElementById('formQueja');
  const btnAgregar = document.getElementById('btnAgregarQueja');
  const mapMessage = document.getElementById('mapMessage');

  // INICIALIZAR CAMPO "OTRO PROBLEMA"
  inicializarCampoOtroProblema();

  btnAgregar.addEventListener('click', () => { 
    overlay.style.display='block'; 
    formContainer.style.display='block'; 
  });
  
  closeForm.addEventListener('click', () => { 
    overlay.style.display='none'; 
    formContainer.style.display='none'; 
  });

  let colocarMarcadorActivo = false;
  formQueja.addEventListener('submit', (e) => {
    e.preventDefault();
    
    // Validar que si se seleccion√≥ "otro", se haya especificado el problema
    const tipoProblema = document.getElementById('tipoProblema').value;
    const otroProblema = document.getElementById('otroProblema').value;
    
    if (tipoProblema === 'otro' && (!otroProblema || otroProblema.trim() === '')) {
      alert('Por favor, especifica el problema cuando seleccionas "Otro tipo de problema"');
      return;
    }
    
    overlay.style.display='none';
    formContainer.style.display='none';
    mapMessage.style.display='block';
    colocarMarcadorActivo = true;
  });

  mapa.on('click', function(ev){
    if (!colocarMarcadorActivo) return;
    colocarMarcadorActivo = false;
    mapMessage.style.display='none';

    const { lat, lng } = ev.latlng;
    const tipoProblema = document.getElementById('tipoProblema').value;
    const otroProblema = document.getElementById('otroProblema').value;
    const descripcionAdicional = document.getElementById('descripcion').value;

    // Combinar el tipo de problema con la descripci√≥n adicional
    let descripcionCompleta = '';
    
    if (tipoProblema === 'otro') {
      // Usar el texto del campo "otro problema"
      descripcionCompleta = `Otro problema: ${otroProblema}`;
    } else {
      // Usar el texto del select
      descripcionCompleta = tipoProblema;
    }
    
    // Agregar descripci√≥n adicional si existe
    if (descripcionAdicional) {
      descripcionCompleta += `: ${descripcionAdicional}`;
    }

    // abrir nueva pesta√±a primero para evitar bloqueos m√≥viles
    const nuevaPesta√±a = window.open('', '_blank');

    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`)
      .then(res => res.json())
      .then(data => {
        const street = data.address?.road || 'Calle desconocida';
        const city = data.address?.city || data.address?.town || data.address?.village || 'Tijuana';
        const fullStreet = `${street}, ${city}`;

        // Guardar en Firebase con timestamp
        const newRef = db.ref('reportes').push();
        newRef.set({
          lat, lng,
          street: fullStreet,
          description: descripcionCompleta,
          foto:"Suba su foto",
          status: 'pendiente',
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          fechaCreacion: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
          console.log('Reporte guardado correctamente:', descripcionCompleta);
          
          // CERRAR el formulario y resetearlo
          document.getElementById('overlay').style.display = 'none';
          document.getElementById('formContainer').style.display = 'none';
          document.getElementById('formQueja').reset();
          document.getElementById('otroProblemaContainer').style.display = 'none';
          
          // Recargar lista de reportes
          cargarListaReportes();
          
          // Agregar marcador al mapa inmediatamente
          addMarker(lat, lng, newRef.key, fullStreet, descripcionCompleta, {
            status: 'pendiente',
            fechaCreacion: Date.now()
          }, 1);
          
          // Redirigir a Google Forms
          nuevaPesta√±a.location.href = "https://docs.google.com/forms/d/e/1FAIpQLScrEq6KDExGBKtzYpbWZeuWsUzy2gKC61hTQ3p8L_8DLPChVw/viewform";
          
        }).catch(err => {
          console.error('Error al guardar:', err);
          alert('Error al guardar el reporte');
          nuevaPesta√±a.location.href = "https://docs.google.com/forms/d/e/1FAIpQLScrEq6KDExGBKtzYpbWZeuWsUzy2gKC61hTQ3p8L_8DLPChVw/viewform";
        });
      })
      .catch(() => {
        const newRef = db.ref('reportes').push();
        newRef.set({
          lat, lng,
          street: "Calle desconocida, Tijuana",
          description: descripcionCompleta,
          status: 'pendiente',
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          fechaCreacion: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
          console.log('Reporte guardado (fallback):', descripcionCompleta);
          
          // CERRAR el formulario y resetearlo
          document.getElementById('overlay').style.display = 'none';
          document.getElementById('formContainer').style.display = 'none';
          document.getElementById('formQueja').reset();
          document.getElementById('otroProblemaContainer').style.display = 'none';
          
          // Recargar lista de reportes
          cargarListaReportes();
          
          // Agregar marcador al mapa inmediatamente
          addMarker(lat, lng, newRef.key, "Calle desconocida, Tijuana", descripcionCompleta, {
            status: 'pendiente',
            fechaCreacion: Date.now()
          }, 1);
          
          nuevaPesta√±a.location.href = "https://docs.google.com/forms/d/e/1FAIpQLScrEq6KDExGBKtzYpbWZeuWsUzy2gKC61hTQ3p8L_8DLPChVw/viewform";
        });
      });
  });

  // soporte t√°ctil
  mapa.on('touchend', function(ev){
    if(!colocarMarcadorActivo) return;
    const touch = ev.originalEvent.changedTouches ? ev.originalEvent.changedTouches[0] : null;
    if(!touch) return;
    const point = mapa.mouseEventToLatLng(touch);
    mapa.fire('click', { latlng: point });
  });

} // fin initMap

/* ---------- FUNCIONALIDAD MISI√ìN Y VISI√ìN ---------- */
function mostrarMV(tipo){
  document.getElementById("mision").classList.toggle("active", tipo === "mision");
  document.getElementById("vision").classList.toggle("active", tipo === "vision");

  // Color de pesta√±as
  document.getElementById("tabMision").classList.toggle("active", tipo === "mision");
  document.getElementById("tabVision").classList.toggle("active", tipo === "vision");
}

/* ---------- Event listeners para el men√∫ ---------- */
document.getElementById("btnActualizaciones").addEventListener("click", (e) => {
  e.preventDefault();
  toggleSeccion('actualizaciones');
});

document.getElementById("btnReportes").addEventListener("click", (e) => {
  e.preventDefault();
  toggleSeccion('reportes');
});

document.getElementById("btnAyuda").addEventListener("click", (e) => {
  e.preventDefault();
  toggleSeccion('ayuda');
});

// Event listeners para cerrar secciones
document.getElementById("cerrarActualizaciones").addEventListener("click", () => {
  document.getElementById("actualizaciones").style.display = "none";
  document.getElementById("btnActualizaciones").classList.remove("activo");
  seccionActual = null;
});

document.getElementById("cerrarReportes").addEventListener("click", () => {
  document.getElementById("reportes").style.display = "none";
  document.getElementById("btnReportes").classList.remove("activo");
  seccionActual = null;
});

document.getElementById("cerrarAyuda").addEventListener("click", () => {
  document.getElementById("ayuda").style.display = "none";
  document.getElementById("btnAyuda").classList.remove("activo");
  seccionActual = null;
});

// Event listeners para Misi√≥n y Visi√≥n
document.getElementById("tabMision").addEventListener("click", () => mostrarMV("mision"));
document.getElementById("tabVision").addEventListener("click", () => mostrarMV("vision"));

// INICIALIZAR SISTEMA DE AUTENTICACI√ìN AL CARGAR
document.addEventListener('DOMContentLoaded', function() {
  verificarSesionGuardada();
  actualizarInterfazAutenticacion();
  
  // Inicializar campo "otro problema"
  inicializarCampoOtroProblema();
  
  // Inicializar buscadores est√°ticos si existen
  if (document.getElementById('buscadorActualizaciones')) {
    inicializarBuscadorActualizaciones();
  }
});
</script>
<footer class="footer-gob">
  <div class="footer-container">

    <!-- Columna 1: Logo + gobierno -->
    <div class="footer-col logo-col">
      <div class="escudo"></div>
      <h2>BAJA<br>CALIFORNIA</h2>
      <p>Atenci√≥n ciudadana</p>
    </div>

    <!-- Columna 2: Servicios -->
    <div class="footer-col">
      <h3>CONTACTO</h3>
      <ul>
        <li>Mu√±oz Chavez Juan Ram√≥n</li>
        <li>Departamento de sistemas computacionales.</li>
      </ul>
    </div>

    <!-- Columna 3: Ligas -->
    <div class="footer-col">
      <h3>CONTACTO</h3>
      <ul>
        <li>Cazares Manzo Nicole Alexandra.</li>
        <li>Departamento de sistemas computacionales.</li>

      </ul>
    </div>

    <!-- Columna 4: Contacto -->
    <div class="footer-col">
      <h3>CONTACTO</h3>
      <ul>
        <li>25213438</li>
        <li>25213719</li>
      </ul>
    </div>

   <div class="clima-col">
  <h3>CLIMA EN TIJUANA</h3>

  <div class="clima-box">
    <div class="clima-top">
      <div class="clima-icon"><img class="clima-icon-img" alt="icono clima" /></div>
      <div>
        <p class="temp">--¬∞C</p>
        <p class="estado">Cargando...</p>
        <p class="hora">Actualizando...</p>
      </div>
    </div>

    <div class="clima-details">
      <span class="feels">Sensaci√≥n: --¬∞C</span>
      <span class="hum">Humedad: --%</span>
      <span class="wind">Viento: -- m/s</span>
      <span class="minmax">Min: --¬∞C ‚Ä¢ Max: --¬∞C</span>
    </div>

    <div class="prevision">
      <!-- Aqu√≠ ir√° el pron√≥stico de 5 d√≠as -->
    </div>
  </div>
</div>

  </div>

  <div class="footer-copy">
    ¬© 2025 - Proyecto InovaTec | Aviso de Privacidad
  </div>
</footer>
<script>
document.addEventListener("DOMContentLoaded", () => {

  const apiKey = "b9a5af336592edd3ee2224e8ef0147c3"; // pon aqu√≠ tu API key
  const ciudad = "Tijuana,mx";
  const unidades = "metric";
  const lang = "es";

  const selectors = {
    temp: ".temp",
    estado: ".estado",
    hora: ".hora",
    iconImg: ".clima-icon-img",
    feels: ".feels",
    hum: ".hum",
    wind: ".wind",
    minmax: ".minmax",
    prevision: ".prevision"
  };

  function qs(sel){ return document.querySelector(sel); }

  async function cargarClimaActual() {
    try {
      const url = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(ciudad)}&units=${unidades}&lang=${lang}&appid=${apiKey}`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const data = await resp.json();

      const temp = Math.round(data.main.temp);
      const desc = (data.weather && data.weather[0] && data.weather[0].description) ? data.weather[0].description : "";
      const icon = (data.weather && data.weather[0] && data.weather[0].icon) ? data.weather[0].icon : null;
      const feels = Math.round(data.main.feels_like);
      const hum = data.main.humidity;
      const wind = data.wind && data.wind.speed ? data.wind.speed : null;
      const tempMin = Math.round(data.main.temp_min);
      const tempMax = Math.round(data.main.temp_max);

      if (qs(selectors.temp)) qs(selectors.temp).textContent = `${temp}¬∞C`;
      if (qs(selectors.estado)) qs(selectors.estado).textContent = desc;
      if (qs(selectors.hora)) qs(selectors.hora).textContent = `Actualizado ${new Date().toLocaleTimeString()}`;
      if (qs(selectors.feels)) qs(selectors.feels).textContent = `Sensaci√≥n: ${feels}¬∞C`;
      if (qs(selectors.hum)) qs(selectors.hum).textContent = `Humedad: ${hum}%`;
      if (qs(selectors.wind)) qs(selectors.wind).textContent = `Viento: ${wind ?? '--'} m/s`;
      if (qs(selectors.minmax)) qs(selectors.minmax).textContent = `Min: ${tempMin}¬∞C ‚Ä¢ Max: ${tempMax}¬∞C`;

      if (icon && qs(selectors.iconImg)) {
        qs(selectors.iconImg).src = `https://openweathermap.org/img/wn/${icon}@2x.png`;
        qs(selectors.iconImg).alt = desc;
      }
    } catch (err) {
      console.error("Error obteniendo clima actual:", err);
      if (qs(selectors.estado)) qs(selectors.estado).textContent = "No disponible";
    }
  }

  // Pron√≥stico 5 d√≠as (agrupa por d√≠a usando /forecast, valores cada 3 horas)
  async function cargarPronostico5dias() {
    try {
      const url = `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(ciudad)}&units=${unidades}&lang=${lang}&appid=${apiKey}`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const data = await resp.json();
      const list = data.list || [];

      // Agrupar por fecha (YYYY-MM-DD)
      const dias = {};
      list.forEach(item => {
        const date = new Date(item.dt * 1000);
        const diaKey = date.toISOString().slice(0,10);
        if (!dias[diaKey]) dias[diaKey] = [];
        dias[diaKey].push(item);
      });

      const claves = Object.keys(dias).slice(0,5); // primeros 5 d√≠as
      const cont = qs(selectors.prevision);
      if (!cont) return;
      cont.innerHTML = "";

      claves.forEach(k => {
        const entradas = dias[k];
        // obtener temp promedio o el que est√© a las 12:00 si existe
        let elegido = entradas.find(e => new Date(e.dt*1000).getHours() === 12) || entradas[Math.floor(entradas.length/2)];
        const temp = Math.round(elegido.main.temp);
        const icon = elegido.weather && elegido.weather[0] && elegido.weather[0].icon ? elegido.weather[0].icon : null;
        const diaNombre = new Date(k).toLocaleDateString(undefined, { weekday: 'short' }); // ej. "lun"

        const div = document.createElement('div');
        div.className = "dia";
        div.innerHTML = `
          <div class="dday">${diaNombre}</div>
          ${icon ? `<div><img src="https://openweathermap.org/img/wn/${icon}.png" alt="" /></div>` : ''}
          <div class="dtemp">${temp}¬∞</div>
        `;
        cont.appendChild(div);
      });

    } catch (err) {
      console.error("Error obteniendo pron√≥stico:", err);
    }
  }

  // carga inicial
  cargarClimaActual();
  cargarPronostico5dias();

  // actualiza cada 10 minutos
  setInterval(() => { cargarClimaActual(); cargarPronostico5dias(); }, 600000);

});
</script>
</body>
</html>