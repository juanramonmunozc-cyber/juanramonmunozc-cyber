<!DOCTYPE html>
<html lang="es">
<head> 
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Centro de Atenci贸n CESPT - Quejas y Reportes</title>
  <link rel="icon" type="image/png" href="crisis.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    body {
      font-family: Arial, Helvetica, sans-serif; 
      margin:0; 
      padding:0;     
      background:#f2f2f2; 
    }

    h1 { color:#7c002a; margin-top:18px; font-size:40px; text-align:center; font-weight:700; }
    h2 { color:#7c002a; margin-top:6px; font-size:20px; text-align:center; font-weight:500; }

    /* MENU SUPERIOR */
    .menu-superior {
      width: 100%;
      background:#6a0a24;
      padding: 12px 0;
      display: flex;
      justify-content: center;
      gap: 28px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .menu-superior a { 
      color:white; 
      font-size:18px; 
      font-weight:bold; 
      text-decoration:none; 
      cursor:pointer; 
      padding: 8px 16px;
      border-radius: 5px;
      transition: all 0.3s ease;
    }
    .menu-superior a:hover { 
      background: rgba(255,255,255,0.2);
    }
    .menu-superior a.activo {
      background: rgba(255,255,255,0.3);
      box-shadow: 0 0 10px rgba(255,255,255,0.2);
    }

    /* SECCIONES GENERALES */
    .seccion {
      max-width:900px;
      margin:18px auto;
      background:#fff;
      padding:20px;
      border-radius:10px;
      border:2px solid #7c002a;
      font-size:16px;
    }
    .oculto { display:none; }

    /* MAPA */
    .map-box {
      width: 100%;
      padding: 30px 0;
      display:flex;
      justify-content:center;
      margin-top:20px;
      border-radius:8px;
      background: linear-gradient(90deg, #ffffff 40%, #7c002a 100%);
    }

    .map-box > #map {
      width: 90%;
      max-width: 980px;
      height: 550px;
      border-radius:12px;
      border:3px solid #7c002a;
      background: linear-gradient(180deg, #ffffff 0%, #fff 70%, rgba(124,0,42,0.06) 100%);
      box-shadow:0 6px 18px rgba(0,0,0,0.12);
    }

    /* BOTN */
    #btnAgregarQueja {
      position:fixed;
      bottom:20px;
      right:20px;
      padding:15px 20px;
      background:#007bff;
      color:#fff;
      border:none;
      border-radius:50px;
      cursor:pointer;
      box-shadow:0 4px 6px rgba(0,0,0,.25);
      font-size:16px;
      z-index:1003
    }

    #btnAgregarQueja:hover { background:#0056b3 }

    /* MODAL */
    #overlay {
      display:none;
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,.6);
      z-index:1002
    }

    #formContainer {
      display:none;
      position:fixed;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      background:#fff;
      padding:20px;
      border-radius:10px;
      width:360px;
      box-shadow:0 6px 18px rgba(0,0,0,.3);
      z-index:1003
    }

    #formContainer h3 { margin-top:0 }
    #formContainer label { font-weight:700; display:block; margin-top:10px }
    #formContainer input, #formContainer textarea, #formContainer select {
      width:100%; padding:8px; margin-top:6px;
      border:1px solid #ccc; border-radius:6px
    }

    #closeForm {
      position:absolute; top:8px; right:12px; cursor:pointer;
      font-weight:700; font-size:20px; color:#333;
    }
    #mapMessage {
      display:none;
      position:fixed;
      top:12px; left:50%;
      transform:translateX(-50%);
      background:#ffc107;
      color:#333;
      padding:10px 18px;
      border-radius:6px;
      z-index:1004;
      font-weight:700;
    }

    /* DETALLE REPORTE */
    #detail {
      display:none;
      max-width:900px;
      margin:20px auto;
      background:#fff;
      padding:24px;
      border-radius:10px;
      border:2px solid #7c002a;
    }

    #detail h1 { font-size:28px; margin-bottom:6px; color:#222; }
    #detail a.back { display:inline-block; margin-bottom:12px; color:#4b4bd6; text-decoration:underline; }

    /* Estilos para las miniaturas de fotos */
    .thumb {
      width: 120px;
      height: 120px;
      object-fit: cover;
      margin: 8px;
      cursor: pointer;
      border: 2px solid #ddd;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    .thumb:hover {
      border-color: #7c002a;
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Modal para ver foto en grande */
    #modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    #modalImg {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    #closeModal {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 40px;
      cursor: pointer;
      background: none;
      border: none;
      z-index: 10001;
    }
    #closeModal:hover {
      color: #ff6b6b;
    }

    /* Estilos para tarjetas de reportes */
    .reporte-card {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      background: #fafafa;
      transition: all 0.3s ease;
    }
    .reporte-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    .reporte-card h3 {
      margin: 0 0 5px 0;
      color: #7c002a;
    }
    .reporte-card .fecha {
      color: #666;
      font-size: 14px;
    }
    .reporte-card .descripcion {
      margin-top: 10px;
      color: #333;
    }
    .reporte-card .estado {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-top: 8px;
    }
    
    .estado-pendiente { background: #fff3cd; color: #856404; }
    .estado-aprobado { background: #d1ecf1; color: #0c5460; }
    .estado-resuelto { background: #d4edda; color: #155724; }

    /* ESTILOS PARA BUSCADORES */
    #buscadorActualizaciones, #buscadorReportes, #filtroEstado {
      transition: all 0.3s ease;
      border: 2px solid #7c002a;
    }

    #buscadorActualizaciones:focus, #buscadorReportes:focus, #filtroEstado:focus {
      outline: none;
      border-color: #ff6b9d;
      box-shadow: 0 0 0 3px rgba(124, 0, 42, 0.1);
    }

    /* CONTADOR DE RESULTADOS */
    .contador-resultados {
      margin-bottom: 15px;
      color: #666;
      font-style: italic;
      text-align: right;
      font-size: 14px;
    }

    /* MENSAJE SIN RESULTADOS */
    .sin-resultados {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
      background: #f9f9f9;
      border-radius: 8px;
      border: 2px dashed #ddd;
    }

    /* ESTILOS PARA ACTUALIZACIONES DE REPORTES */
    .actualizacion-item {
      border: 1px solid #e0e0e0;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      background: #fafafa;
      transition: all 0.3s ease;
    }

    .actualizacion-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .actualizacion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .actualizacion-titulo {
      font-weight: bold;
      color: #7c002a;
      font-size: 16px;
      margin: 0;
    }

    .actualizacion-fecha {
      color: #666;
      font-size: 12px;
    }

    .actualizacion-descripcion {
      color: #333;
      margin-bottom: 8px;
    }

    .actualizacion-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #666;
    }

    .badge-estado {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }

    .estado-pendiente { background: #fff3cd; color: #856404; }
    .estado-proceso { background: #d1ecf1; color: #0c5460; }
    .estado-resuelto { background: #d4edda; color: #155724; }
    .estado-aprobado { background: #d4edda; color: #155724; }

    .ultima-actualizacion {
      border-left: 4px solid #28a745;
      background: #f8fff8 !important;
    }

    /* Bot贸n para agregar actualizaci贸n */
    .btn-agregar-actualizacion {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
    }
    
    .btn-agregar-actualizacion:hover {
      background: #218838;
    }

    /* Bot贸n de login */
    #btnLogin {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 15px;
      background: #6a0a24;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      z-index: 1005;
      font-size: 14px;
    }

    #btnLogin:hover {
      background: #7c002a;
    }

    /* Indicador de sesi贸n */
    #sesionInfo {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      z-index: 1005;
      font-size: 14px;
      display: none;
    }

    @media (max-width:700px){
      h1 { font-size:30px; }
      h2 { font-size:16px; }
      .map-box > #map { width:94%; height:500px; }
      .menu-superior { gap:14px; padding:10px 0; }
      .menu-superior a { font-size:15px; padding: 6px 12px; }
      .thumb {
        width: 100px;
        height: 100px;
        margin: 5px;
      }
      /* BUSCADORES RESPONSIVE */
      #buscadorActualizaciones, #buscadorReportes, #filtroEstado {
        font-size: 14px;
        padding: 10px;
      }
      .actualizacion-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .actualizacion-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }
      #btnLogin, #sesionInfo {
        top: 10px;
        right: 10px;
        font-size: 12px;
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>

<h1>Centro de atenci贸n CESPT</h1>
<h2>Atenci贸n ciudadana: Quejas, ayudas y reportes</h2>

<!-- Bot贸n de login/sesi贸n -->
<button id="btnLogin">Acceso Administradores</button>
<div id="sesionInfo"></div>

<nav class="menu-superior">
  <a href="#actualizaciones" id="btnActualizaciones">Actualizaciones</a>
  <a href="#reportes" id="btnReportes">Reportes</a>
  <a href="#ayuda" id="btnAyuda">Ayuda</a>
</nav>

<!-- ===========================
     SECCIN ACTUALIZACIONES
=========================== -->
<section id="actualizaciones" class="seccion oculto">
  <h2 style="margin-top:0">Actualizaciones de Reportes</h2>

  <!-- BUSCADOR ACTUALIZACIONES -->
  <div style="margin-bottom: 20px;">
    <input type="text" id="buscadorActualizaciones" placeholder=" Buscar en actualizaciones..." 
           style="width: 100%; padding: 12px; border: 2px solid #7c002a; border-radius: 8px; font-size: 16px;">
  </div>

  <div id="contenidoActualizaciones">
    <!-- Las actualizaciones se cargar谩n din谩micamente aqu铆 -->
  </div>
</section>

<!-- ===========================
     SECCIN REPORTES (LISTA)
=========================== -->
<section id="reportes" class="seccion oculto">
  <h2>Reportes atendidos</h2>

  <!-- BUSCADOR REPORTES -->
  <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
    <input type="text" id="buscadorReportes" placeholder=" Buscar por calle, descripci贸n o estado..." 
           style="flex: 1; min-width: 250px; padding: 12px; border: 2px solid #7c002a; border-radius: 8px; font-size: 16px;">
    
    <select id="filtroEstado" style="padding: 12px; border: 2px solid #7c002a; border-radius: 8px; font-size: 16px; min-width: 180px;">
      <option value="todos">Todos los estados</option>
      <option value="pendiente">Pendiente</option>
      <option value="aprobado">Aprobado</option>
      <option value="resuelto">Resuelto</option>
    </select>
  </div>

  <div id="listaReportes"></div>
</section>

<!-- ===========================
     SECCIN AYUDA
=========================== -->
<section id="ayuda" class="seccion oculto">
  <h2>Ayuda y contacto</h2>

  <p>Si necesitas asistencia inmediata, puedes comunicarte a:</p>

  <ul>
    <li>Atenci贸n CESPT: <strong>664-928-4421</strong></li>
    <li>Reportes de agua: <strong>664-701-1129</strong></li>
    <li>Emergencias hidr谩ulicas: <strong>664-884-9033</strong></li>
  </ul>

  <p>Correos electr贸nicos de contacto:</p>

  <ul>
    <li>soporte@cespt-ayuda.com</li>
    <li>reportes@tij-cespt.org</li>
    <li>asistencia.usuarios@aguatj.net</li>
  </ul>

</section>

<!-- MAPA + UI -->
<div class="map-box">
  <div id="map"></div>
</div>

<button id="btnAgregarQueja">Agregar Queja</button>
<div id="overlay"></div>
<div id="mapMessage">Haz clic en el mapa para colocar tu queja</div>

<!-- Formulario para agregar queja -->
<div id="formContainer">
  <span id="closeForm">&times;</span>
  <h3>Nueva Queja</h3>
  <form id="formQueja">
    <label>Problema:</label>
    <input type="text" id="problema" placeholder="Ej. Fuga de agua" required>
    <label>Descripci贸n:</label>
    <textarea id="descripcion" rows="3" placeholder="Describe el problema..." required></textarea>
    <button type="submit">Enviar Queja</button>
  </form>
</div>

<!-- Formulario para agregar actualizaci贸n -->
<div id="formActualizacionContainer" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; border-radius:10px; width:360px; box-shadow:0 6px 18px rgba(0,0,0,.3); z-index:1003">
  <span id="closeFormActualizacion" style="position:absolute; top:8px; right:12px; cursor:pointer; font-weight:700; font-size:20px; color:#333;">&times;</span>
  <h3>Agregar Actualizaci贸n</h3>
  <form id="formActualizacion">
    <input type="hidden" id="reporteIdActualizacion">
    <label>Descripci贸n del avance:</label>
    <textarea id="descripcionActualizacion" rows="4" placeholder="Describe el avance del reporte..." required></textarea>
    <label>Estado:</label>
    <label>T茅cnico asignado:</label>
    <input type="text" id="tecnicoActualizacion" placeholder="Nombre del t茅cnico">
    <button type="submit" style="margin-top:15px;">Guardar Actualizaci贸n</button>
  </form>
</div>

<!-- Formulario de login -->
<div id="formLoginContainer" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; border-radius:10px; width:300px; box-shadow:0 6px 18px rgba(0,0,0,.3); z-index:1003">
  <span id="closeFormLogin" style="position:absolute; top:8px; right:12px; cursor:pointer; font-weight:700; font-size:20px; color:#333;">&times;</span>
  <h3>Acceso Administradores</h3>
  <form id="formLogin">
    <label>Usuario:</label>
    <input type="text" id="usuarioLogin" placeholder="Usuario" required>
    <label>Contrase帽a:</label>
    <input type="password" id="passwordLogin" placeholder="Contrase帽a" required>
    <button type="submit" style="margin-top:15px;">Iniciar Sesi贸n</button>
  </form>
</div>

<!-- VISTA DETALLE (se muestra cuando hay ?id=...) -->
<div id="detail">
  <h1>Detalle del Reporte</h1>
  <a class="back" id="backToMap" href="#">Volver al mapa</a>

  <div id="detailContent">
    <h2 id="detailStreet">Calle ...</h2>
    <div class="field"><strong>Descripci贸n:</strong> <span id="detailDescription"></span></div>
    <div class="field"><strong>D铆as transcurridos:</strong> <span id="detailDias">0</span> d铆as</div>
    <div class="field"><strong>Estado:</strong> <span id="detailEstado"></span></div>
    <div class="field"><strong>Fotos:</strong></div>
    <div id="detailPhotos"></div>
    <div class="field" style="margin-top:20px;">
      <button id="btnAgregarActualizacionDetalle" class="btn-agregar-actualizacion" style="display:none;">Agregar Actualizaci贸n</button>
    </div>
  </div>
</div>

<!-- Modal para ver fotos en grande -->
<div id="modal">
  <button id="closeModal">&times;</button>
  <img id="modalImg" src="" alt="Foto del reporte">
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-database-compat.js"></script>

<script>
/* ---------- Config Firebase --------- */
const firebaseConfig = {
  apiKey: "AIzaSyBKBEacMSzpEjh2Pd2zX-ij6EsDMxcb84M",
  authDomain: "mapa-de-quejas-e5354.firebaseapp.com",
  databaseURL: "https://mapa-de-quejas-e5354-default-rtdb.firebaseio.com",
  projectId: "mapa-de-quejas-e5354",
  storageBucket: "mapa-de-quejas-e5354.appspot.com",
  messagingSenderId: "1098104212670",
  appId: "1:1098104212670:web:fa91e20fb729dcd8be22ef",
  measurementId: "G-XJ015E8YWX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------- Sistema de Autenticaci贸n ---------- */
let usuarioAutenticado = false;
let mapa = null;
let marcadores = {};

const usuariosAutorizados = {
  "Ramon": "trebol",
  "Nicole": "jeje",
  "tecnico2": "tecnico456"
};

/* ---------- Variables globales para el estado del men煤 ---------- */
let seccionActual = null;

/* ---------- Helpers (reutilizables) ---------- */
function escapeHtml(str){
  if (str === null || str === undefined) return '';
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

function roundCoord(num){ return Math.round(Number(num) * 1000) / 1000; }

function createIcon(color) {
  return L.icon({
    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });
}

function getMarkerColor(count) {
  if (count >= 5) return 'red';
  if (count >= 3) return 'orange';
  return 'blue';
}

// Funci贸n para calcular d铆as transcurridos en UTC
function calcularDiasUTC(fechaCreacionMs) {
  const fechaCreacion = new Date(fechaCreacionMs);
  const hoy = new Date();

  const fechaCreacionUTC = Date.UTC(fechaCreacion.getUTCFullYear(), fechaCreacion.getUTCMonth(), fechaCreacion.getUTCDate());
  const hoyUTC = Date.UTC(hoy.getUTCFullYear(), hoy.getUTCMonth(), hoy.getUTCDate());

  const diffMs = hoyUTC - fechaCreacionUTC;
  const dias = Math.round(diffMs / (1000 * 60 * 60 * 24));
  return dias;
}

// Funci贸n mejorada: Determinar color y parpadeo basado en d铆as y agrupamiento
function determinarColorYParpadeo(dias, count) {
  let color = 'blue';
  let parpadeo = false;
  
  // Sistema de d铆as tiene prioridad
  if (dias >= 14) {
    color = 'red';
    parpadeo = true;
  } else if (dias >= 7) {
    color = 'orange';
  } else {
    // Si no cumple d铆as, usar sistema de agrupamiento
    color = getMarkerColor(count);
  }
  
  return { color, parpadeo };
}

// Funci贸n para mostrar fotos en modal
function mostrarImagen(src) {
  document.getElementById("modalImg").src = src;
  document.getElementById("modal").style.display = "flex";
}

// Cerrar modal al hacer clic en la X
document.getElementById("closeModal").addEventListener("click", function() {
  document.getElementById("modal").style.display = "none";
});

// Cerrar modal al hacer clic fuera de la imagen
document.getElementById("modal").addEventListener("click", function(e) {
  if (e.target.id === "modal") {
    document.getElementById("modal").style.display = "none";
  }
});

/* ---------- SISTEMA DE AUTENTICACIN ---------- */

function iniciarSesion(usuario, password) {
  if (usuariosAutorizados[usuario] && usuariosAutorizados[usuario] === password) {
    usuarioAutenticado = true;
    localStorage.setItem('cespt_usuario', usuario);
    actualizarInterfazAutenticacion();
    cerrarFormularioLogin();
    return true;
  }
  return false;
}

function cerrarSesion() {
  usuarioAutenticado = false;
  localStorage.removeItem('cespt_usuario');
  actualizarInterfazAutenticacion();
}

function verificarSesionGuardada() {
  const usuarioGuardado = localStorage.getItem('cespt_usuario');
  if (usuarioGuardado && usuariosAutorizados[usuarioGuardado]) {
    usuarioAutenticado = true;
    actualizarInterfazAutenticacion();
  }
}

function actualizarInterfazAutenticacion() {
  const btnLogin = document.getElementById('btnLogin');
  const sesionInfo = document.getElementById('sesionInfo');
  
  if (usuarioAutenticado) {
    const usuario = localStorage.getItem('cespt_usuario');
    btnLogin.style.display = 'none';
    sesionInfo.style.display = 'block';
    sesionInfo.innerHTML = `Conectado como: ${usuario} <button onclick="cerrarSesion()" style="margin-left:10px; background:#dc3545; color:white; border:none; border-radius:3px; padding:2px 6px; cursor:pointer;">Cerrar</button>`;
    
    // Mostrar botones de actualizaci贸n
    document.querySelectorAll('.btn-agregar-actualizacion').forEach(btn => {
      btn.style.display = 'inline-block';
    });
    
    // Actualizar popups del mapa
    actualizarPopupsMapa();
  } else {
    btnLogin.style.display = 'block';
    sesionInfo.style.display = 'none';
    
    // Ocultar botones de actualizaci贸n
    document.querySelectorAll('.btn-agregar-actualizacion').forEach(btn => {
      btn.style.display = 'none';
    });
    
    // Actualizar popups del mapa
    actualizarPopupsMapa();
  }
}

function actualizarPopupsMapa() {
  if (!mapa) return;
  
  Object.keys(marcadores).forEach(key => {
    const marker = marcadores[key];
    const popup = marker.getPopup();
    if (popup) {
      const content = popup.getContent();
      const newContent = content.replace(
        /<button class="btn-agregar-actualizacion".*?<\/button>/g, 
        usuarioAutenticado ? 
          `<button class="btn-agregar-actualizacion" onclick="abrirFormularioActualizacion('${key}')">Agregar Actualizaci贸n</button>` 
          : ''
      );
      marker.setPopupContent(newContent);
    }
  });
}

function abrirFormularioLogin() {
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('formLoginContainer').style.display = 'block';
}

function cerrarFormularioLogin() {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('formLoginContainer').style.display = 'none';
  document.getElementById('formLogin').reset();
}

// Event listeners para autenticaci贸n
document.getElementById('btnLogin').addEventListener('click', abrirFormularioLogin);
document.getElementById('closeFormLogin').addEventListener('click', cerrarFormularioLogin);

document.getElementById('formLogin').addEventListener('submit', function(e) {
  e.preventDefault();
  const usuario = document.getElementById('usuarioLogin').value;
  const password = document.getElementById('passwordLogin').value;
  
  if (iniciarSesion(usuario, password)) {
    alert('Inicio de sesi贸n exitoso');
  } else {
    alert('Usuario o contrase帽a incorrectos');
  }
});

/* ---------- SISTEMA DE ACTUALIZACIONES MEJORADO ---------- */

// CARGAR ACTUALIZACIONES DE REPORTES
function cargarActualizacionesReportes() {
  const contenedor = document.getElementById('contenidoActualizaciones');
  contenedor.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Cargando actualizaciones...</div>';

  db.ref('reportes').once('value').then(snapshot => {
    const reportesConActualizaciones = [];
    
    snapshot.forEach(child => {
      const data = child.val();
      if (!data) return;
      
      // Solo mostrar reportes que tienen actualizaciones
      if (data.actualizaciones && Object.keys(data.actualizaciones).length > 0) {
        reportesConActualizaciones.push({
          id: child.key,
          data: data
        });
      }
    });

    if (reportesConActualizaciones.length === 0) {
      contenedor.innerHTML = `
        <div class="sin-resultados">
          <div style="font-size: 48px; margin-bottom: 10px;"></div>
          <h3 style="color: #666; margin-bottom: 10px;">No hay actualizaciones disponibles</h3>
          <p>Los reportes aparecer谩n aqu铆 cuando tengan actualizaciones del equipo t茅cnico</p>
        </div>
      `;
      return;
    }

    // Ordenar reportes por fecha de 煤ltima actualizaci贸n (m谩s reciente primero)
    reportesConActualizaciones.sort((a, b) => {
      const ultimaActualizacionA = obtenerUltimaActualizacion(a.data.actualizaciones);
      const ultimaActualizacionB = obtenerUltimaActualizacion(b.data.actualizaciones);
      return (ultimaActualizacionB?.fecha || 0) - (ultimaActualizacionA?.fecha || 0);
    });

    mostrarActualizacionesEnLista(reportesConActualizaciones, contenedor);
    
  }).catch(err => {
    console.error('Error cargando actualizaciones:', err);
    contenedor.innerHTML = '<div class="sin-resultados"><p style="color:#666;">Error cargando actualizaciones.</p></div>';
  });
}

// FUNCIN PARA OBTENER LA LTIMA ACTUALIZACIN
function obtenerUltimaActualizacion(actualizaciones) {
  if (!actualizaciones) return null;
  
  const actualizacionesArray = Object.values(actualizaciones);
  if (actualizacionesArray.length === 0) return null;
  
  // Ordenar por fecha (m谩s reciente primero)
  actualizacionesArray.sort((a, b) => b.fecha - a.fecha);
  
  return actualizacionesArray[0];
}

// FUNCIN PARA MOSTRAR ACTUALIZACIONES EN LISTA
function mostrarActualizacionesEnLista(reportes, contenedor) {
  let html = '';
  
  reportes.forEach(reporte => {
    const data = reporte.data;
    const actualizacionesArray = Object.values(data.actualizaciones || {});
    
    // Ordenar actualizaciones por fecha (m谩s reciente primero)
    actualizacionesArray.sort((a, b) => b.fecha - a.fecha);
    
    const ultimaActualizacion = actualizacionesArray[0];
    const totalActualizaciones = actualizacionesArray.length;
    
    html += `
      <div class="actualizacion-item ${ultimaActualizacion ? 'ultima-actualizacion' : ''}">
        <div class="actualizacion-header">
          <div class="actualizacion-titulo">
             ${escapeHtml(data.street || 'Ubicaci贸n desconocida')}
          </div>
          <div class="actualizacion-fecha">
            ${new Date(ultimaActualizacion.fecha).toLocaleDateString('es-MX')}
          </div>
        </div>
        
        <div class="actualizacion-descripcion">
          <strong>Reporte original:</strong> ${escapeHtml(data.description || 'Sin descripci贸n')}
        </div>
        
        ${actualizacionesArray.map((actualizacion, index) => `
          <div style="
            margin-bottom: ${index < actualizacionesArray.length - 1 ? '10px' : '0'}; 
            padding: ${index === 0 ? '0' : '10px 0'};
            ${index > 0 ? 'border-top: 1px dashed #ddd;' : ''}
          ">
            <div style="font-weight: bold; color: #7c002a; margin-bottom: 5px;">
              Actualizaci贸n
            </div>
            <div style="color: #333; margin-bottom: 5px;">
              ${actualizacion.descripcion || 'Sin descripci贸n adicional'}
            </div>
            <div class="actualizacion-meta">
              <span>${new Date(actualizacion.fecha).toLocaleString('es-MX')}</span>
             
              ${actualizacion.tecnico ? `<span>T茅cnico: ${actualizacion.tecnico}</span>` : ''}
              ${actualizacion.usuario ? `<span>Por: ${actualizacion.usuario}</span>` : ''}
            </div>
          </div>
        `).join('')}
        
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
          <div class="actualizacion-meta">
            <span> ${totalActualizaciones} actualizacion${totalActualizaciones !== 1 ? 'es' : ''}</span>
            <a href="?id=${reporte.id}" style="color: #0056b3; text-decoration: underline;">
              Ver reporte completo
            </a>
          </div>
        </div>
      </div>
    `;
  });
  
  // Agregar contador
  const contador = document.createElement('div');
  contador.className = 'contador-resultados';
  contador.textContent = `${reportes.length} reportes con actualizaciones`;
  
  contenedor.innerHTML = '';
  contenedor.appendChild(contador);
  contenedor.insertAdjacentHTML('beforeend', html);
}

/* ---------- SISTEMA PARA AGREGAR ACTUALIZACIONES ---------- */

// Funci贸n para abrir el formulario de actualizaci贸n
function abrirFormularioActualizacion(reporteId) {
  if (!usuarioAutenticado) {
    alert('Solo el personal autorizado puede agregar actualizaciones. Por favor, inicie sesi贸n.');
    abrirFormularioLogin();
    return;
  }
  
  document.getElementById('reporteIdActualizacion').value = reporteId;
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('formActualizacionContainer').style.display = 'block';
}

// Funci贸n para cerrar el formulario de actualizaci贸n
function cerrarFormularioActualizacion() {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('formActualizacionContainer').style.display = 'none';
  document.getElementById('formActualizacion').reset();
}

// Funci贸n para guardar una actualizaci贸n
function guardarActualizacion(reporteId, descripcion, estado, tecnico) {
  if (!usuarioAutenticado) {
    alert('Error de autenticaci贸n. Por favor, inicie sesi贸n nuevamente.');
    return;
  }
  
  const nuevaActualizacion = {
    titulo: "Actualizaci贸n", // Siempre ser谩 "Actualizaci贸n"
    descripcion: descripcion,
    estado: estado,
    tecnico: tecnico || '',
    fecha: Date.now(),
    usuario: localStorage.getItem('cespt_usuario')
  };
  
  // Obtener referencia al reporte
  const reporteRef = db.ref('reportes/' + reporteId);
  
  // Obtener el reporte actual para actualizar el estado
  reporteRef.once('value').then(snapshot => {
    const reporte = snapshot.val();
    const actualizaciones = reporte.actualizaciones || {};
    
    // Agregar la nueva actualizaci贸n
    const nuevaKey = db.ref().child('actualizaciones').push().key;
    actualizaciones[nuevaKey] = nuevaActualizacion;
    
    // Actualizar el reporte con la nueva actualizaci贸n y el nuevo estado
    reporteRef.update({
      actualizaciones: actualizaciones,
      status: estado  // Actualizar el estado principal del reporte
    }).then(() => {
      alert('Actualizaci贸n guardada correctamente');
      cerrarFormularioActualizacion();
      
      // Recargar las actualizaciones si estamos en esa secci贸n
      if (seccionActual === 'actualizaciones') {
        cargarActualizacionesReportes();
      }
      
      // Actualizar el marcador en el mapa si existe
      if (marcadores[reporteId]) {
        actualizarMarcadorEnMapa(reporteId, estado);
      }
    }).catch(error => {
      console.error('Error al guardar la actualizaci贸n:', error);
      alert('Error al guardar la actualizaci贸n');
    });
  });
}

// Funci贸n para actualizar el marcador en el mapa
function actualizarMarcadorEnMapa(reporteId, nuevoEstado) {
  if (marcadores[reporteId] && mapa) {
    // Aqu铆 puedes cambiar el icono del marcador seg煤n el estado
    let color = 'blue';
    if (nuevoEstado === 'pendiente') color = 'blue';
    if (nuevoEstado === 'aprobado') color = 'orange';
    if (nuevoEstado === 'resuelto') color = 'green';
    
    const nuevoIcono = createIcon(color);
    marcadores[reporteId].setIcon(nuevoIcono);
  }
}

// Event listener para el formulario de actualizaci贸n
document.getElementById('formActualizacion').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const reporteId = document.getElementById('reporteIdActualizacion').value;
  const descripcion = document.getElementById('descripcionActualizacion').value;
  const estado = document.getElementById('estadoActualizacion').value;
  const tecnico = document.getElementById('tecnicoActualizacion').value;
  
  guardarActualizacion(reporteId, descripcion, estado, tecnico);
});

// Event listener para cerrar el formulario de actualizaci贸n
document.getElementById('closeFormActualizacion').addEventListener('click', cerrarFormularioActualizacion);

/* ---------- FUNCIONALIDAD DE BUSCADORES ---------- */

// BUSCADOR DE ACTUALIZACIONES
function inicializarBuscadorActualizaciones() {
  const buscador = document.getElementById('buscadorActualizaciones');
  
  buscador.addEventListener('input', function() {
    const textoBusqueda = this.value.toLowerCase().trim();
    const items = document.querySelectorAll('.actualizacion-item');
    let itemsVisibles = 0;
    
    items.forEach(item => {
      const textoCompleto = item.textContent.toLowerCase();
      const coincide = textoBusqueda === '' || textoCompleto.includes(textoBusqueda);
      
      if (coincide) {
        item.style.display = 'block';
        itemsVisibles++;
        
        // Resaltar texto coincidente
        resaltarTexto(item, textoBusqueda);
      } else {
        item.style.display = 'none';
      }
    });
    
    // Actualizar contador
    const contador = document.querySelector('#contenidoActualizaciones .contador-resultados');
    if (contador) {
      contador.textContent = `${itemsVisibles} reportes con actualizaciones encontrados`;
    }
    
    // Mostrar mensaje si no hay resultados
    if (itemsVisibles === 0 && textoBusqueda !== '') {
      const contenedor = document.getElementById('contenidoActualizaciones');
      const mensajeExistente = contenedor.querySelector('.sin-resultados');
      if (!mensajeExistente) {
        const mensaje = document.createElement('div');
        mensaje.className = 'sin-resultados';
        mensaje.innerHTML = `
          <div style="font-size: 48px; margin-bottom: 10px;"></div>
          <h3 style="color: #666; margin-bottom: 10px;">No se encontraron actualizaciones</h3>
          <p>Intenta con otros t茅rminos de b煤squeda</p>
        `;
        contenedor.appendChild(mensaje);
      }
    } else {
      const mensajeExistente = document.querySelector('#contenidoActualizaciones .sin-resultados');
      if (mensajeExistente) {
        mensajeExistente.remove();
      }
    }
  });
}

// BUSCADOR DE REPORTES
function inicializarBuscadorReportes() {
  const buscador = document.getElementById('buscadorReportes');
  const filtroEstado = document.getElementById('filtroEstado');
  
  function filtrarReportes() {
    const textoBusqueda = buscador.value.toLowerCase().trim();
    const estadoSeleccionado = filtroEstado.value;
    const tarjetas = document.querySelectorAll('.reporte-card');
    let tarjetasVisibles = 0;
    
    tarjetas.forEach(tarjeta => {
      const textoCompleto = tarjeta.textContent.toLowerCase();
      const estadoTarjeta = tarjeta.querySelector('.estado').textContent.toLowerCase();
      
      const coincideTexto = textoBusqueda === '' || textoCompleto.includes(textoBusqueda);
      const coincideEstado = estadoSeleccionado === 'todos' || estadoTarjeta === estadoSeleccionado;
      
      if (coincideTexto && coincideEstado) {
        tarjeta.style.display = 'block';
        tarjetasVisibles++;
        
        // Resaltar texto coincidente
        resaltarTexto(tarjeta, textoBusqueda);
      } else {
        tarjeta.style.display = 'none';
      }
    });
    
    // Mostrar mensaje si no hay resultados
    mostrarMensajeSinResultados('reportes', tarjetasVisibles);
  }
  
  buscador.addEventListener('input', filtrarReportes);
  filtroEstado.addEventListener('change', filtrarReportes);
}

// FUNCIN PARA RESALTAR TEXTO
function resaltarTexto(elemento, textoBusqueda) {
  if (!textoBusqueda) return;
  
  const elementosTexto = elemento.querySelectorAll('h3, .descripcion, .fecha, p, .actualizacion-titulo, .actualizacion-descripcion');
  elementosTexto.forEach(el => {
    const textoOriginal = el.textContent;
    const regex = new RegExp(`(${textoBusqueda})`, 'gi');
    const textoResaltado = textoOriginal.replace(regex, '<mark style="background: #ffeb3b; padding: 2px 4px; border-radius: 3px;">$1</mark>');
    el.innerHTML = textoResaltado;
  });
}

// FUNCIN PARA MOSTRAR MENSAJES SIN RESULTADOS
function mostrarMensajeSinResultados(seccion, cantidadVisibles) {
  let contenedor, tipo;
  
  if (seccion === 'actualizaciones') {
    contenedor = document.getElementById('contenidoActualizaciones');
    tipo = 'actualizaciones';
  } else {
    contenedor = document.getElementById('listaReportes');
    tipo = 'reportes';
  }
  
  // Remover mensaje anterior si existe
  const mensajeAnterior = contenedor.querySelector('.sin-resultados');
  if (mensajeAnterior) {
    mensajeAnterior.remove();
  }
  
  // Remover contador anterior si existe
  const contadorAnterior = contenedor.querySelector('.contador-resultados');
  if (contadorAnterior) {
    contadorAnterior.remove();
  }
  
  // Agregar contador de resultados
  const contador = document.createElement('div');
  contador.className = 'contador-resultados';
  contador.textContent = `${cantidadVisibles} ${tipo} encontrados`;
  if (contenedor.firstChild) {
    contenedor.insertBefore(contador, contenedor.firstChild);
  } else {
    contenedor.appendChild(contador);
  }
  
  // Mostrar mensaje si no hay resultados
  if (cantidadVisibles === 0) {
    const mensaje = document.createElement('div');
    mensaje.className = 'sin-resultados';
    mensaje.innerHTML = `
      <div style="font-size: 48px; margin-bottom: 10px;"></div>
      <h3 style="color: #666; margin-bottom: 10px;">No se encontraron ${tipo}</h3>
      <p>Intenta con otros t茅rminos de b煤squeda</p>
    `;
    contenedor.appendChild(mensaje);
  }
}

/* ---------- FUNCIN PARA MANEJAR EL MEN ---------- */
function toggleSeccion(seccionId) {
  const seccion = document.getElementById(seccionId);
  const boton = document.getElementById(`btn${seccionId.charAt(0).toUpperCase() + seccionId.slice(1)}`);
  
  // Si ya est谩 activa, la cerramos
  if (seccionActual === seccionId) {
    seccion.style.display = 'none';
    boton.classList.remove('activo');
    seccionActual = null;
    return;
  }
  
  // Cerramos la secci贸n actual si existe
  if (seccionActual) {
    document.getElementById(seccionActual).style.display = 'none';
    document.getElementById(`btn${seccionActual.charAt(0).toUpperCase() + seccionActual.slice(1)}`).classList.remove('activo');
  }
  
  // Abrimos la nueva secci贸n
  seccion.style.display = 'block';
  boton.classList.add('activo');
  seccionActual = seccionId;
  
  // Scroll suave hacia la secci贸n
  window.scrollTo({top: seccion.offsetTop - 20, behavior: 'smooth'});
  
  // INICIALIZAR BUSCADORES AL ABRIR SECCIN
  if (seccionId === 'reportes') {
    cargarListaReportes();
    // Peque帽o delay para asegurar que las tarjetas se cargaron
    setTimeout(() => {
      inicializarBuscadorReportes();
    }, 100);
  } else if (seccionId === 'actualizaciones') {
    cargarActualizacionesReportes();
    // Peque帽o delay para asegurar que las actualizaciones se cargaron
    setTimeout(() => {
      inicializarBuscadorActualizaciones();
    }, 100);
  }
}

/* ---------- RUTEO: si hay ?id=abc mostramos detalle ---------- */
const urlParams = new URLSearchParams(window.location.search);
const detailId = urlParams.get('id');
const detailEl = document.getElementById('detail');

if (detailId) {
  // mostrar detalle (oculta mapa y UI)
  document.querySelector('.map-box').style.display = 'none';
  document.getElementById('btnAgregarQueja').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('formContainer').style.display = 'none';
  document.getElementById('mapMessage').style.display = 'none';
  detailEl.style.display = 'block';
  mostrarDetalle(detailId);
} else {
  detailEl.style.display = 'none';
  initMap();
}

/* ---------- FUNCIN mostrarDetalle(id) ---------- */
function mostrarDetalle(id){
  const ref = db.ref('reportes/' + id);
  ref.once('value').then(snap => {
    const data = snap.val();
    if (!data) {
      document.getElementById('detailContent').innerHTML = '<p>Reporte no encontrado.</p>';
      return;
    }
    
    const street = data.street || 'Calle desconocida, Tijuana';
    const description = data.description || '';
    const estado = data.status || '';
    
    // CLCULO DE DAS MEJORADO
    const fechaCreacionMs = data.fechaCreacion ? (data.fechaCreacion.toMillis ? data.fechaCreacion.toMillis() : data.fechaCreacion) : Date.now();
    const diasPasados = calcularDiasUTC(fechaCreacionMs);

    document.getElementById('detailStreet').textContent = street;
    document.getElementById('detailDescription').textContent = description;
    document.getElementById('detailDias').textContent = `${diasPasados} d铆as`;
    document.getElementById('detailEstado').textContent = estado;

    const photosContainer = document.getElementById('detailPhotos');
    photosContainer.innerHTML = '';

    // AGREGAR FOTOS CON SISTEMA DE MODAL
    if (data.foto) {
      if (Array.isArray(data.foto)) {
        // M煤ltiples fotos
        data.foto.forEach(f => {
          const img = document.createElement('img');
          img.src = `Fotos/${f}`;
          img.className = 'thumb';
          img.onclick = () => mostrarImagen(`Fotos/${f}`);
          photosContainer.appendChild(img);
        });
      } else {
        // Una sola foto
        const img = document.createElement('img');
        img.src = `Fotos/${data.foto}`;
        img.className = 'thumb';
        img.onclick = () => mostrarImagen(`Fotos/${data.foto}`);
        photosContainer.appendChild(img);
      }
    } else if (data.photo) {
      // Compatibilidad con campo "photo"
      const img = document.createElement('img');
      img.src = data.photo;
      img.className = 'thumb';
      img.onclick = () => mostrarImagen(data.photo);
      photosContainer.appendChild(img);
    } else {
      photosContainer.innerHTML = '<div style="color:#666">No hay fotos disponibles para este reporte</div>';
    }
  }).catch(err => {
    document.getElementById('detailContent').innerHTML = '<p>Error cargando el reporte.</p>';
    console.error(err);
  });

  document.getElementById('backToMap').addEventListener('click', (e) => {
    e.preventDefault();
    window.location.href = window.location.pathname;
  });
  
  // Mostrar/ocultar bot贸n de actualizaci贸n seg煤n autenticaci贸n
  const btnActualizacion = document.getElementById('btnAgregarActualizacionDetalle');
  if (usuarioAutenticado) {
    btnActualizacion.style.display = 'inline-block';
    btnActualizacion.onclick = () => abrirFormularioActualizacion(detailId);
  } else {
    btnActualizacion.style.display = 'none';
  }
}

/* ---------- FUNCIONES MAPA (cuando no hay ?id) ---------- */
function initMap(){
  mapa = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '漏 OpenStreetMap contributors' }).addTo(mapa);

  fetch("https://nominatim.openstreetmap.org/search?city=Tijuana&format=json")
    .then(r => r.json())
    .then(data => {
      if (data.length > 0) mapa.setView([parseFloat(data[0].lat), parseFloat(data[0].lon)], 12);
      else mapa.setView([32.533, -117.033], 12);
    })
    .catch(()=> mapa.setView([32.533, -117.033], 12));

  function addMarker(lat, lng, key, street, descripcion = '', rawData = {}, count = 1){
    // CLCULO DE DAS MEJORADO
    const fechaCreacionMs = rawData.fechaCreacion ? (rawData.fechaCreacion.toMillis ? rawData.fechaCreacion.toMillis() : rawData.fechaCreacion) : Date.now();
    const diasPasados = calcularDiasUTC(fechaCreacionMs);
    
    // SISTEMA COMBINADO: d铆as + agrupamiento
    const { color, parpadeo } = determinarColorYParpadeo(diasPasados, count);
    const icon = createIcon(color);
    
    const marker = L.marker([lat, lng], { icon }).addTo(mapa);
    
    // Guardar referencia al marcador
    marcadores[key] = marker;
    
    const streetEsc = escapeHtml(street || 'Calle desconocida, Tijuana');
    const descEsc = escapeHtml(descripcion || '');

    const popupHtml = `
      <div style="font-weight:700;margin-bottom:6px">Reporte en:</div>
      <div style="font-weight:700">${streetEsc}</div>
      <div style="margin-top:8px"><strong>Descripci贸n:</strong> ${descEsc}</div>
      <div style="margin-top:8px"><strong>D铆as transcurridos:</strong> ${diasPasados} d铆as</div>
      <div style="margin-top:8px"><strong>Reportes cercanos:</strong> ${count}</div>
      <div style="margin-top:8px" class="popup-link"><a href="?id=${key}">Ver m谩s</a></div>
      ${usuarioAutenticado ? `
        <div style="margin-top:8px">
          <button class="btn-agregar-actualizacion" onclick="abrirFormularioActualizacion('${key}')">Agregar Actualizaci贸n</button>
        </div>
      ` : ''}
    `;

    marker.bindPopup(popupHtml);

    // EFECTO DE PARPADEO
    if (parpadeo) {
      let visible = true;
      const intervalo = setInterval(() => {
        if (mapa.hasLayer(marker)) {
          marker.setIcon(createIcon(visible ? 'red' : 'grey'));
          visible = !visible;
        } else {
          clearInterval(intervalo);
        }
      }, 500);
    }

    // doble click para eliminar (solo para pruebas)
    marker.on('dblclick', () => {
      if (confirm('驴Eliminar este reporte?')) {
        mapa.removeLayer(marker);
        db.ref('reportes/' + key).remove();
        delete marcadores[key];
      }
    });

    return marker;
  }

  // CARGAR TODOS los reportes para mostrarlos en el mapa (aprobados + pendientes)
  db.ref('reportes').once('value').then(snapshot => {
    const reportCount = {}; // para agrupar por coordenadas
    snapshot.forEach(child => {
      const data = child.val();
      if (!data) return;
      // agrupar por coord redondeada (incluso si faltan lat/lng salta)
      if (data.lat == null || data.lng == null) return;
      const keyCoords = `${roundCoord(data.lat)},${roundCoord(data.lng)}`;
      if (!reportCount[keyCoords]) reportCount[keyCoords] = 0;
      reportCount[keyCoords]++;
    });

    snapshot.forEach(child => {
      const data = child.val();
      if (!data) return;
      if (data.lat == null || data.lng == null) return;
      const key = child.key;
      const keyCoords = `${roundCoord(data.lat)},${roundCoord(data.lng)}`;
      const count = reportCount[keyCoords] || 0;
      
      // Usar la funci贸n addMarker que aplica colores y parpadeo correctamente
      addMarker(data.lat, data.lng, key, data.street || 'Calle desconocida, Tijuana', 
                data.description || '', data, count);
    });
  }).catch(err => console.error(err));

  /* ---------- CARGAR LISTA DE REPORTES (solo 'aprobado') ---------- */
  function cargarListaReportes() {
    const listaContainer = document.getElementById('listaReportes');
    db.ref('reportes').once('value').then(snapshot => {
      listaContainer.innerHTML = '';
      const items = [];
      snapshot.forEach(child => {
        const data = child.val();
        if (!data) return;
        items.push({ id: child.key, val: data });
      });

      if (items.length === 0) {
        listaContainer.innerHTML = '<div class="sin-resultados"><p style="color:#666;">No hay reportes aprobados actualmente.</p></div>';
        return;
      }

      // mostrar cada uno
      items.forEach(item => {
        const data = item.val;
        
        // C谩lculo de d铆as mejorado
        const fechaCreacionMs = data.fechaCreacion ? (data.fechaCreacion.toMillis ? data.fechaCreacion.toMillis() : data.fechaCreacion) : Date.now();
        const diasPasados = calcularDiasUTC(fechaCreacionMs);
        
        const card = document.createElement('div');
        card.className = 'reporte-card';
        
        // Determinar clase de estado CORREGIDO
        let estadoClass = 'estado-pendiente';
        if (data.status === 'aprobado') {
          estadoClass = 'estado-aprobado';
        } else if (data.status === 'resuelto') {
          estadoClass = 'estado-resuelto';
        }
        
        card.innerHTML = `
          <h3>${escapeHtml(data.street || 'Ubicaci贸n desconocida')}</h3>
          <div class="fecha">Reportado hace ${diasPasados} d铆as</div>
          <div class="descripcion">${escapeHtml(data.description || 'Sin descripci贸n')}</div>
          <span class="estado ${estadoClass}">${data.status || 'pendiente'}</span>
          <div style="margin-top:10px;">
            <a href="?id=${item.id}" style="color:#0056b3; text-decoration:underline;">Ver detalles completos</a>
            ${usuarioAutenticado ? `
              <button class="btn-agregar-actualizacion" onclick="abrirFormularioActualizacion('${item.id}')" style="margin-left:10px;">Agregar Actualizaci贸n</button>
            ` : ''}
          </div>
        `;
        listaContainer.appendChild(card);
      });

      // INICIALIZAR BUSCADOR DESPUS DE CARGAR
      inicializarBuscadorReportes();
      
    }).catch(err => {
      listaContainer.innerHTML = '<div class="sin-resultados"><p style="color:#666;">Error cargando reportes.</p></div>';
      console.error(err);
    });
  }

  // Cargar lista inicial de reportes
  cargarListaReportes();

  /* ---------- UI form y creaci贸n de reportes ---------- */
  const overlay = document.getElementById('overlay');
  const formContainer = document.getElementById('formContainer');
  const closeForm = document.getElementById('closeForm');
  const formQueja = document.getElementById('formQueja');
  const btnAgregar = document.getElementById('btnAgregarQueja');
  const mapMessage = document.getElementById('mapMessage');

  btnAgregar.addEventListener('click', () => { overlay.style.display='block'; formContainer.style.display='block'; });
  closeForm.addEventListener('click', () => { overlay.style.display='none'; formContainer.style.display='none'; });

  let colocarMarcadorActivo = false;
  formQueja.addEventListener('submit', (e) => {
    e.preventDefault();
    overlay.style.display='none';
    formContainer.style.display='none';
    mapMessage.style.display='block';
    colocarMarcadorActivo = true;
  });

  mapa.on('click', function(ev){
    if (!colocarMarcadorActivo) return;
    colocarMarcadorActivo = false;
    mapMessage.style.display='none';

    const { lat, lng } = ev.latlng;
    const problema = document.getElementById('problema').value;
    const descripcion = document.getElementById('descripcion').value;

    // abrir nueva pesta帽a primero para evitar bloqueos m贸viles
    const nuevaPesta帽a = window.open('', '_blank');

    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`)
      .then(res => res.json())
      .then(data => {
        const street = data.address?.road || 'Calle desconocida';
        const city = data.address?.city || data.address?.town || data.address?.village || 'Tijuana';
        const fullStreet = `${street}, ${city}`;

        // Guardar en Firebase con timestamp
        const newRef = db.ref('reportes').push();
        newRef.set({
          lat, lng,
          street: fullStreet,
          description: `${problema}: ${descripcion}`,
          status: 'pendiente',
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          fechaCreacion: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
          nuevaPesta帽a.location.href = "https://docs.google.com/forms/d/e/1FAIpQLScrEq6KDExGBKtzYpbWZeuWsUzy2gKC61hTQ3p8L_8DLPChVw/viewform";
          // Recargar lista de reportes despu茅s de agregar uno nuevo
          cargarListaReportes();
        }).catch(err => {
          console.error(err);
          nuevaPesta帽a.location.href = "https://docs.google.com/forms/d/e/1FAIpQLScrEq6KDExGBKtzYpbWZeuWsUzy2gKC61hTQ3p8L_8DLPChVw/viewform";
        });
      })
      .catch(() => {
        const newRef = db.ref('reportes').push();
        newRef.set({
          lat, lng,
          street: "Calle desconocida, Tijuana",
          description: `${problema}: ${descripcion}`,
          status: 'pendiente',
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          fechaCreacion: firebase.database.ServerValue.TIMESTAMP
        });
        nuevaPesta帽a.location.href = "https://docs.google.com/forms/d/e/1FAIpQLScrEq6KDExGBKtzYpbWZeuWsUzy2gKC61hTQ3p8L_8DLPChVw/viewform";
        // Recargar lista de reportes despu茅s de agregar uno nuevo
        cargarListaReportes();
      });
  });

  // soporte t谩ctil
  mapa.on('touchend', function(ev){
    if(!colocarMarcadorActivo) return;
    const touch = ev.originalEvent.changedTouches ? ev.originalEvent.changedTouches[0] : null;
    if(!touch) return;
    const point = mapa.mouseEventToLatLng(touch);
    mapa.fire('click', { latlng: point });
  });

} // fin initMap

/* ---------- Event listeners para el men煤 ---------- */
document.getElementById("btnActualizaciones").addEventListener("click", (e) => {
  e.preventDefault();
  toggleSeccion('actualizaciones');
});

document.getElementById("btnReportes").addEventListener("click", (e) => {
  e.preventDefault();
  toggleSeccion('reportes');
});

document.getElementById("btnAyuda").addEventListener("click", (e) => {
  e.preventDefault();
  toggleSeccion('ayuda');
});

// INICIALIZAR SISTEMA DE AUTENTICACIN AL CARGAR
document.addEventListener('DOMContentLoaded', function() {
  verificarSesionGuardada();
  actualizarInterfazAutenticacion();
  
  // Inicializar buscadores est谩ticos si existen
  if (document.getElementById('buscadorActualizaciones')) {
    inicializarBuscadorActualizaciones();
  }
});
</script>
</body>
</html>